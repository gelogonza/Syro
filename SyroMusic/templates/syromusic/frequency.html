{% extends 'base.html' %}

{% block title %}The Frequency - Discover Music {% endblock title %}

{% block extra_css %}
<style>
  /* Premium Frequency Styling */
  .frequency-container {
    max-width: 1200px;
    margin: 0 auto;
  }

  .frequency-title {
    font-size: 3.5rem;
    font-weight: 900;
    margin-bottom: 12px;
    background: linear-gradient(135deg, #a78bfa 0%, #ec4899 50%, #f97316 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -0.02em;
  }

  .frequency-subtitle {
    font-size: 1.1rem;
    color: rgba(255, 255, 255, 0.6);
    margin-bottom: 40px;
  }

  /* Orb Canvas Premium */
  #orbCanvas {
    filter: drop-shadow(0 20px 40px rgba(0, 0, 0, 0.4));
  }

  /* Control Sections */
  .control-section {
    background: rgba(26, 26, 46, 0.6);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 16px;
    padding: 24px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .control-section:hover {
    border-color: rgba(255, 255, 255, 0.12);
    background: rgba(26, 26, 46, 0.8);
  }

  .control-label {
    font-size: 1.125rem;
    font-weight: 600;
    margin-bottom: 16px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: rgba(255, 255, 255, 0.9);
  }

  /* Genre Buttons */
  .genre-btn {
    transition: all 0.2s ease;
    font-size: 0.875rem;
  }

  .genre-btn:hover {
    transform: translateY(-2px);
    border-color: rgba(167, 139, 250, 0.6);
    color: #a78bfa;
  }

  .genre-btn.active {
    background: linear-gradient(135deg, #a78bfa 0%, #ec4899 100%);
    border-color: #a78bfa;
    color: #0a0a0a;
    font-weight: 600;
  }

  /* Color Swatch */
  .color-swatch {
    transition: all 0.2s ease;
    cursor: pointer;
    border-radius: 12px;
  }

  .color-swatch:hover {
    transform: scale(1.05);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
  }

  .color-swatch.active {
    border-color: #ffffff !important;
    box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
  }

  /* Find Vibe Button */
  .find-vibe-btn {
    background: linear-gradient(135deg, #a78bfa 0%, #ec4899 50%, #f97316 100%);
    color: #0a0a0a;
    font-size: 1.125rem;
    font-weight: 700;
    padding: 16px 32px;
    border-radius: 12px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .find-vibe-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 32px rgba(167, 139, 250, 0.4);
  }

  .find-vibe-btn:active {
    transform: translateY(0);
  }

  /* Discovery Result Section */
  .discovery-card {
    background: rgba(26, 26, 46, 0.6);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 16px;
    padding: 32px;
    animation: slide-in 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  @keyframes slide-in {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Stats Bars */
  .discovery-stat-bar {
    height: 6px;
    border-radius: 3px;
    background: rgba(255, 255, 255, 0.1);
    overflow: hidden;
  }

  .discovery-stat-fill {
    height: 100%;
    background: linear-gradient(90deg, #a78bfa 0%, #ec4899 100%);
    border-radius: 3px;
    transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Album Art */
  .discovery-album-art {
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 16px 48px rgba(0, 0, 0, 0.5);
    animation: scale-in 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  @keyframes scale-in {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  /* Action Buttons */
  .discovery-btn {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-weight: 600;
    border-radius: 12px;
  }

  .discovery-btn.primary {
    background: linear-gradient(135deg, #a78bfa 0%, #ec4899 100%);
    color: #0a0a0a;
  }

  .discovery-btn.primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(167, 139, 250, 0.4);
  }

  .discovery-btn.secondary {
    border: 2px solid #a78bfa;
    color: #a78bfa;
    background: transparent;
  }

  .discovery-btn.secondary:hover {
    background: rgba(167, 139, 250, 0.1);
  }

  /* Loading State */
  .loading-spinner {
    animation: spin 2s linear infinite;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  /* Notification Styles */
  .notification {
    animation: notify-slide 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  @keyframes notify-slide {
    from {
      opacity: 0;
      transform: translateX(400px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }
</style>
{% endblock extra_css %}

{% block content %}
<div class="frequency-container">
  <div class="mb-12">
    <h1 class="frequency-title">The Frequency</h1>
    <p class="frequency-subtitle">I want to listen to <span id="selectedGenreDisplay" class="text-primary font-semibold">[Genre]</span> that sounds like <span id="selectedColorDisplay" class="text-primary font-semibold">[Color]</span></p>
  </div>

<div class="grid lg:grid-cols-2 gap-8">
  <!-- Left: 3D Orb Visualization -->
  <div class="glass rounded-2xl p-8 border border-primary/20 h-96 flex items-center justify-center">
    <canvas id="orbCanvas" width="400" height="400" class="w-full h-full max-w-sm"></canvas>
  </div>

  <!-- Right: Controls and Selection -->
  <div class="space-y-6">
    <!-- Genre Selector -->
    <div class="control-section">
      <label class="control-label">Choose Genre</label>
      <div class="space-y-2 max-h-64 overflow-y-auto">
        <input type="text" id="genreSearch" placeholder="Search genres..."
               class="w-full px-4 py-2 bg-background/50 border border-border rounded-lg text-white placeholder-muted-foreground focus:outline-none focus:ring-2 focus:ring-purple-500 mb-4">
        <div id="genreList" class="grid grid-cols-2 gap-2">
          <!-- Genre buttons will be populated here -->
        </div>
      </div>
    </div>

    <!-- Color Mood Selector -->
    <div class="control-section">
      <label class="control-label">Choose Mood Color</label>
      <div id="colorGrid" class="grid grid-cols-4 gap-3">
        <!-- Color swatches will be populated here -->
      </div>
      <div class="mt-4 p-4 rounded-lg bg-background/50 border border-border text-center">
        <p class="text-sm text-muted-foreground mb-2">Selected Color</p>
        <div id="selectedColorPreview" class="w-full h-12 rounded-lg bg-gradient-to-r from-primary to-accent shadow-lg"></div>
      </div>
    </div>

    <!-- Randomize Button -->
    <button onclick="randomizeDiscovery()" class="find-vibe-btn w-full">
      <span class="iconify h-6 w-6 mr-2 inline" data-icon="mdi:dice-multiple"></span>
      Find My Vibe
    </button>
  </div>
</div>

<!-- Discovery Result -->
<div id="resultSection" class="hidden mt-12">
  <div class="discovery-card">
    <h2 class="text-3xl font-bold mb-8">Your Discovery</h2>

    <div class="grid md:grid-cols-2 gap-8">
      <!-- Track Card -->
      <div class="flex flex-col">
        <div class="aspect-square mb-6 discovery-album-art">
          <img id="resultTrackImage" src="" alt="Album Art" class="w-full h-full object-cover">
        </div>
        <h3 class="text-2xl font-bold mb-2" id="resultTrackName">Track Name</h3>
        <p class="text-muted-foreground mb-4" id="resultTrackArtist">Artist Name</p>

        <div class="flex gap-3 mb-6">
          <button onclick="playDiscoveredTrack()" class="discovery-btn primary flex-1 px-6 py-3">
            <span class="iconify h-5 w-5 mr-2 inline" data-icon="mdi:play"></span>
            Play Now
          </button>
          <button onclick="saveToQueue()" class="discovery-btn secondary flex-1 px-6 py-3">
            <span class="iconify h-5 w-5 mr-2 inline" data-icon="mdi:playlist-plus"></span>
            Add Queue
          </button>
        </div>

        <!-- Preview Player -->
        <audio id="previewPlayer" controls class="w-full rounded-lg">
          Your browser does not support the audio element.
        </audio>
      </div>

      <!-- Track Details -->
      <div class="space-y-6">
        <!-- Vibe Description -->
        <div class="bg-background/30 rounded-lg p-6">
          <p class="text-muted-foreground italic mb-4" id="vibeDescription">
            A pop track that sounds like something fresh
          </p>
        </div>

        <!-- Audio Features -->
        <div>
          <h4 class="text-lg font-semibold mb-4">Track Vibe Profile</h4>
          <div class="space-y-4">
            <div>
              <div class="flex justify-between mb-2">
                <span class="text-muted-foreground">Energy</span>
                <span class="text-white font-semibold" id="resultEnergy">0.0</span>
              </div>
              <div class="discovery-stat-bar">
                <div class="discovery-stat-fill" id="energyBar" style="width: 0%;"></div>
              </div>
            </div>
            <div>
              <div class="flex justify-between mb-2">
                <span class="text-muted-foreground">Danceability</span>
                <span class="text-white font-semibold" id="resultDance">0.0</span>
              </div>
              <div class="discovery-stat-bar">
                <div class="discovery-stat-fill" id="danceBar" style="width: 0%;"></div>
              </div>
            </div>
            <div>
              <div class="flex justify-between mb-2">
                <span class="text-muted-foreground">Mood (Valence)</span>
                <span class="text-white font-semibold" id="resultMood">0.0</span>
              </div>
              <div class="discovery-stat-bar">
                <div class="discovery-stat-fill" id="moodBar" style="width: 0%;"></div>
              </div>
            </div>
            <div>
              <div class="flex justify-between mb-2">
                <span class="text-muted-foreground">Acousticness</span>
                <span class="text-white font-semibold" id="resultAcoustic">0.0</span>
              </div>
              <div class="discovery-stat-bar">
                <div class="discovery-stat-fill" id="acousticBar" style="width: 0%;"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Track Info -->
        <div class="bg-background/30 rounded-lg p-4 space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-muted-foreground">Album</span>
            <span class="text-white font-semibold" id="resultAlbum">—</span>
          </div>
          <div class="flex justify-between">
            <span class="text-muted-foreground">Genre</span>
            <span class="text-white font-semibold capitalize" id="resultGenre">—</span>
          </div>
          <div class="flex justify-between">
            <span class="text-muted-foreground">Mood</span>
            <span class="text-white font-semibold" id="resultColor">—</span>
          </div>
        </div>

        <!-- Spotify Link -->
        <a id="spotifyLink" href="#" target="_blank" class="block w-full px-6 py-3 rounded-lg border-2 border-primary text-primary font-semibold text-center hover:bg-primary/10 transition-all">
          <span class="iconify h-5 w-5 mr-2 inline" data-icon="mdi:spotify"></span>
          Listen on Spotify
        </a>
      </div>
    </div>
  </div>

  <!-- More Discoveries -->
  <div class="mt-8 text-center">
    <button onclick="randomizeDiscovery()"
            class="px-8 py-3 rounded-lg bg-secondary border-2 border-primary text-primary font-semibold hover:bg-primary/10 transition-all">
      <span class="iconify h-5 w-5 mr-2 inline" data-icon="mdi:refresh"></span>
      Find Another
    </button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
  // Global state
  let selectedGenre = null;
  let selectedColor = '#ff6b9d';
  let scene, camera, renderer, orb;
  let discoveredTrack = null;
  let colorPalette = [
    '#ff6b9d', '#ff8e72', '#ffa94d', '#ffd93d',
    '#6bcf7f', '#4ecdc4', '#45b7d1', '#5a67d8',
    '#a78bfa', '#f687b3', '#fb7185', '#fd6b61'
  ];

  // Initialize 3D Orb
  function initializeOrb() {
    const canvas = document.getElementById('orbCanvas');
    const width = canvas.clientWidth;
    const height = canvas.clientHeight;

    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x1a1a2e);

    camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
    camera.position.z = 3;

    renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
    renderer.setSize(width, height);
    renderer.setPixelRatio(window.devicePixelRatio);

    // Create Orb (Icosahedron geometry)
    const geometry = new THREE.IcosahedronGeometry(1, 4);
    const material = new THREE.MeshPhongMaterial({
      color: 0xff6b9d,
      emissive: 0xff6b9d,
      wireframe: false,
      shininess: 100
    });
    orb = new THREE.Mesh(geometry, material);
    scene.add(orb);

    // Lighting
    const light1 = new THREE.PointLight(0xffffff, 1);
    light1.position.set(5, 5, 5);
    scene.add(light1);

    const light2 = new THREE.PointLight(0xff6b9d, 0.5);
    light2.position.set(-5, -5, 5);
    scene.add(light2);

    const ambientLight = new THREE.AmbientLight(0xffffff, 0.3);
    scene.add(ambientLight);

    // Animation loop
    function animate() {
      requestAnimationFrame(animate);
      orb.rotation.x += 0.002;
      orb.rotation.y += 0.003;
      renderer.render(scene, camera);
    }
    animate();
  }

  // Update Orb Color
  function updateOrbColor(hexColor) {
    if (orb && orb.material) {
      const color = new THREE.Color(hexColor);
      orb.material.color.copy(color);
      orb.material.emissive.copy(color);
    }
  }

  // Initialize Genres
  async function initializeGenres() {
    try {
      const response = await fetch('/music/api/genre-seeds/');
      if (response.ok) {
        const data = await response.json();
        const genres = data.data || [];
        displayGenres(genres);
      }
    } catch (error) {
      console.error('Error loading genres:', error);
    }
  }

  function displayGenres(genres) {
    const genreList = document.getElementById('genreList');
    genreList.innerHTML = genres.map(genre => `
      <button onclick="selectGenre('${genre}')"
              class="genre-btn px-4 py-2 rounded-lg bg-background/50 border border-border text-muted-foreground">
        ${genre}
      </button>
    `).join('');

    // Genre search
    document.getElementById('genreSearch').addEventListener('input', function(e) {
      const query = e.target.value.toLowerCase();
      const buttons = genreList.querySelectorAll('button');
      buttons.forEach(btn => {
        btn.style.display = btn.textContent.toLowerCase().includes(query) ? '' : 'none';
      });
    });
  }

  function selectGenre(genre) {
    selectedGenre = genre;
    document.getElementById('selectedGenreDisplay').textContent = genre;

    // Update button states
    document.querySelectorAll('#genreList button').forEach(btn => {
      if (btn.textContent === genre) {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
    });
  }

  // Initialize Color Palette
  function initializeColorPalette() {
    const colorGrid = document.getElementById('colorGrid');
    colorGrid.innerHTML = colorPalette.map(color => `
      <button onclick="selectColor('${color}')"
              class="color-swatch w-full h-16 border-2 border-transparent shadow-lg"
              style="background-color: ${color};"
              data-color="${color}"
              title="${color}"></button>
    `).join('');

    // Select first color by default
    updateColorDisplay();
  }

  function selectColor(color) {
    selectedColor = color;
    updateColorDisplay();
  }

  function updateColorDisplay() {
    document.getElementById('selectedColorDisplay').textContent = selectedColor;
    document.getElementById('selectedColorPreview').style.backgroundColor = selectedColor;

    // Update button states
    document.querySelectorAll('#colorGrid button').forEach(btn => {
      btn.classList.remove('active');
      // Check if this button's data-color matches selected color
      if (btn.dataset.color && btn.dataset.color.toLowerCase() === selectedColor.toLowerCase()) {
        btn.classList.add('active');
      }
    });

    updateOrbColor(selectedColor);
  }

  // Randomize Discovery
  async function randomizeDiscovery() {
    if (!selectedGenre) {
      showNotification('Please select a genre first', 'error');
      return;
    }

    try {
      showNotification('Finding your vibe...', 'success');

      const params = new URLSearchParams({
        genre: selectedGenre,
        color: selectedColor
      });

      const response = await fetch(`/music/api/frequency-randomizer/?${params}`);
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Discovery failed');
      }

      const data = await response.json();
      displayDiscovery(data.data);
      showNotification('Found your next favorite!', 'success');

    } catch (error) {
      console.error('Discovery error:', error);
      showNotification(error.message || 'Failed to discover music', 'error');
    }
  }

  function displayDiscovery(data) {
    const track = data.track;
    discoveredTrack = track;

    document.getElementById('resultTrackImage').src = track.image || '';
    document.getElementById('resultTrackName').textContent = track.name;
    document.getElementById('resultTrackArtist').textContent = track.artist;
    document.getElementById('resultAlbum').textContent = track.album;
    document.getElementById('resultGenre').textContent = data.genre;
    document.getElementById('resultColor').textContent = data.color;

    // Generate smart vibe description
    const features = track.audio_features || {};
    const smartVibe = generateVibeDescription(
      data.genre,
      features.energy || 0.5,
      features.valence || 0.5,
      features.danceability || 0.5
    );
    document.getElementById('vibeDescription').textContent = smartVibe;
    document.getElementById('spotifyLink').href = track.external_urls || '#';
    const energy = features.energy || 0;
    const dance = features.danceability || 0;
    const mood = features.valence || 0;
    const acoustic = features.acousticness || 0;

    document.getElementById('resultEnergy').textContent = energy.toFixed(2);
    document.getElementById('resultDance').textContent = dance.toFixed(2);
    document.getElementById('resultMood').textContent = mood.toFixed(2);
    document.getElementById('resultAcoustic').textContent = acoustic.toFixed(2);

    document.getElementById('energyBar').style.width = `${energy * 100}%`;
    document.getElementById('danceBar').style.width = `${dance * 100}%`;
    document.getElementById('moodBar').style.width = `${mood * 100}%`;
    document.getElementById('acousticBar').style.width = `${acoustic * 100}%`;

    // Preview
    if (track.preview_url) {
      document.getElementById('previewPlayer').src = track.preview_url;
    }

    document.getElementById('resultSection').classList.remove('hidden');
  }

  async function playDiscoveredTrack() {
    if (!discoveredTrack) return;

    try {
      const response = await fetch('/music/api/playback/play/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
          uris: [discoveredTrack.uri]
        })
      });

      if (response.ok) {
        showNotification(`Now playing: ${discoveredTrack.name}`, 'success');
        setTimeout(() => {
          window.location.href = '/music/player/';
        }, 1000);
      } else {
        showNotification('Failed to play track', 'error');
      }
    } catch (error) {
      console.error('Play error:', error);
      showNotification('Failed to play track', 'error');
    }
  }

  async function saveToQueue() {
    if (!discoveredTrack) return;

    try {
      const response = await fetch('/music/api/playback/queue/add/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
          track_uri: discoveredTrack.uri
        })
      });

      if (response.ok) {
        showNotification(`Added to queue: ${discoveredTrack.name}`, 'success');
      } else {
        showNotification('Failed to add to queue', 'error');
      }
    } catch (error) {
      console.error('Queue error:', error);
      showNotification('Failed to add to queue', 'error');
    }
  }

  function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `notification fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg transition-all transform translate-x-0 ${
      type === 'success' ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white font-semibold' : 'bg-red-500 text-white'
    }`;
    notification.innerHTML = `
      <div class="flex items-center gap-2">
        <span class="iconify h-5 w-5" data-icon="${type === 'success' ? 'mdi:check-circle' : 'mdi:alert-circle'}"></span>
        <span>${message}</span>
      </div>
    `;
    document.body.appendChild(notification);

    setTimeout(() => {
      notification.style.transform = 'translateX(400px)';
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }

  // Generate smart vibe description based on genre and audio features
  function generateVibeDescription(genre, energy, valence, danceability) {
    const descriptions = {
      'pop': [
        'Pop perfection with infectious energy',
        'A feel-good pop anthem ready to dominate your playlist',
        'Fresh pop vibes that capture the zeitgeist'
      ],
      'rock': [
        'Powerful rock that demands attention',
        'A rock track with attitude and grit',
        'Rock energy that hits hard'
      ],
      'hip-hop': [
        'Hip-hop heat with lyrical flow',
        'A rap track with undeniable swagger',
        'Hip-hop energy that moves the crowd'
      ],
      'electronic': [
        'Synth-driven electronic bliss',
        'Electronica that pulses with energy',
        'Digital soundscape with hypnotic rhythms'
      ],
      'indie': [
        'Indie authenticity and artistic vision',
        'A gem from the indie underground',
        'Indie sensibilities with universal appeal'
      ],
      'rnb': [
        'Smooth R&B grooves and soulful vocals',
        'R&B rhythm with silky production',
        'Soulful R&B that glides through speakers'
      ]
    };

    let baseDesc = '';
    const genreLower = genre.toLowerCase();
    const matchingDesc = descriptions[genreLower];

    if (matchingDesc) {
      baseDesc = matchingDesc[Math.floor(Math.random() * matchingDesc.length)];
    } else {
      const energyDesc = energy > 0.7 ? 'energetic' : energy > 0.4 ? 'balanced' : 'laid-back';
      const moodDesc = valence > 0.6 ? 'uplifting' : valence > 0.4 ? 'neutral' : 'moody';
      baseDesc = `A ${energyDesc} ${moodDesc} track in the ${genre} genre`;
    }

    // Add color interpretation
    if (selectedColor) {
      const colorMood = getColorMood(selectedColor);
      baseDesc += ` that matches your ${colorMood} vibe.`;
    } else {
      baseDesc += '.';
    }

    return baseDesc;
  }

  function getColorMood(hexColor) {
    try {
      const r = parseInt(hexColor.slice(1, 3), 16);
      const g = parseInt(hexColor.slice(3, 5), 16);
      const b = parseInt(hexColor.slice(5, 7), 16);

      const hsl = rgbToHsl(r, g, b);

      if (hsl.l > 70) return 'bright and optimistic';
      if (hsl.l < 30) return 'dark and mysterious';
      if (hsl.s < 30) return 'neutral and balanced';

      if (hsl.h < 30) return 'warm and energetic';
      if (hsl.h < 60) return 'vibrant and happy';
      if (hsl.h < 120) return 'fresh and cool';
      if (hsl.h < 270) return 'calm and serene';
      if (hsl.h < 330) return 'deep and introspective';
      return 'passionate and bold';
    } catch (e) {
      return 'unique';
    }
  }

  function rgbToHsl(r, g, b) {
    r /= 255;
    g /= 255;
    b /= 255;

    const max = Math.max(r, g, b);
    const min = Math.min(r, g, b);
    let h, s, l = (max + min) / 2;

    if (max === min) {
      h = s = 0;
    } else {
      const d = max - min;
      s = l > 0.5 ? d / (2 - max - min) : d / (max + min);

      switch (max) {
        case r:
          h = ((g - b) / d + (g < b ? 6 : 0)) / 6;
          break;
        case g:
          h = ((b - r) / d + 2) / 6;
          break;
        case b:
          h = ((r - g) / d + 4) / 6;
          break;
      }
    }

    return {
      h: Math.round(h * 360),
      s: Math.round(s * 100),
      l: Math.round(l * 100)
    };
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', function() {
    initializeOrb();
    initializeGenres();
    initializeColorPalette();

    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
  });

  // Handle window resize
  window.addEventListener('resize', () => {
    const canvas = document.getElementById('orbCanvas');
    const width = canvas.clientWidth;
    const height = canvas.clientHeight;
    camera.aspect = width / height;
    camera.updateProjectionMatrix();
    renderer.setSize(width, height);
  });
</script>
{% endblock content %}
