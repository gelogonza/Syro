{% extends 'base.html' %}
{% load static %}

{% block title %}Music Player - Syro{% endblock title %}

{% block extra_css %}
<style>
  /* Hide Spotify Web Playback SDK Modal and Now Playing Widget */
  iframe[src*="spotify"],
  div[class*="spotify"],
  div[id*="spotify-player"],
  div[class*="now-playing"],
  div[id*="now-playing"],
  div[class*="now_playing"],
  div[id*="now_playing"],
  div[data-testid*="now-playing"],
  div[class*="spotify-widget"],
  div[id*="spotify-widget"],
  body > div[style*="position: fixed"][style*="z-index"],
  body > iframe {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    pointer-events: none !important;
  }

  /* Dark Theme Override for Player Page */
  body {
    background: #0a0a0a !important;
    color: #ffffff !important;
  }

  body::before {
    display: none;
  }

  /* Breathing Gradient Mesh Animation */
  @keyframes breathing {
    0%, 100% {
      opacity: 0.85;
      transform: scale(1.2);
    }
    25% {
      opacity: 0.9;
      transform: scale(1.22);
    }
    50% {
      opacity: 0.95;
      transform: scale(1.25);
    }
    75% {
      opacity: 0.9;
      transform: scale(1.22);
    }
  }

  @keyframes gradient-shift {
    0% {
      background-position: 0% 50%;
    }
    50% {
      background-position: 100% 50%;
    }
    100% {
      background-position: 0% 50%;
    }
  }

  /* Dynamic Background Container */
  .dynamic-bg-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
    overflow: hidden;
  }

  .dynamic-bg {
    position: absolute;
    width: 100%;
    height: 100%;
    background:
      radial-gradient(ellipse 1200px 800px at 20% 30%, rgba(16, 185, 129, 0.15) 0%, transparent 40%),
      radial-gradient(ellipse 1000px 900px at 80% 70%, rgba(59, 130, 246, 0.1) 0%, transparent 40%),
      linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
    background-size: 200% 200%;
    background-position: 0% 50%;
    transition: background 4s cubic-bezier(0.4, 0.0, 0.2, 1);
    filter: blur(120px);
    opacity: 0.85;
    transform: scale(1.2);
    animation: breathing 8s ease-in-out infinite;
  }

  .dynamic-bg-overlay {
    position: absolute;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle at 50% 50%, transparent 0%, rgba(0,0,0,0.4) 100%);
    z-index: 1;
  }

  /* Grain Overlay - Analog/Archival Feel */
  .dynamic-bg-overlay::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image:
      url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' result='noise'/%3E%3C/filter%3E%3Crect width='400' height='400' fill='rgba(0,0,0,0.03)' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
    background-size: 200px 200px;
    opacity: 0.5;
    pointer-events: none;
    mix-blend-mode: overlay;
    z-index: 2;
  }

  /* Content wrapper to sit above dynamic background */
  .content-wrapper {
    position: relative;
    z-index: 10;
  }

  /* Vinyl Record Styles */
  .vinyl-container {
    position: relative;
    width: 360px;
    height: 360px;
    margin: 0 auto;
  }

  .vinyl-record {
    position: relative;
    width: 360px;
    height: 360px;
    border-radius: 50%;
    background: radial-gradient(circle at 35% 35%, #2a2a2a 0%, #1a1a1a 40%, #0a0a0a 100%);
    box-shadow:
      0 0 0 8px #0a0a0a,
      0 20px 60px rgba(0,0,0,0.8),
      inset 0 0 30px rgba(0,0,0,0.5);
    animation: spin 4s linear infinite paused;
    transform-origin: center;
  }

  .vinyl-record.playing {
    animation-play-state: running;
  }

  /* Vinyl grooves effect */
  .vinyl-grooves {
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: repeating-radial-gradient(
      circle at center,
      transparent 0px,
      transparent 2px,
      rgba(255,255,255,0.02) 2px,
      rgba(255,255,255,0.02) 4px
    );
    pointer-events: none;
  }

  /* Center label with album art */
  .vinyl-label {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 200px;
    height: 200px;
    border-radius: 50%;
    overflow: hidden;
    box-shadow:
      0 0 0 4px #1a1a1a,
      0 0 0 8px #0a0a0a,
      0 8px 24px rgba(0,0,0,0.6);
    background: #1a1a1a;
  }

  .vinyl-label img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Center hole */
  .vinyl-hole {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: radial-gradient(circle, #0a0a0a 0%, #1a1a1a 50%, #0a0a0a 100%);
    box-shadow:
      inset 0 2px 8px rgba(0,0,0,0.8),
      0 0 0 2px #2a2a2a;
    z-index: 10;
  }

  @keyframes spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }

  /* Player Card */
  .player-card {
    background: rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(40px) saturate(180%);
    -webkit-backdrop-filter: blur(40px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 24px;
    box-shadow:
      0 8px 32px rgba(0, 0, 0, 0.3),
      0 0 0 1px rgba(255, 255, 255, 0.03),
      inset 0 1px 0 rgba(255, 255, 255, 0.05);
  }

  .player-card:hover {
    background: rgba(0, 0, 0, 0.35);
    border-color: rgba(255, 255, 255, 0.12);
  }

  /* Track Info */
  /* Premium Typography */
  .track-name {
    font-size: 2.8rem;
    font-weight: 900;
    line-height: 1.15;
    letter-spacing: -0.03em;
    margin-bottom: 0.75rem;
    background: linear-gradient(135deg, #ffffff 0%, #d4d4d8 50%, #a0a0a0 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-shadow: 0 0 40px rgba(16, 185, 129, 0.1);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
  }

  .artist-name {
    font-size: 1.35rem;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.75);
    margin-bottom: 0.5rem;
    letter-spacing: -0.01em;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
  }

  .album-name {
    font-size: 1.05rem;
    font-weight: 500;
    color: rgba(255, 255, 255, 0.55);
    letter-spacing: 0.01em;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
  }

  /* Premium Progress Bar */
  .progress-container {
    position: relative;
    width: 100%;
    height: 6px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    cursor: pointer;
    overflow: hidden;
    transition: height 0.2s ease;
  }

  .progress-container:hover {
    height: 10px;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #10b981 0%, #22c55e 100%);
    border-radius: 4px;
    transition: width 0.1s linear;
    box-shadow: 0 0 12px rgba(16, 185, 129, 0.4);
  }

  .time-display {
    font-size: 0.875rem;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.6);
    font-variant-numeric: tabular-nums;
  }

  /* Control Buttons */
  /* Premium Stereo Button Styling */
  .control-btn {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0.05) 100%);
    border: 1px solid rgba(255, 255, 255, 0.25);
    color: #ffffff;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter: blur(10px) saturate(120%);
    position: relative;
    overflow: hidden;
    font-weight: 500;
  }

  .control-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.2) 0%, transparent 70%);
    transition: left 0.3s ease;
    z-index: -1;
  }

  .control-btn:hover {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.18) 0%, rgba(255, 255, 255, 0.08) 100%);
    border-color: rgba(255, 255, 255, 0.35);
    transform: scale(1.08) translateY(-2px);
    box-shadow: 0 8px 24px rgba(16, 185, 129, 0.25);
  }

  .control-btn:active {
    transform: scale(0.95);
  }

  .control-btn.active {
    background: linear-gradient(135deg, #10b981 0%, #22c55e 100%);
    border-color: rgba(255, 255, 255, 0.2);
    box-shadow: 0 8px 28px rgba(16, 185, 129, 0.6);
  }

  .control-btn-lg {
    width: 72px;
    height: 72px;
    background: linear-gradient(135deg, #10b981 0%, #22c55e 100%);
    border: none;
    box-shadow: 0 12px 40px rgba(16, 185, 129, 0.5);
    position: relative;
    z-index: 1;
  }

  .control-btn-lg::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
    pointer-events: none;
  }

  .control-btn-lg:hover {
    background: linear-gradient(135deg, #22c55e 0%, #10b981 100%);
    transform: scale(1.12) translateY(-4px);
    box-shadow: 0 16px 48px rgba(16, 185, 129, 0.7);
  }

  .control-btn-lg:active {
    transform: scale(0.96);
  }

  /* Volume Slider */
  .volume-slider {
    -webkit-appearance: none;
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background: rgba(255, 255, 255, 0.1);
    outline: none;
    transition: all 0.2s ease;
  }

  .volume-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: linear-gradient(135deg, #10b981 0%, #22c55e 100%);
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
    transition: all 0.2s ease;
  }

  .volume-slider::-webkit-slider-thumb:hover {
    transform: scale(1.2);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.6);
  }

  .volume-slider::-moz-range-thumb {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: linear-gradient(135deg, #10b981 0%, #22c55e 100%);
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
  }

  /* Device Panel */
  .device-item {
    padding: 0.875rem 1rem;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.08);
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
  }

  .device-item:hover {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(16, 185, 129, 0.5);
    transform: translateX(4px);
  }

  .device-item.active {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(34, 197, 94, 0.15) 100%);
    border-color: #10b981;
    color: #10b981;
  }

  /* Search Section */
  .search-input {
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 0.875rem 1rem;
    color: #ffffff;
    font-weight: 500;
    transition: all 0.2s ease;
    backdrop-filter: blur(10px);
  }

  .search-input:focus {
    outline: none;
    background: rgba(255, 255, 255, 0.08);
    border-color: #10b981;
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
  }

  .search-input::placeholder {
    color: rgba(255, 255, 255, 0.4);
  }

  .search-result-item {
    padding: 0.875rem 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.03);
    transition: all 0.2s ease;
    cursor: pointer;
    backdrop-filter: blur(10px);
  }

  .search-result-item:hover {
    background: rgba(255, 255, 255, 0.05);
  }

  .search-result-item:last-child {
    border-bottom: none;
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .vinyl-container {
      width: 300px;
      height: 300px;
    }

    .vinyl-record {
      width: 300px;
      height: 300px;
    }

    .vinyl-label {
      width: 160px;
      height: 160px;
    }

    .track-name {
      font-size: 2rem;
    }
  }

  @media (max-width: 640px) {
    .vinyl-container {
      width: 260px;
      height: 260px;
    }

    .vinyl-record {
      width: 260px;
      height: 260px;
    }

    .vinyl-label {
      width: 140px;
      height: 140px;
    }

    .track-name {
      font-size: 1.75rem;
    }

    .artist-name {
      font-size: 1rem;
    }

    .control-btn {
      width: 48px;
      height: 48px;
    }

    .control-btn-lg {
      width: 64px;
      height: 64px;
    }
  }

  /* Scrollbar for dark theme */
  ::-webkit-scrollbar {
    width: 12px;
    height: 12px;
  }

  ::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
  }

  ::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 6px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.3);
  }
</style>
{% endblock extra_css %}

{% block content %}
<!-- Dynamic Background -->
<div class="dynamic-bg-container">
  <div class="dynamic-bg" id="dynamicBg"></div>
  <div class="dynamic-bg-overlay"></div>
</div>

<!-- Content Wrapper -->
<div class="content-wrapper">
  <!-- Search Section -->
  <div class="max-w-7xl mx-auto mb-8">
    <div class="player-card p-6">
      <h2 class="text-xl font-bold mb-4 text-white">Search & Play</h2>
      <input
        type="text"
        id="playerSearchInput"
        placeholder="Search for a song, artist, or album..."
        class="search-input w-full mb-4"
        autocomplete="off"
      />
      <div id="playerSearchResults" class="max-h-80 overflow-y-auto rounded-lg"></div>
    </div>
  </div>

  <!-- Main Player Layout -->
  <div class="max-w-7xl mx-auto">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Left: Vinyl Record -->
      <div class="lg:col-span-2">
        <div class="player-card p-8 lg:p-12">
          <!-- Vinyl Record -->
          <div class="mb-8 lg:mb-12">
            <div class="vinyl-container">
              <div class="vinyl-record {% if now_playing and now_playing.is_playing %}playing{% endif %}" id="vinylRecord">
                <div class="vinyl-grooves"></div>
                <div class="vinyl-label">
                  {% if now_playing and now_playing.album_image_url %}
                    <img
                      src="{{ now_playing.album_image_url }}"
                      alt="Album Art"
                      id="albumArt"
                      crossorigin="anonymous"
                    />
                  {% else %}
                    <div class="w-full h-full bg-gray-800 flex items-center justify-center">
                      <span class="iconify text-6xl text-gray-600" data-icon="mdi:music"></span>
                    </div>
                  {% endif %}
                </div>
                <div class="vinyl-hole"></div>
              </div>
            </div>
          </div>

          <!-- Track Info -->
          {% if now_playing and now_playing.track_name %}
          <div class="text-center mb-8">
            <h1 class="track-name" id="trackName">{{ now_playing.track_name }}</h1>
            <p class="artist-name" id="artistName">{{ now_playing.artist_name }}</p>
            {% if now_playing.album_name %}
              <p class="album-name" id="albumNameDisplay">{{ now_playing.album_name }}</p>
            {% endif %}
          </div>
          {% endif %}

          <!-- Progress Bar -->
          <div class="mb-6">
            <div class="progress-container mb-2" id="progressBar">
              <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <div class="flex justify-between time-display">
              <span id="currentTime">0:00</span>
              <span id="duration">0:00</span>
            </div>
          </div>

          <!-- Playback Controls -->
          <div class="flex items-center justify-center gap-4 mb-8">
            <button class="control-btn" id="shuffleBtn" title="Shuffle" onclick="toggleShuffle()">
              <span class="iconify text-xl" data-icon="mdi:shuffle-variant"></span>
            </button>
            <button class="control-btn" onclick="previousTrack()" title="Previous">
              <span class="iconify text-2xl" data-icon="mdi:skip-previous"></span>
            </button>
            <button class="control-btn control-btn-lg" id="playPauseBtn" onclick="togglePlayPause()" title="Play/Pause">
              {% if now_playing and now_playing.is_playing %}
                <span class="iconify text-3xl" data-icon="mdi:pause"></span>
              {% else %}
                <span class="iconify text-3xl" data-icon="mdi:play"></span>
              {% endif %}
            </button>
            <button class="control-btn" onclick="nextTrack()" title="Next">
              <span class="iconify text-2xl" data-icon="mdi:skip-next"></span>
            </button>
            <button class="control-btn" id="repeatBtn" title="Repeat" onclick="toggleRepeat()">
              <span class="iconify text-xl" data-icon="mdi:repeat"></span>
            </button>
          </div>

          <!-- Volume Control -->
          <div class="flex items-center gap-4">
            <span class="iconify text-xl text-white" data-icon="mdi:volume-high"></span>
            <input
              type="range"
              id="volumeSlider"
              class="volume-slider flex-1"
              min="0"
              max="100"
              value="100"
              onchange="setVolume(this.value)"
            />
            <span class="text-sm font-semibold text-white w-12 text-right" id="volumeValue">100%</span>
          </div>
        </div>
      </div>

      <!-- Right: Devices & Queue -->
      <div class="lg:col-span-1 space-y-6">
        <!-- Devices -->
        <div class="player-card p-6">
          <h2 class="text-lg font-bold mb-4 text-white flex items-center">
            <span class="iconify mr-2" data-icon="mdi:devices"></span>
            Available Devices
          </h2>
          <div class="space-y-2" id="deviceList">
            {% if devices %}
              {% for device in devices %}
                <div
                  class="device-item {% if device.is_active %}active{% endif %}"
                  data-device-id="{{ device.id }}"
                  onclick="transferPlayback('{{ device.id }}')"
                >
                  <div class="flex items-center justify-between">
                    <div class="flex items-center">
                      <span class="iconify mr-2" data-icon="
                        {% if device.type == 'Computer' %}mdi:laptop
                        {% elif device.type == 'Smartphone' %}mdi:cellphone
                        {% elif device.type == 'Speaker' %}mdi:speaker
                        {% else %}mdi:devices{% endif %}
                      "></span>
                      <span>{{ device.name }}</span>
                    </div>
                    {% if device.is_active %}
                      <span class="iconify text-green-400" data-icon="mdi:check-circle"></span>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <p class="text-center text-gray-500 py-4">No devices available</p>
            {% endif %}
          </div>
        </div>

        <!-- Queue Info -->
        <div class="player-card p-6">
          <h2 class="text-lg font-bold mb-4 text-white flex items-center">
            <span class="iconify mr-2" data-icon="mdi:playlist-music"></span>
            Queue
          </h2>
          <div id="queueContainer">
            {% if queue and queue.queue_tracks %}
              <p class="text-gray-400 text-sm">{{ queue.queue_tracks|length }} tracks in queue</p>
            {% else %}
              <p class="text-center text-gray-500 py-4">Queue is empty</p>
            {% endif %}
          </div>
        </div>

        <!-- Navigation -->
        <div class="player-card p-6">
          <h2 class="text-lg font-bold mb-4 text-white">Quick Links</h2>
          <div class="space-y-2">
            <a
              href="{% url 'music:dashboard' %}"
              class="device-item block text-center"
            >
              <span class="iconify mr-2" data-icon="mdi:view-dashboard"></span>
              Dashboard
            </a>
            <a
              href="{% url 'music:stats_dashboard' %}"
              class="device-item block text-center"
            >
              <span class="iconify mr-2" data-icon="mdi:chart-bar"></span>
              Stats
            </a>
            <a
              href="{% url 'music:search' %}"
              class="device-item block text-center"
            >
              <span class="iconify mr-2" data-icon="mdi:magnify"></span>
              Search
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Artist Detail Modal -->
<div id="artistModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 1000; align-items: center; justify-content: center; padding: 2rem;">
  <div style="background: linear-gradient(135deg, rgba(10, 10, 10, 0.95) 0%, rgba(26, 26, 26, 0.95) 100%); border: 1px solid rgba(255, 107, 157, 0.3); border-radius: 16px; max-width: 500px; width: 100%; max-height: 80vh; overflow-y: auto; padding: 2rem; position: relative;">
    <!-- Close Button -->
    <button onclick="closeArtistModal()" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: #ff6b9d; font-size: 1.5rem; cursor: pointer; z-index: 1001;">
      ✕
    </button>

    <!-- Artist Image -->
    <img id="artistModalImage" style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; margin: 0 auto 1.5rem; display: block; border: 2px solid rgba(255, 107, 157, 0.5);" alt="Artist">

    <!-- Artist Name -->
    <h2 id="artistModalTitle" style="font-size: 1.75rem; font-weight: 900; color: white; margin-bottom: 2rem; text-align: center; background: linear-gradient(135deg, #ff6b9d, #45b7d1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"></h2>

    <!-- Modal Content -->
    <div id="artistModalContent" style="color: white; line-height: 1.6;"></div>
  </div>
</div>

<script>
  // ==================== Utility Functions ====================

  function getCsrfToken() {
    const name = 'csrftoken';
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function formatTime(ms) {
    const seconds = Math.floor((ms / 1000) % 60);
    const minutes = Math.floor((ms / 1000 / 60) % 60);
    return `${minutes}:${seconds.toString().padStart(2, '0')}`;
  }

  function escapeHtml(text) {
    const map = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
  }

  function escapeSingleQuotes(text) {
    return text.replace(/'/g, "\\'");
  }

  // Artist Modal Functions
  function openArtistModal(artistName, artistImage) {
    const modal = document.getElementById('artistModal');
    if (!modal) return;

    const modalTitle = document.getElementById('artistModalTitle');
    const modalImage = document.getElementById('artistModalImage');
    const modalContent = document.getElementById('artistModalContent');

    modalTitle.textContent = artistName;
    if (artistImage && artistImage.trim()) {
      modalImage.src = artistImage;
      modalImage.style.display = 'block';
    } else {
      modalImage.style.display = 'none';
    }

    // Placeholder content - in a real implementation, would fetch from backend
    modalContent.innerHTML = `
      <div class="space-y-6">
        <div>
          <h3 class="text-lg font-semibold text-white mb-3">About</h3>
          <p class="text-gray-300">Discover music from ${escapeHtml(artistName)}.</p>
        </div>
        <div>
          <h3 class="text-lg font-semibold text-white mb-3">Top Songs</h3>
          <p class="text-gray-400 text-sm">Search for this artist in the search bar to view their top songs.</p>
        </div>
        <div>
          <h3 class="text-lg font-semibold text-white mb-3">Albums</h3>
          <p class="text-gray-400 text-sm">Browse their albums using the main navigation or search.</p>
        </div>
      </div>
    `;

    modal.style.display = 'flex';
  }

  function closeArtistModal() {
    const modal = document.getElementById('artistModal');
    if (modal) {
      modal.style.display = 'none';
    }
  }

  // Close modal when clicking outside of it
  window.addEventListener('click', function(event) {
    const modal = document.getElementById('artistModal');
    if (event.target === modal) {
      modal.style.display = 'none';
    }
  });

  // ==================== Color Extraction ====================

  function extractDominantColor(img) {
    /**
     * Extracts the single most dominant color from an image.
     * This color represents the most prevalent hue/tone in the image.
     */
    try {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      canvas.width = 150;
      canvas.height = 150;
      ctx.drawImage(img, 0, 0, 150, 150);

      const imageData = ctx.getImageData(0, 0, 150, 150).data;
      const colorMap = {};

      // Quantize colors to reduce noise (group similar colors together)
      for (let i = 0; i < imageData.length; i += 4) {
        const r = Math.floor(imageData[i] / 25) * 25;      // 25 = step size (0-255 becomes 0-10 buckets)
        const g = Math.floor(imageData[i + 1] / 25) * 25;
        const b = Math.floor(imageData[i + 2] / 25) * 25;
        const key = `${r},${g},${b}`;
        colorMap[key] = (colorMap[key] || 0) + 1;
      }

      // Find the single most frequent color
      let dominantColor = 'rgb(26, 26, 46)';  // fallback
      let maxCount = 0;

      for (const [color, count] of Object.entries(colorMap)) {
        if (count > maxCount) {
          const [r, g, b] = color.split(',').map(Number);
          const brightness = (r * 299 + g * 587 + b * 114) / 1000;

          // Only accept colors that are not too dark (< 20) or too bright (> 240)
          if (brightness > 20 && brightness < 240) {
            maxCount = count;
            dominantColor = `rgb(${r}, ${g}, ${b})`;
          }
        }
      }

      return dominantColor;
    } catch (error) {
      console.error('Color extraction error:', error);
      return 'rgb(26, 26, 46)';
    }
  }

  function extractDominantColors(img, numColors = 3) {
    /**
     * Extracts multiple dominant colors for gradient variations.
     * Returns: [dominantColor, accentColor1, accentColor2]
     */
    try {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      canvas.width = 100;
      canvas.height = 100;
      ctx.drawImage(img, 0, 0, 100, 100);
      const imageData = ctx.getImageData(0, 0, 100, 100).data;

      const colorMap = {};
      for (let i = 0; i < imageData.length; i += 4) {
        const r = Math.floor(imageData[i] / 32) * 32;
        const g = Math.floor(imageData[i + 1] / 32) * 32;
        const b = Math.floor(imageData[i + 2] / 32) * 32;
        const key = `${r},${g},${b}`;
        colorMap[key] = (colorMap[key] || 0) + 1;
      }

      const sortedColors = Object.entries(colorMap)
        .sort((a, b) => b[1] - a[1])
        .slice(0, numColors * 4)
        .filter(([color]) => {
          const [r, g, b] = color.split(',').map(Number);
          const brightness = (r * 299 + g * 587 + b * 114) / 1000;
          const saturation = Math.max(r, g, b) - Math.min(r, g, b);
          return brightness > 15 && brightness < 220 && saturation > 10;
        })
        .slice(0, numColors)
        .map(([color]) => {
          const [r, g, b] = color.split(',').map(Number);
          return `rgb(${r}, ${g}, ${b})`;
        });

      return sortedColors.length > 0 ? sortedColors : ['rgb(26, 26, 46)', 'rgb(22, 33, 62)', 'rgb(15, 52, 96)'];
    } catch (error) {
      console.error('Color extraction error:', error);
      return ['rgb(26, 26, 46)', 'rgb(22, 33, 62)', 'rgb(15, 52, 96)'];
    }
  }

  function applyDynamicBackground() {
    const albumArt = document.getElementById('albumArt');
    const dynamicBg = document.getElementById('dynamicBg');

    if (!albumArt || !dynamicBg) return;

    const updateBackground = () => {
      // Get the single dominant color (most prevalent in the image)
      const dominantColor = extractDominantColor(albumArt);

      // Get accent colors for variation
      const accentColors = extractDominantColors(albumArt, 3);

      // Use dominant color as the primary background color
      // This makes the background match the cover's primary hue almost perfectly
      const gradient = `
        radial-gradient(circle at 20% 80%, ${dominantColor} 0%, ${accentColors[1] || dominantColor} 40%, transparent 70%),
        radial-gradient(circle at 80% 20%, ${accentColors[1] || dominantColor} 0%, transparent 50%),
        linear-gradient(135deg, ${dominantColor} 0%, ${accentColors[0] || dominantColor} 50%, ${accentColors[2] || dominantColor} 100%)
      `;

      dynamicBg.style.background = gradient;
      dynamicBg.style.backgroundColor = dominantColor;  // Fallback solid color

      console.log('Dynamic background:', {
        dominant: dominantColor,
        accents: accentColors
      });
    };

    if (albumArt.complete) {
      updateBackground();
    } else {
      albumArt.onload = updateBackground;
    }
  }

  // ==================== Playback State Management ====================

  function updatePlaybackState() {
    fetch('{% url "music:playback_state" %}')
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          // Update progress
          const duration = data.duration_ms || 0;
          const progress = data.progress_ms || 0;
          const percentage = duration > 0 ? (progress / duration * 100) : 0;

          document.getElementById('progressFill').style.width = percentage + '%';
          document.getElementById('currentTime').textContent = formatTime(progress);
          document.getElementById('duration').textContent = formatTime(duration);

          // Update play/pause button
          const playPauseBtn = document.getElementById('playPauseBtn');
          const vinylRecord = document.getElementById('vinylRecord');

          if (data.is_playing) {
            playPauseBtn.innerHTML = '<span class="iconify text-3xl" data-icon="mdi:pause"></span>';
            vinylRecord.classList.add('playing');
          } else {
            playPauseBtn.innerHTML = '<span class="iconify text-3xl" data-icon="mdi:play"></span>';
            vinylRecord.classList.remove('playing');
          }

          // Update track info if changed
          const trackName = document.getElementById('trackName');
          const artistName = document.getElementById('artistName');
          const albumNameDisplay = document.getElementById('albumNameDisplay');
          const albumArt = document.getElementById('albumArt');

          if (trackName && data.track_name) {
            trackName.textContent = data.track_name;
          }
          if (artistName && data.artist_name) {
            artistName.textContent = data.artist_name;
          }
          if (albumNameDisplay && data.album_name) {
            albumNameDisplay.textContent = data.album_name;
          }

          // Update album art if URL changed
          if (albumArt && data.album_image_url && albumArt.src !== data.album_image_url) {
            albumArt.src = data.album_image_url;
            setTimeout(() => applyDynamicBackground(), 100);
          }
        }
      })
      .catch(error => console.error('Playback state error:', error));
  }

  // ==================== Playback Controls ====================

  function getActiveDeviceId() {
    const activeDevice = document.querySelector('.device-item.active');
    return activeDevice ? activeDevice.getAttribute('data-device-id') : null;
  }

  function togglePlayPause() {
    const deviceId = getActiveDeviceId();

    fetch('{% url "music:play_pause" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: `device_id=${deviceId || ''}`
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        updatePlaybackState();
      }
    });
  }

  function nextTrack() {
    const deviceId = getActiveDeviceId();

    fetch('{% url "music:next_track" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: `device_id=${deviceId || ''}`
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        setTimeout(() => {
          updatePlaybackState();
          applyDynamicBackground();
        }, 500);
      }
    });
  }

  function previousTrack() {
    const deviceId = getActiveDeviceId();

    fetch('{% url "music:previous_track" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: `device_id=${deviceId || ''}`
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        setTimeout(() => {
          updatePlaybackState();
          applyDynamicBackground();
        }, 500);
      }
    });
  }

  function setVolume(volume) {
    document.getElementById('volumeValue').textContent = volume + '%';
    const deviceId = getActiveDeviceId();

    fetch('{% url "music:set_volume" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: `volume=${volume}&device_id=${deviceId || ''}`
    });
  }

  function transferPlayback(deviceId) {
    fetch('{% url "music:transfer_playback" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: `device_id=${deviceId}`
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        document.querySelectorAll('.device-item').forEach(item => {
          item.classList.remove('active');
        });
        event.target.closest('.device-item').classList.add('active');
      }
    });
  }

  function toggleShuffle() {
    const btn = document.getElementById('shuffleBtn');
    const isActive = btn.classList.contains('active');
    const deviceId = getActiveDeviceId();

    fetch('{% url "music:set_shuffle" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: `state=${!isActive}&device_id=${deviceId || ''}`
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        btn.classList.toggle('active');
      }
    });
  }

  function toggleRepeat() {
    const btn = document.getElementById('repeatBtn');
    const currentMode = btn.getAttribute('data-repeat-mode') || 'off';
    const modes = ['off', 'context', 'track'];
    const nextMode = modes[(modes.indexOf(currentMode) + 1) % modes.length];
    const deviceId = getActiveDeviceId();

    fetch('{% url "music:set_repeat" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: `mode=${nextMode}&device_id=${deviceId || ''}`
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        btn.setAttribute('data-repeat-mode', nextMode);
        btn.classList.toggle('active', nextMode !== 'off');

        // Update icon based on mode
        if (nextMode === 'track') {
          btn.innerHTML = '<span class="iconify text-xl" data-icon="mdi:repeat-once"></span>';
        } else {
          btn.innerHTML = '<span class="iconify text-xl" data-icon="mdi:repeat"></span>';
        }
      }
    });
  }

  // Progress bar seek
  document.getElementById('progressBar')?.addEventListener('click', function(e) {
    const rect = this.getBoundingClientRect();
    const percent = (e.clientX - rect.left) / rect.width;
    const durationText = document.getElementById('duration').textContent.split(':');
    const duration = (parseInt(durationText[0]) * 60 + parseInt(durationText[1])) * 1000;
    const positionMs = percent * duration;
    const deviceId = getActiveDeviceId();

    fetch('{% url "music:seek" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: `position_ms=${Math.floor(positionMs)}&device_id=${deviceId || ''}`
    })
    .then(() => updatePlaybackState());
  });

  // ==================== Search Functionality ====================

  function setupPlayerSearch() {
    const searchInput = document.getElementById('playerSearchInput');
    const resultsDiv = document.getElementById('playerSearchResults');

    let searchTimeout;
    let abortController = null;

    function debounceSearch() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(performPlayerSearch, 300);
    }

    searchInput.addEventListener('input', (e) => {
      const query = e.target.value.trim();

      if (query.length === 0) {
        resultsDiv.innerHTML = '';
        if (abortController) {
          abortController.abort();
          abortController = null;
        }
        return;
      }

      debounceSearch();
    });

    searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        clearTimeout(searchTimeout);
        performPlayerSearch();
      }
    });

    function performPlayerSearch() {
      const query = searchInput.value.trim();

      if (query.length < 2) {
        resultsDiv.innerHTML = '';
        return;
      }

      if (abortController) {
        abortController.abort();
      }
      abortController = new AbortController();

      resultsDiv.innerHTML = `
        <div class="text-center py-8">
          <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-green-500 mb-2"></div>
          <div class="text-gray-400">Searching...</div>
        </div>
      `;

      console.log('Searching for:', query);
      console.log('CSRF Token:', getCsrfToken());
      console.log('Fetch URL:', `/music/api/search/?q=${encodeURIComponent(query)}`);

      fetch(`/music/api/search/?q=${encodeURIComponent(query)}`, {
        method: 'GET',
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': getCsrfToken()
        },
        signal: abortController.signal
      })
        .then(response => {
          console.log('Search response status:', response.status);
          console.log('Search response headers:', [...response.headers.entries()]);
          console.log('Search response OK:', response.ok);
          console.log('Search response redirected:', response.redirected);
          
          if (response.redirected) {
            throw new Error('Request was redirected - you may not be logged in');
          }
          
          if (!response.ok) {
            return response.text().then(text => {
              console.error('Error response body:', text);
              throw new Error(`HTTP ${response.status}: ${text || 'Search failed'}`);
            });
          }
          return response.json();
        })
        .then(data => {
          console.log('Search results data:', data);
          console.log('Songs count:', data?.songs?.length);
          console.log('Artists count:', data?.artists?.length);
          console.log('Albums count:', data?.albums?.length);
          abortController = null;

          if (!data || typeof data !== 'object') {
            throw new Error('Invalid response format');
          }

          renderSearchResults(data);
        })
        .catch(error => {
          if (error.name === 'AbortError') {
            return;
          }

          console.error('Search error:', error);
          resultsDiv.innerHTML = `
            <div class="text-center py-8">
              <span class="iconify text-4xl text-red-400 mb-2" data-icon="mdi:alert-circle"></span>
              <div class="text-gray-400">Search failed. Please try again.</div>
              <div class="text-sm text-gray-500 mt-1">${escapeHtml(error.message || 'Unknown error')}</div>
            </div>
          `;
        });
    }

    function renderSearchResults(data) {
      console.log('Rendering search results:', data);
      console.log('Data type:', typeof data);
      console.log('Data keys:', Object.keys(data));
      
      const songs = Array.isArray(data?.songs) ? data.songs.filter(Boolean) : [];
      const artists = Array.isArray(data?.artists) ? data.artists.filter(Boolean) : [];
      const albums = Array.isArray(data?.albums) ? data.albums.filter(Boolean) : [];

      console.log('Songs array:', songs);
      console.log('Songs length:', songs.length);
      console.log('Artists length:', artists.length);
      console.log('Albums length:', albums.length);

      const totalResults = songs.length + artists.length + albums.length;
      console.log('Total results:', totalResults);

      if (totalResults === 0) {
        console.log('No results - showing empty state');
        resultsDiv.innerHTML = `
          <div class="text-center py-8">
            <span class="iconify text-4xl text-gray-500 mb-2" data-icon="mdi:music-note-off"></span>
            <div class="text-gray-400">No results found</div>
            <div class="text-sm text-gray-500 mt-1">Try a different search term</div>
          </div>
        `;
        return;
      }

      let html = '';

      if (songs.length > 0) {
        html += `
          <div class="search-section mb-4">
            <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider px-4 py-2 bg-white/5">
              Songs (${songs.length})
            </h3>
            <div class="search-section-items">
              ${songs.map((song, idx) => {
                try {
                  console.log(`Rendering song ${idx}:`, song);
                  return renderSongResult(song);
                } catch (e) {
                  console.error('Error rendering song:', song, e);
                  return '';
                }
              }).filter(Boolean).join('')}
            </div>
          </div>
        `;
      }

      if (artists.length > 0) {
        html += `
          <div class="search-section mb-4">
            <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider px-4 py-2 bg-white/5">
              Artists (${artists.length})
            </h3>
            <div class="search-section-items">
              ${artists.map(artist => {
                try {
                  return renderArtistResult(artist);
                } catch (e) {
                  console.error('Error rendering artist:', artist, e);
                  return '';
                }
              }).filter(Boolean).join('')}
            </div>
          </div>
        `;
      }

      if (albums.length > 0) {
        html += `
          <div class="search-section mb-4">
            <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider px-4 py-2 bg-white/5">
              Albums (${albums.length})
            </h3>
            <div class="search-section-items">
              ${albums.map(album => {
                try {
                  return renderAlbumResult(album);
                } catch (e) {
                  console.error('Error rendering album:', album, e);
                  return '';
                }
              }).filter(Boolean).join('')}
            </div>
          </div>
        `;
      }

      resultsDiv.innerHTML = html;
      console.log('Search results rendered successfully');
    }

    function renderSongResult(song) {
      if (!song || typeof song !== 'object') {
        return '';
      }

      const title = String(song.title || 'Unknown Song').trim();
      const spotifyId = String(song.spotify_id || '').trim();
      let trackUri = String(song.uri || '').trim();

      if (!trackUri && spotifyId) {
        trackUri = `spotify:track:${spotifyId}`;
      }

      if (!trackUri) {
        console.warn('Song missing valid URI:', song);
        return '';
      }

      // Handle nested artist structure from search API
      const artistName = String(
        (song.artist && song.artist.name) ||
        (song.album && song.album.artist && song.album.artist.name) ||
        'Unknown Artist'
      ).trim();

      const albumTitle = String(
        (song.album && song.album.title) || 'Unknown Album'
      ).trim();

      const albumCover = String(
        (song.album && song.album.cover_url) || ''
      ).trim();

      const safeUri = escapeHtml(trackUri);
      const safeTitle = escapeHtml(title);
      const safeArtist = escapeHtml(artistName);
      const safeAlbum = escapeHtml(albumTitle);
      const safeCover = escapeHtml(albumCover);

      return `
        <div class="search-result-item song-result">
          <div class="flex items-center gap-3">
            ${albumCover ? `
              <img
                src="${safeCover}"
                alt="${safeAlbum}"
                class="w-12 h-12 rounded flex-shrink-0 object-cover"
                onerror="this.style.display='none'"
                loading="lazy"
              />
            ` : `
              <div class="w-12 h-12 rounded flex-shrink-0 bg-white/10 flex items-center justify-center flex-shrink-0">
                <span class="iconify text-xl text-gray-500" data-icon="mdi:music"></span>
              </div>
            `}
            <div class="flex-1 min-w-0">
              <div class="font-semibold text-white truncate">${safeTitle}</div>
              <div class="text-sm text-gray-400 truncate">${safeArtist} • ${safeAlbum}</div>
            </div>
            <div class="flex gap-2 flex-shrink-0">
              <button
                class="control-btn !w-10 !h-10"
                onclick="playTrackFromSearch('${safeUri}');"
                title="Play"
                type="button"
              >
                <span class="iconify text-lg" data-icon="mdi:play"></span>
              </button>
              <button
                class="control-btn !w-10 !h-10"
                onclick="addToQueueFromSearch('${safeUri}', {title: '${escapeHtml(title)}', artist: '${safeArtist}', album: '${safeAlbum}'});"
                title="Add to Queue"
                type="button"
              >
                <span class="iconify text-lg" data-icon="mdi:playlist-plus"></span>
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderArtistResult(artist) {
      if (!artist || typeof artist !== 'object') {
        return '';
      }

      const name = String(artist.name || 'Unknown Artist').trim();
      const imageUrl = String(artist.image_url || '').trim();

      if (!name) {
        return '';
      }

      const safeName = escapeHtml(name);
      const safeImage = escapeHtml(imageUrl);

      return `
        <div class="search-result-item artist-result" onclick="openArtistModal('${escapeSingleQuotes(safeName)}', '${escapeSingleQuotes(safeImage)}')">
          <div class="flex items-center gap-3 cursor-pointer hover:bg-white/10 transition-colors">
            ${imageUrl ? `
              <img
                src="${safeImage}"
                alt="${safeName}"
                class="w-12 h-12 rounded-full flex-shrink-0 object-cover"
                onerror="this.style.display='none'"
                loading="lazy"
              />
            ` : `
              <div class="w-12 h-12 rounded-full flex-shrink-0 bg-white/10 flex items-center justify-center">
                <span class="iconify text-xl text-gray-500" data-icon="mdi:account-music"></span>
              </div>
            `}
            <div class="flex-1 min-w-0">
              <div class="font-semibold text-white truncate">${safeName}</div>
              <div class="text-sm text-gray-400">Artist</div>
            </div>
            <span class="iconify text-xl text-gray-500 flex-shrink-0" data-icon="mdi:chevron-right"></span>
          </div>
        </div>
      `;
    }

    function renderAlbumResult(album) {
      if (!album || typeof album !== 'object') {
        return '';
      }

      const title = String(album.title || 'Unknown Album').trim();
      const artistName = String(
        (album.artist && album.artist.name) ||
        album.artist ||
        'Unknown Artist'
      ).trim();
      const coverUrl = String(album.cover_url || album.image_url || '').trim();

      let releaseYear = '';
      if (album.release_date) {
        try {
          releaseYear = new Date(album.release_date).getFullYear();
        } catch (e) {
          console.warn('Invalid release date:', album.release_date);
        }
      }

      if (!title) {
        return '';
      }

      const safeTitle = escapeHtml(title);
      const safeArtist = escapeHtml(artistName);
      const safeCover = escapeHtml(coverUrl);

      return `
        <div class="search-result-item album-result">
          <div class="flex items-center gap-3 cursor-pointer hover:bg-white/10 transition-colors">
            ${coverUrl ? `
              <img
                src="${safeCover}"
                alt="${safeTitle}"
                class="w-12 h-12 rounded flex-shrink-0 object-cover"
                onerror="this.style.display='none'"
                loading="lazy"
              />
            ` : `
              <div class="w-12 h-12 rounded flex-shrink-0 bg-white/10 flex items-center justify-center">
                <span class="iconify text-xl text-gray-500" data-icon="mdi:album"></span>
              </div>
            `}
            <div class="flex-1 min-w-0">
              <div class="font-semibold text-white truncate">${safeTitle}</div>
              <div class="text-sm text-gray-400 truncate">
                ${safeArtist}${releaseYear ? ` • ${releaseYear}` : ''}
              </div>
            </div>
            <span class="iconify text-xl text-gray-500 flex-shrink-0" data-icon="mdi:chevron-right"></span>
          </div>
        </div>
      `;
    }

    window.playTrackFromSearch = function(trackUri) {
      if (!trackUri || typeof trackUri !== 'string' || trackUri.trim() === '') {
        console.error('Invalid track URI provided:', trackUri);
        showNotification('Invalid track selected', 'error');
        return;
      }
      playTrack(trackUri);
    };

    window.addToQueueFromSearch = function(trackUri, trackInfo) {
      if (!trackUri || typeof trackUri !== 'string' || trackUri.trim() === '') {
        console.error('Invalid track URI provided:', trackUri);
        showNotification('Invalid track selected', 'error');
        return;
      }
      addToQueue(trackUri, trackInfo || {});
    };
  }

  function playTrack(trackUri) {
    console.log('Playing track:', trackUri);
    const deviceId = getActiveDeviceId();

    // If no active device, fetch devices and show selector
    if (!deviceId) {
      console.log('No active device, fetching devices...');
      fetch('{% url "music:get_devices" %}')
        .then(response => response.json())
        .then(data => {
          if (!data.devices || data.devices.length === 0) {
            showNotification('No Spotify devices available. Open Spotify on a device.', 'error');
            return;
          }

          // Find active device
          const activeDevice = data.devices.find(d => d.is_active);
          if (activeDevice) {
            // Play directly on active device
            playTrackOnDevice(trackUri, activeDevice.id);
          } else {
            // Show device selector
            window.syroPlayer = window.syroPlayer || {};
            window.syroPlayer.pendingTrackUri = trackUri;
            showDeviceSelector(data.devices);
          }
        })
        .catch(error => {
          console.error('Error fetching devices:', error);
          showNotification('Failed to fetch devices', 'error');
        });
      return;
    }

    playTrackOnDevice(trackUri, deviceId);
  }

  function playTrackOnDevice(trackUri, deviceId) {
    fetch('{% url "music:play_track" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        track_uri: trackUri,
        device_id: deviceId
      })
    })
    .then(response => response.json())
    .then(data => {
      console.log('Play track response:', data);
      if (data.status === 'success') {
        showNotification('Now playing', 'success');
        setTimeout(() => {
          updatePlaybackState();
          applyDynamicBackground();
        }, 500);
      } else {
        showNotification(data.message || 'Failed to play track', 'error');
      }
    })
    .catch(error => {
      console.error('Play track error:', error);
      showNotification('Failed to play track', 'error');
    });
  }

  function addToQueue(trackUri, trackInfo = {}) {
    fetch('{% url "music:add_to_queue" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        track_uri: trackUri,
        track_info: trackInfo
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        // Show success message
        showNotification(data.message, 'success');
        // Update queue display
        updateQueueDisplay();
      } else {
        showNotification(data.message || 'Failed to add to queue', 'error');
      }
    })
    .catch(error => {
      console.error('Add to queue error:', error);
      showNotification('Failed to add to queue', 'error');
    });
  }

  function updateQueueDisplay() {
    fetch('{% url "music:get_queue" %}')
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          const queueContainer = document.getElementById('queueContainer');
          const queueLength = data.queue_length || 0;
          
          if (queueLength > 0) {
            queueContainer.innerHTML = `
              <div class="space-y-2">
                <div class="flex justify-between items-center mb-2">
                  <p class="text-gray-400 text-sm">${queueLength} track${queueLength !== 1 ? 's' : ''} in queue</p>
                  <button 
                    onclick="clearQueue()"
                    class="text-xs text-red-400 hover:text-red-300 transition-colors"
                  >
                    Clear Queue
                  </button>
                </div>
                <div class="max-h-60 overflow-y-auto space-y-2">
                  ${data.queue.slice(0, 10).map((track, index) => `
                    <div class="flex items-center gap-2 p-2 rounded bg-white/5 hover:bg-white/10 transition-colors">
                      ${track.album_image ? `
                        <img src="${escapeHtml(track.album_image)}" alt="" class="w-10 h-10 rounded flex-shrink-0" />
                      ` : `
                        <div class="w-10 h-10 rounded flex-shrink-0 bg-white/10 flex items-center justify-center">
                          <span class="iconify text-gray-500" data-icon="mdi:music"></span>
                        </div>
                      `}
                      <div class="flex-1 min-w-0">
                        <div class="text-sm font-medium text-white truncate">${escapeHtml(track.name)}</div>
                        <div class="text-xs text-gray-400 truncate">${escapeHtml(track.artists)}</div>
                      </div>
                      <span class="text-xs text-gray-500">${formatTime(track.duration_ms)}</span>
                    </div>
                  `).join('')}
                  ${queueLength > 10 ? `
                    <div class="text-center text-xs text-gray-500 py-2">
                      +${queueLength - 10} more track${queueLength - 10 !== 1 ? 's' : ''}
                    </div>
                  ` : ''}
                </div>
              </div>
            `;
          } else {
            queueContainer.innerHTML = '<p class="text-center text-gray-500 py-4">Queue is empty</p>';
          }
        }
      })
      .catch(error => {
        console.error('Get queue error:', error);
      });
  }

  function clearQueue() {
    if (!confirm('Are you sure you want to clear the queue?')) {
      return;
    }

    fetch('{% url "music:clear_queue" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        showNotification('Queue cleared', 'success');
        updateQueueDisplay();
      }
    })
    .catch(error => {
      console.error('Clear queue error:', error);
      showNotification('Failed to clear queue', 'error');
    });
  }

  // Search result playback functions
  function playTrackFromSearch(trackUri) {
    console.log('Playing track from search:', trackUri);
    if (!trackUri) {
      showNotification('Invalid track', 'error');
      return;
    }
    
    // Close search results
    const resultsDiv = document.getElementById('playerSearchResults');
    if (resultsDiv) {
      resultsDiv.innerHTML = '';
    }
    const searchInput = document.getElementById('playerSearchInput');
    if (searchInput) {
      searchInput.value = '';
    }
    
    // Play the track using existing playTrack function
    playTrack(trackUri);
  }

  function addToQueueFromSearch(trackUri, trackInfo) {
    console.log('Adding track to queue from search:', trackUri, trackInfo);
    if (!trackUri) {
      showNotification('Invalid track', 'error');
      return;
    }
    
    // Add to queue using existing addToQueue function
    addToQueue(trackUri, trackInfo);
  }

  // ==================== Device Selection ====================

  async function selectDevice(deviceId, deviceName) {
    console.log('Selecting device:', deviceId, deviceName);
    
    try {
        const response = await fetch('/music/api/playback/transfer/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({ 
                device_id: deviceId 
            })
        });

        const data = await response.json();
        
        if (response.ok) {
            console.log('Successfully transferred to device:', deviceName);
            showNotification(`Switched to ${deviceName}`, 'success');
            
            // Close the device modal
            document.getElementById('deviceModal').classList.add('hidden');
            
            // Refresh devices to show active device
            setTimeout(() => {
                loadDevices();
            }, 1000);
            
            // Refresh playback state
            setTimeout(() => {
                updatePlayer();
            }, 1500);
        } else {
            console.error('Device transfer failed:', data.error);
            showNotification(`Failed to switch device: ${data.error}`, 'error');
        }
    } catch (error) {
        console.error('Error selecting device:', error);
        showNotification('Error switching device', 'error');
    }
  }

  // Add function to show notifications
  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-500' : 
        type === 'error' ? 'bg-red-500' : 
        'bg-blue-500'
    } text-white`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
  }

  // ==================== Spotify Web Playback SDK ====================

  let player;
  let deviceId;

  function initializeSpotifyPlayer() {
    window.onSpotifyWebPlaybackSDKReady = () => {
      const token = '{{ spotify_user.access_token }}';

      if (!token) {
        console.log('No access token available');
        return;
      }

      player = new Spotify.Player({
        name: 'Syro Web Player',
        getOAuthToken: cb => { cb(token); },
        volume: 0.5
      });

      // Error handling
      player.addListener('initialization_error', ({ message }) => {
        console.error('Initialization Error:', message);
      });

      player.addListener('authentication_error', ({ message }) => {
        console.error('Authentication Error:', message);
      });

      player.addListener('account_error', ({ message }) => {
        console.error('Account Error:', message);
      });

      player.addListener('playback_error', ({ message }) => {
        console.error('Playback Error:', message);
      });

      // Playback status updates
      player.addListener('player_state_changed', state => {
        if (!state) return;
        console.log('Player state changed:', state);
        updatePlaybackState();
      });

      // Ready
      player.addListener('ready', ({ device_id }) => {
        console.log('Ready with Device ID', device_id);
        deviceId = device_id;
      });

      // Connect to the player
      player.connect().then(success => {
        if (success) {
          console.log('The Web Playback SDK successfully connected to Spotify!');
        }
      });
    };
  }

  // ==================== Initialization ====================

  document.addEventListener('DOMContentLoaded', function() {
    // Remove any Spotify SDK injected elements
    removeSpotifySDKElements();
    
    // Keep checking and removing Spotify SDK elements
    setInterval(removeSpotifySDKElements, 1000);
    
    // Apply dynamic background on load
    applyDynamicBackground();

    // Update playback state
    updatePlaybackState();

    // Update queue display
    updateQueueDisplay();

    // Update playback state every 2 seconds
    setInterval(updatePlaybackState, 2000);

    // Update queue display every 10 seconds
    setInterval(updateQueueDisplay, 10000);

    // Setup search functionality
    setupPlayerSearch();

    // Remove any Spotify SDK elements that might appear
    removeSpotifySDKElements();

    // Initialize Spotify Web Playback SDK
    // DISABLED: Creates unwanted "Now Playing" modal window
    // initializeSpotifyPlayer();

    // Initialize new features
    initializeAdvancedFeatures();
  });

  // ==================== Remove Spotify SDK Elements ====================
  function removeSpotifySDKElements() {
    // Remove all Spotify iframes
    document.querySelectorAll('iframe[src*="spotify"], iframe[src*="now-playing"]').forEach(el => {
      console.log('Removing Spotify iframe:', el);
      el.remove();
    });

    // Remove divs with Spotify/Now Playing in class or id
    document.querySelectorAll(
      'div[class*="spotify"], div[id*="spotify"], ' +
      'div[class*="now-playing"], div[id*="now-playing"], ' +
      'div[class*="now_playing"], div[id*="now_playing"], ' +
      'div[class*="spotify-widget"], div[id*="spotify-widget"]'
    ).forEach(el => {
      console.log('Removing Spotify element:', el);
      el.remove();
    });

    // Remove any fixed/modal divs that might be Spotify players
    document.querySelectorAll('body > div').forEach(el => {
      const style = window.getComputedStyle(el);
      const zIndex = parseInt(style.zIndex) || 0;
      if (style.position === 'fixed' && zIndex > 100) {
        console.log('Removing fixed element with high z-index:', el, 'z-index:', zIndex);
        el.remove();
      }
    });

    // Remove any remaining body-level iframes
    document.querySelectorAll('body > iframe').forEach(el => {
      console.log('Removing body iframe:', el);
      el.remove();
    });

    console.log('Spotify SDK elements removal complete');
  }

  /* ==================== Advanced Features Initialization ==================== */
  function initializeAdvancedFeatures() {
    // Search history on search
    const searchForm = document.querySelector('form[action*="search"]');
    if (searchForm) {
      searchForm.addEventListener('submit', function() {
        const query = this.querySelector('input[name="q"]').value;
        SearchHistory.save(query);
      });
    }

    // Track lyrics button
    const lyricsButton = document.querySelector('#lyrics-button');
    if (lyricsButton) {
      lyricsButton.addEventListener('click', async function() {
        const trackId = document.querySelector('[data-spotify-track-id]')?.dataset.spotifyTrackId;
        const trackName = document.querySelector('#current-track-name')?.textContent;
        if (trackId && trackName) {
          await TrackLyrics.showModal(trackName, trackId);
        }
      });
    }

    // Visualizer style selector
    const visualizerSelect = document.querySelector('#visualizer-style');
    if (visualizerSelect) {
      visualizerSelect.addEventListener('change', function() {
        AudioVisualizer.setStyle(this.value);
      });
    }

    // Analytics dashboard
    const analyticsContainer = document.querySelector('#analytics-dashboard');
    if (analyticsContainer) {
      PlaybackAnalytics.displayDashboard('analytics-dashboard');
    }

    // Queue reordering
    const queueContainer = document.querySelector('#queue-container');
    if (queueContainer) {
      SmartQueue.renderQueue('queue-container');
    }

    console.log('Advanced features initialized');
  }
</script>
<script src="{% static 'js/features.js' %}"></script>

<!-- Device Selection Modal -->
{% include 'syromusic/player_modal.html' %}
{% endblock content %}
