{% extends 'base.html' %}
{% load static %}

{% block title %}Music Player - Syro{% endblock title %}

{% block extra_css %}
<style>
  /* Hide Spotify Web Playback SDK "Now Playing" Modal Only */
  /* Be selective - we need the SDK to work, just hide the modal UI */
  div[class*="now-playing"],
  div[id*="now-playing"],
  div[class*="now_playing"],
  div[id*="now_playing"],
  div[data-testid*="now-playing"],
  body > div[style*="position: fixed"][style*="z-index"] {
    display: none !important;
    visibility: hidden !important;
  }

  /* Hide iframes that might be Spotify widgets */
  iframe[src*="spotify"] {
    display: none !important;
  }

  /* Dark Theme Override for Player Page */
  body {
    background: #0a0a0a !important;
    color: #ffffff !important;
  }

  body::before {
    display: none;
  }

  /* Breathing Gradient Mesh Animation */
  @keyframes breathing {
    0%, 100% {
      opacity: 0.85;
      transform: scale(1.2) rotate(0deg);
    }
    25% {
      opacity: 0.9;
      transform: scale(1.22) rotate(0.5deg);
    }
    50% {
      opacity: 0.95;
      transform: scale(1.25) rotate(1deg);
    }
    75% {
      opacity: 0.9;
      transform: scale(1.22) rotate(0.5deg);
    }
  }

  @keyframes gradient-shift {
    0% {
      background-position: 0% 50%;
    }
    25% {
      background-position: 50% 25%;
    }
    50% {
      background-position: 100% 50%;
    }
    75% {
      background-position: 50% 75%;
    }
    100% {
      background-position: 0% 50%;
    }
  }
  
  @keyframes color-pulse {
    0%, 100% {
      filter: blur(120px) brightness(1) saturate(1.2);
    }
    50% {
      filter: blur(140px) brightness(1.2) saturate(1.5);
    }
  }
  
  @keyframes float {
    0%, 100% {
      transform: translateY(0px) translateX(0px);
    }
    33% {
      transform: translateY(-20px) translateX(10px);
    }
    66% {
      transform: translateY(10px) translateX(-10px);
    }
  }

  @keyframes prismatic-shift {
    0%, 100% {
      background-position: 0% 50%;
    }
    25% {
      background-position: 50% 0%;
    }
    50% {
      background-position: 100% 50%;
    }
    75% {
      background-position: 50% 100%;
    }
  }

  /* Silver Prismatic Button */
  .btn-prismatic {
    position: relative;
    background: linear-gradient(
      135deg,
      #c0c0c0 0%,
      #e8e8e8 15%,
      #ffffff 30%,
      #d4d4ff 45%,
      #ffd4ff 60%,
      #ffffff 75%,
      #e8e8e8 85%,
      #c0c0c0 100%
    );
    background-size: 300% 300%;
    color: #1a1a1a;
    font-weight: 700;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    box-shadow: 
      0 4px 12px rgba(255, 255, 255, 0.15),
      inset 0 1px 0 rgba(255, 255, 255, 0.5),
      inset 0 -1px 0 rgba(0, 0, 0, 0.2);
    animation: prismatic-shift 6s ease-in-out infinite;
    transition: all 0.3s ease;
  }

  .btn-prismatic:hover {
    transform: translateY(-2px);
    box-shadow: 
      0 8px 20px rgba(255, 255, 255, 0.25),
      inset 0 1px 0 rgba(255, 255, 255, 0.6),
      inset 0 -1px 0 rgba(0, 0, 0, 0.2);
    filter: brightness(1.1);
  }

  .btn-prismatic:active {
    transform: translateY(0px);
    box-shadow: 
      0 2px 8px rgba(255, 255, 255, 0.2),
      inset 0 1px 0 rgba(255, 255, 255, 0.4),
      inset 0 -1px 0 rgba(0, 0, 0, 0.3);
  }

  /* Dynamic Background Container */
  .dynamic-bg-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
    overflow: hidden;
  }

  .dynamic-bg {
    position: absolute;
    width: 100%;
    height: 100%;
    background:
      radial-gradient(ellipse 1200px 800px at 20% 30%, rgba(16, 185, 129, 0.15) 0%, transparent 40%),
      radial-gradient(ellipse 1000px 900px at 80% 70%, rgba(59, 130, 246, 0.1) 0%, transparent 40%),
      radial-gradient(ellipse 800px 1000px at 50% 50%, rgba(255, 107, 157, 0.08) 0%, transparent 50%),
      linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
    background-size: 200% 200%, 200% 200%, 300% 300%, 100% 100%;
    background-position: 0% 50%, 100% 50%, 50% 50%, center;
    transition: background 4s cubic-bezier(0.4, 0.0, 0.2, 1);
    filter: blur(120px);
    opacity: 0.85;
    transform: scale(1.2);
    animation: breathing 8s ease-in-out infinite, gradient-shift 15s ease-in-out infinite, color-pulse 10s ease-in-out infinite;
  }
  
  /* Additional animated gradient layers */
  .dynamic-bg::before {
    content: '';
    position: absolute;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle 800px at 30% 60%, rgba(139, 92, 246, 0.12) 0%, transparent 60%);
    animation: float 20s ease-in-out infinite;
    opacity: 0.6;
  }
  
  .dynamic-bg::after {
    content: '';
    position: absolute;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle 600px at 70% 40%, rgba(236, 72, 153, 0.1) 0%, transparent 50%);
    animation: float 18s ease-in-out infinite reverse;
    opacity: 0.5;
  }

  .dynamic-bg-overlay {
    position: absolute;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle at 50% 50%, transparent 0%, rgba(0,0,0,0.4) 100%);
    z-index: 1;
  }

  /* Grain Overlay - Analog/Archival Feel */
  .dynamic-bg-overlay::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image:
      url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' result='noise'/%3E%3C/filter%3E%3Crect width='400' height='400' fill='rgba(0,0,0,0.03)' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
    background-size: 200px 200px;
    opacity: 0.5;
    pointer-events: none;
    mix-blend-mode: overlay;
    z-index: 2;
  }

  /* Content wrapper to sit above dynamic background */
  .content-wrapper {
    position: relative;
    z-index: 10;
  }

  /* Vinyl Record Styles */
  .vinyl-container {
    position: relative;
    width: 360px;
    height: 360px;
    margin: 0 auto;
  }

  .vinyl-record {
    position: relative;
    width: 360px;
    height: 360px;
    border-radius: 50%;
    background: radial-gradient(circle at 35% 35%, #2a2a2a 0%, #1a1a1a 40%, #0a0a0a 100%);
    box-shadow:
      0 0 0 8px #0a0a0a,
      0 20px 60px rgba(0,0,0,0.8),
      inset 0 0 30px rgba(0,0,0,0.5);
    animation: spin 4s linear infinite paused;
    transform-origin: center;
  }

  .vinyl-record.playing {
    animation-play-state: running;
  }

  /* Vinyl grooves effect */
  .vinyl-grooves {
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: repeating-radial-gradient(
      circle at center,
      transparent 0px,
      transparent 2px,
      rgba(255,255,255,0.02) 2px,
      rgba(255,255,255,0.02) 4px
    );
    pointer-events: none;
  }

  /* Center label with album art */
  .vinyl-label {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 200px;
    height: 200px;
    border-radius: 50%;
    overflow: hidden;
    box-shadow:
      0 0 0 4px #1a1a1a,
      0 0 0 8px #0a0a0a,
      0 8px 24px rgba(0,0,0,0.6);
    background: #1a1a1a;
  }

  .vinyl-label img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  @keyframes spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }

  /* Player Card */
  .player-card {
    background: rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(40px) saturate(180%);
    -webkit-backdrop-filter: blur(40px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 24px;
    box-shadow:
      0 8px 32px rgba(0, 0, 0, 0.3),
      0 0 0 1px rgba(255, 255, 255, 0.03),
      inset 0 1px 0 rgba(255, 255, 255, 0.05);
  }

  .player-card:hover {
    background: rgba(0, 0, 0, 0.35);
    border-color: rgba(255, 255, 255, 0.12);
  }

  /* Track Info */
  /* Premium Typography */
  .track-name {
    font-size: 2.8rem;
    font-weight: 900;
    line-height: 1.15;
    letter-spacing: -0.03em;
    margin-bottom: 0.75rem;
    background: linear-gradient(135deg, #ffffff 0%, #d4d4d8 50%, #a0a0a0 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-shadow: 0 0 40px rgba(16, 185, 129, 0.1);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
  }

  .artist-name {
    font-size: 1.35rem;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.75);
    margin-bottom: 0.5rem;
    letter-spacing: -0.01em;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
  }

  .album-name {
    font-size: 1.05rem;
    font-weight: 500;
    color: rgba(255, 255, 255, 0.55);
    letter-spacing: 0.01em;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
  }

  /* Premium Progress Bar */
  .progress-container {
    position: relative;
    width: 100%;
    height: 6px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    cursor: pointer;
    overflow: hidden;
    transition: height 0.2s ease;
  }

  .progress-container:hover {
    height: 10px;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #ffffff 0%, #f0f0f0 100%);
    border-radius: 4px;
    transition: width 0.1s linear;
    box-shadow: 0 0 12px rgba(255, 255, 255, 0.6), 0 0 24px rgba(255, 255, 255, 0.3);
  }

  .time-display {
    font-size: 0.875rem;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.6);
    font-variant-numeric: tabular-nums;
  }

  /* Control Buttons */
  /* Premium Stereo Button Styling */
  .control-btn {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0.05) 100%);
    border: 1px solid rgba(255, 255, 255, 0.25);
    color: #ffffff;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter: blur(10px) saturate(120%);
    position: relative;
    overflow: hidden;
    font-weight: 500;
  }

  .control-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.2) 0%, transparent 70%);
    transition: left 0.3s ease;
    z-index: -1;
  }

  .control-btn:hover {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.18) 0%, rgba(255, 255, 255, 0.08) 100%);
    border-color: rgba(255, 255, 255, 0.35);
    transform: scale(1.08) translateY(-2px);
    box-shadow: 0 8px 24px rgba(16, 185, 129, 0.25);
  }

  .control-btn:active {
    transform: scale(0.95);
  }

  .control-btn.active {
    background: linear-gradient(135deg, #10b981 0%, #22c55e 100%);
    border-color: rgba(255, 255, 255, 0.2);
    box-shadow: 0 8px 28px rgba(16, 185, 129, 0.6);
  }

  .control-btn-lg {
    width: 72px;
    height: 72px;
    background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
    border: none;
    box-shadow: 0 12px 40px rgba(255, 255, 255, 0.5), 0 0 60px rgba(255, 255, 255, 0.3);
    position: relative;
    z-index: 1;
  }
  
  .control-btn-lg .iconify {
    color: #1a1a1a !important;
  }

  .control-btn-lg::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.6) 0%, transparent 70%);
    pointer-events: none;
  }

  .control-btn-lg:hover {
    background: linear-gradient(135deg, #f0f0f0 0%, #ffffff 100%);
    transform: scale(1.12) translateY(-4px);
    box-shadow: 0 16px 48px rgba(255, 255, 255, 0.7), 0 0 80px rgba(255, 255, 255, 0.4);
  }

  .control-btn-lg:active {
    transform: scale(0.96);
  }

  /* Volume Slider */
  .volume-slider {
    -webkit-appearance: none;
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background: rgba(255, 255, 255, 0.1);
    outline: none;
    transition: all 0.2s ease;
  }

  .volume-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: linear-gradient(135deg, #10b981 0%, #22c55e 100%);
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
    transition: all 0.2s ease;
  }

  .volume-slider::-webkit-slider-thumb:hover {
    transform: scale(1.2);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.6);
  }

  .volume-slider::-moz-range-thumb {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: linear-gradient(135deg, #10b981 0%, #22c55e 100%);
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
  }

  /* Device Panel */
  .device-item {
    padding: 0.875rem 1rem;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.08);
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
  }

  .device-item:hover {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(16, 185, 129, 0.5);
    transform: translateX(4px);
  }

  .device-item.active {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(34, 197, 94, 0.15) 100%);
    border-color: #10b981;
    color: #10b981;
  }

  /* Search Section */
  .search-input {
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 0.875rem 1rem;
    color: #ffffff;
    font-weight: 500;
    transition: all 0.2s ease;
    backdrop-filter: blur(10px);
  }

  .search-input:focus {
    outline: none;
    background: rgba(255, 255, 255, 0.08);
    border-color: #10b981;
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
  }

  .search-input::placeholder {
    color: rgba(255, 255, 255, 0.4);
  }

  .search-result-item {
    padding: 0.875rem 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.03);
    transition: all 0.2s ease;
    cursor: pointer;
    backdrop-filter: blur(10px);
  }

  .search-result-item:hover {
    background: rgba(255, 255, 255, 0.05);
  }

  .search-result-item:last-child {
    border-bottom: none;
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .vinyl-container {
      width: 300px;
      height: 300px;
    }

    .vinyl-record {
      width: 300px;
      height: 300px;
    }

    .vinyl-label {
      width: 160px;
      height: 160px;
    }

    .track-name {
      font-size: 2rem;
    }
  }

  @media (max-width: 640px) {
    .vinyl-container {
      width: 260px;
      height: 260px;
    }

    .vinyl-record {
      width: 260px;
      height: 260px;
    }

    .vinyl-label {
      width: 140px;
      height: 140px;
    }

    .track-name {
      font-size: 1.75rem;
    }

    .artist-name {
      font-size: 1rem;
    }

    .control-btn {
      width: 48px;
      height: 48px;
    }

    .control-btn-lg {
      width: 64px;
      height: 64px;
    }
  }

  /* Scrollbar for dark theme */
  ::-webkit-scrollbar {
    width: 12px;
    height: 12px;
  }

  ::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
  }

  ::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 6px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.3);
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes fadeOut {
    from {
      opacity: 1;
      transform: translateY(0);
    }
    to {
      opacity: 0;
      transform: translateY(20px);
    }
  }
</style>
{% endblock extra_css %}

{% block content %}
<!-- Dynamic Background -->
<div class="dynamic-bg-container">
  <div class="dynamic-bg" id="dynamicBg"></div>
  <div class="dynamic-bg-overlay"></div>
</div>

<!-- Content Wrapper -->
<div class="content-wrapper">
  <!-- Search Section -->
  <div class="max-w-7xl mx-auto mb-8">
    <div class="player-card p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-white">Search & Play</h2>
        <button onclick="loadUserPlaylists()" class="btn-prismatic px-4 py-2 rounded font-semibold transition flex items-center gap-2">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path d="M2 3a1 1 0 011-1h6a1 1 0 011 1v2a1 1 0 01-1 1H3a1 1 0 01-1-1V3zM2 9a1 1 0 011-1h6a1 1 0 011 1v2a1 1 0 01-1 1H3a1 1 0 01-1-1V9zm0 6a1 1 0 011-1h6a1 1 0 011 1v2a1 1 0 01-1 1H3a1 1 0 01-1-1v-2zM11 3a1 1 0 110 2h6a1 1 0 110 2h-6a1 1 0 110-2h6zM11 9a1 1 0 110 2h6a1 1 0 110 2h-6a1 1 0 110-2h6zm0 6a1 1 0 110 2h6a1 1 0 110 2h-6a1 1 0 110-2h6z" />
          </svg>
          My Playlists
        </button>
      </div>
      <input
        type="text"
        id="playerSearchInput"
        placeholder="Search for a song, artist, or album..."
        class="search-input w-full mb-4"
        autocomplete="off"
      />
      <div id="playerSearchResults" class="max-h-80 overflow-y-auto rounded-lg"></div>
    </div>
  </div>

  <!-- Main Player Layout -->
  <div class="max-w-7xl mx-auto">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Left: Vinyl Record -->
      <div class="lg:col-span-2">
        <div class="player-card p-8 lg:p-12">
          <!-- Vinyl Record -->
          <div class="mb-8 lg:mb-12">
            <div class="vinyl-container">
              <div class="vinyl-record {% if now_playing and now_playing.is_playing %}playing{% endif %}" id="vinylRecord">
                <div class="vinyl-grooves"></div>
                <div class="vinyl-label">
                  {% if now_playing and now_playing.album_image_url %}
                    <img
                      src="{{ now_playing.album_image_url }}"
                      alt="Album Art"
                      id="albumArt"
                      crossorigin="anonymous"
                    />
                  {% else %}
                    <div class="w-full h-full bg-gray-800 flex items-center justify-center">
                      <span class="iconify text-6xl text-gray-600" data-icon="mdi:music"></span>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <!-- Track Info -->
          {% if now_playing and now_playing.track_name %}
          <div class="text-center mb-8">
            <h1 class="track-name" id="trackName">{{ now_playing.track_name }}</h1>
            <p class="artist-name" id="artistName">{{ now_playing.artist_name }}</p>
            {% if now_playing.album_name %}
              <p class="album-name" id="albumNameDisplay">{{ now_playing.album_name }}</p>
            {% endif %}
          </div>
          {% endif %}

          <!-- Progress Bar -->
          <div class="mb-6">
            <div class="progress-container mb-2" id="progressBar">
              <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <div class="flex justify-between time-display">
              <span id="currentTime">0:00</span>
              <span id="duration">0:00</span>
            </div>
          </div>

          <!-- Playback Controls -->
          <div class="flex items-center justify-center gap-4 mb-8">
            <button class="control-btn" id="shuffleBtn" title="Shuffle" onclick="toggleShuffle()">
              <span class="iconify text-xl" data-icon="mdi:shuffle-variant"></span>
            </button>
            <button class="control-btn" onclick="previousTrack()" title="Previous">
              <span class="iconify text-2xl" data-icon="mdi:skip-previous"></span>
            </button>
            <button class="control-btn control-btn-lg" id="playPauseBtn" onclick="togglePlayPause()" title="Play/Pause">
              {% if now_playing and now_playing.is_playing %}
                <span class="iconify text-3xl" data-icon="mdi:pause"></span>
              {% else %}
                <span class="iconify text-3xl" data-icon="mdi:play"></span>
              {% endif %}
            </button>
            <button class="control-btn" onclick="nextTrack()" title="Next">
              <span class="iconify text-2xl" data-icon="mdi:skip-next"></span>
            </button>
            <button class="control-btn" id="repeatBtn" title="Repeat" onclick="toggleRepeat()">
              <span class="iconify text-xl" data-icon="mdi:repeat"></span>
            </button>
          </div>

          <!-- Volume Control -->
          <div class="flex items-center gap-4 mb-6">
            <span class="iconify text-xl text-white" data-icon="mdi:volume-high"></span>
            <input
              type="range"
              id="volumeSlider"
              class="volume-slider flex-1"
              min="0"
              max="100"
              value="100"
              onchange="setVolume(this.value)"
            />
            <span class="text-sm font-semibold text-white w-12 text-right" id="volumeValue">100%</span>
          </div>

          <!-- Lyrics Toggle Button -->
          <div class="flex justify-center">
            <button 
              id="lyricsToggleBtn"
              onclick="toggleLyrics()" 
              class="btn-prismatic px-6 py-3 rounded-xl font-bold flex items-center gap-2"
              title="Show Lyrics"
            >
              <span class="iconify" data-icon="mdi:music-note-outline"></span>
              <span>View Lyrics</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Right: Devices & Queue -->
      <div class="lg:col-span-1 space-y-6">
        <!-- Devices -->
        <div class="player-card p-6">
          <h2 class="text-lg font-bold mb-4 text-white flex items-center">
            <span class="iconify mr-2" data-icon="mdi:devices"></span>
            Available Devices
          </h2>
          <div class="space-y-2" id="deviceList">
            {% if devices %}
              {% for device in devices %}
                <div
                  class="device-item {% if device.is_active %}active{% endif %}"
                  data-device-id="{{ device.id }}"
                  onclick="transferPlayback('{{ device.id }}')"
                >
                  <div class="flex items-center justify-between">
                    <div class="flex items-center">
                      <span class="iconify mr-2" data-icon="
                        {% if device.type == 'Computer' %}mdi:laptop
                        {% elif device.type == 'Smartphone' %}mdi:cellphone
                        {% elif device.type == 'Speaker' %}mdi:speaker
                        {% else %}mdi:devices{% endif %}
                      "></span>
                      <span>{{ device.name }}</span>
                    </div>
                    {% if device.is_active %}
                      <span class="iconify text-green-400" data-icon="mdi:check-circle"></span>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <p class="text-center text-gray-500 py-4">No devices available</p>
            {% endif %}
          </div>
        </div>

        <!-- Queue Info -->
        <div class="player-card p-6">
          <h2 class="text-lg font-bold mb-4 text-white flex items-center">
            <span class="iconify mr-2" data-icon="mdi:playlist-music"></span>
            Queue
          </h2>
          <div id="queueContainer">
            {% if queue and queue.queue_tracks %}
              <p class="text-gray-400 text-sm">{{ queue.queue_tracks|length }} tracks in queue</p>
            {% else %}
              <p class="text-center text-gray-500 py-4">Queue is empty</p>
            {% endif %}
          </div>
        </div>

        <!-- Navigation -->
        <div class="player-card p-6">
          <h2 class="text-lg font-bold mb-4 text-white">Quick Links</h2>
          <div class="space-y-2">
            <a
              href="{% url 'music:dashboard' %}"
              class="device-item block text-center"
            >
              <span class="iconify mr-2" data-icon="mdi:view-dashboard"></span>
              Dashboard
            </a>
            <a
              href="{% url 'music:search' %}"
              class="device-item block text-center"
            >
              <span class="iconify mr-2" data-icon="mdi:magnify"></span>
              Search
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Artist Detail Modal -->
<div id="artistModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 1000; align-items: center; justify-content: center; padding: 2rem;">
  <div style="background: linear-gradient(135deg, rgba(10, 10, 10, 0.95) 0%, rgba(26, 26, 26, 0.95) 100%); border: 1px solid rgba(255, 107, 157, 0.3); border-radius: 16px; max-width: 500px; width: 100%; max-height: 80vh; overflow-y: auto; padding: 2rem; position: relative;">
    <!-- Close Button -->
    <button onclick="closeArtistModal()" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: #ff6b9d; font-size: 1.5rem; cursor: pointer; z-index: 1001;">
      ✕
    </button>

    <!-- Artist Image -->
    <img id="artistModalImage" style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; margin: 0 auto 1.5rem; display: block; border: 2px solid rgba(255, 107, 157, 0.5);" alt="Artist">

    <!-- Artist Name -->
    <h2 id="artistModalTitle" style="font-size: 1.75rem; font-weight: 900; color: white; margin-bottom: 2rem; text-align: center; background: linear-gradient(135deg, #ff6b9d, #45b7d1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"></h2>

    <!-- Modal Content -->
    <div id="artistModalContent" style="color: white; line-height: 1.6;"></div>
  </div>
</div>

<!-- Lyrics Modal -->
<div id="lyricsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.92); z-index: 1000; align-items: center; justify-content: center; padding: 2rem; backdrop-filter: blur(4px);">
  <div style="background: linear-gradient(135deg, rgba(10, 10, 10, 0.98) 0%, rgba(26, 26, 26, 0.98) 50%, rgba(15, 52, 96, 0.3) 100%); border: 1px solid rgba(192, 192, 192, 0.4); border-radius: 20px; max-width: 700px; width: 100%; max-height: 85vh; overflow-y: auto; padding: 2.5rem; position: relative; box-shadow: 0 0 60px rgba(16, 185, 129, 0.2), 0 0 30px rgba(192, 192, 192, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.1);">
    <!-- Close Button -->
    <button onclick="closeLyricsModal()" style="position: absolute; top: 1.5rem; right: 1.5rem; background: none; border: none; color: rgba(192, 192, 192, 0.8); font-size: 1.5rem; cursor: pointer; z-index: 1001; transition: all 0.3s ease; padding: 0.5rem;">
      ✕
    </button>
    <button onclick="closeLyricsModal()" style="position: absolute; top: 1.5rem; right: 1.5rem; background: none; border: none; color: rgba(192, 192, 192, 0.8); font-size: 1.5rem; cursor: pointer; z-index: 1001; transition: all 0.3s ease; padding: 0.5rem;" onmouseover="this.style.color='rgba(16, 185, 129, 0.9)'; this.style.textShadow='0 0 10px rgba(16, 185, 129, 0.6)';" onmouseout="this.style.color='rgba(192, 192, 192, 0.8)'; this.style.textShadow='none';">
    </button>

    <!-- Track Info with Glow -->
    <div style="text-align: center; margin-bottom: 2.5rem; padding-bottom: 1.5rem; border-bottom: 2px solid rgba(16, 185, 129, 0.3);">
      <h2 id="lyricsTrackName" style="font-size: 1.8rem; font-weight: 800; background: linear-gradient(135deg, #ffffff 0%, #e8e8e8 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 0.5rem; text-shadow: 0 0 20px rgba(16, 185, 129, 0.3); letter-spacing: -0.5px;"></h2>
      <p id="lyricsArtistName" style="font-size: 1.1rem; color: rgba(16, 185, 129, 0.9); font-weight: 500; text-transform: uppercase; letter-spacing: 1px;"></p>
    </div>

    <!-- Lyrics Content with Glow Effects -->
    <div id="lyricsContent" style="color: rgba(255, 255, 255, 0.95); line-height: 2.2; font-size: 1.15rem; white-space: pre-wrap; text-align: center; font-family: 'Inter', sans-serif; text-shadow: 0 0 20px rgba(16, 185, 129, 0.15); margin: 1rem 0;">
      <div style="text-align: center; padding: 3rem 1rem;">
        <div style="display: inline-block; width: 40px; height: 40px; border: 3px solid rgba(16, 185, 129, 0.4); border-top-color: rgba(16, 185, 129, 1); border-radius: 50%; animation: spin 1s linear infinite; box-shadow: 0 0 20px rgba(16, 185, 129, 0.6);"></div>
        <p style="margin-top: 1rem; color: rgba(16, 185, 129, 0.8);">Loading lyrics...</p>
      </div>
    </div>

    <!-- Source Attribution -->
    <div id="lyricsSource" style="margin-top: 2.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(16, 185, 129, 0.2); text-align: center; color: rgba(16, 185, 129, 0.7); font-size: 0.9rem; font-weight: 500;">
    </div>
  </div>
</div>

<style>
  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  @keyframes glowPulse {
    0%, 100% {
      text-shadow: 0 0 10px rgba(16, 185, 129, 0.3), 0 0 20px rgba(16, 185, 129, 0.1);
    }
    50% {
      text-shadow: 0 0 20px rgba(16, 185, 129, 0.6), 0 0 40px rgba(16, 185, 129, 0.3);
    }
  }

  #lyricsContent {
    animation: glowPulse 4s ease-in-out infinite;
  }
</style>

<script>
  // ==================== Utility Functions ====================

  function getCsrfToken() {
    const name = 'csrftoken';
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function formatTime(ms) {
    const seconds = Math.floor((ms / 1000) % 60);
    const minutes = Math.floor((ms / 1000 / 60) % 60);
    return `${minutes}:${seconds.toString().padStart(2, '0')}`;
  }

  function escapeHtml(text) {
    const map = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
  }

  function escapeSingleQuotes(text) {
    return text.replace(/'/g, "\\'");
  }

  function formatDuration(ms) {
    if (!ms) return '0:00';
    const totalSeconds = Math.floor(ms / 1000);
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;
    return `${minutes}:${seconds.toString().padStart(2, '0')}`;
  }

  function playPlaylist(playlistUri, playlistName) {
    /**
     * Play a Spotify playlist
     */
    if (!playlistUri) {
      showNotification('Invalid playlist URI', 'error');
      return;
    }

    const deviceId = getActiveDeviceId();

    // If no active device, fetch devices and show selector
    if (!deviceId) {
      console.log('No active device, fetching devices...');
      fetch('{% url "music:get_devices" %}')
        .then(response => response.json())
        .then(data => {
          if (!data.devices || data.devices.length === 0) {
            showNotification('No Spotify devices available. Open Spotify on a device.', 'error');
            return;
          }

          // Find active device
          const activeDevice = data.devices.find(d => d.is_active);
          if (activeDevice) {
            // Play directly on active device
            playPlaylistOnDevice(playlistUri, playlistName, activeDevice.id);
          } else {
            // Show device selector
            window.syroPlayer = window.syroPlayer || {};
            window.syroPlayer.pendingPlaylistUri = playlistUri;
            window.syroPlayer.pendingPlaylistName = playlistName;
            showDeviceSelector(data.devices);
          }
        })
        .catch(error => {
          console.error('Error fetching devices:', error);
          showNotification('Failed to fetch devices', 'error');
        });
      return;
    }

    playPlaylistOnDevice(playlistUri, playlistName, deviceId);
  }

  function playPlaylistOnDevice(playlistUri, playlistName, deviceId) {
    fetch('{% url "music:play_track" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({
        uri: playlistUri,
        device_id: deviceId
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        showNotification(`Now playing: ${escapeHtml(playlistName)}`, 'success');
        setTimeout(() => {
          updatePlaybackState();
          applyDynamicBackground();
        }, 500);
      } else {
        showNotification(data.message || 'Failed to play playlist', 'error');
      }
    })
    .catch(error => {
      console.error('Error playing playlist:', error);
      showNotification('Failed to play playlist', 'error');
    });
  }

  // Artist Modal Functions
  function openArtistModal(artistName, artistImage, artistId) {
    const modal = document.getElementById('artistModal');
    if (!modal) return;

    const modalTitle = document.getElementById('artistModalTitle');
    const modalImage = document.getElementById('artistModalImage');
    const modalContent = document.getElementById('artistModalContent');

    modalTitle.textContent = artistName;
    if (artistImage && artistImage.trim()) {
      modalImage.src = artistImage;
      modalImage.style.display = 'block';
    } else {
      modalImage.style.display = 'none';
    }

    // Show loading state
    modalContent.innerHTML = `
      <div class="flex items-center justify-center py-8">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-cyan-500"></div>
      </div>
    `;

    modal.style.display = 'flex';

    // Fetch artist tracks from the API
    if (artistId) {
      fetch(`/music/api/artists/${encodeURIComponent(artistId)}/tracks/?limit=100`)
        .then(response => {
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          return response.json();
        })
        .then(data => {
          if (!data || !data.data || !data.data.tracks) {
            throw new Error('No tracks data in response');
          }

          const tracks = data.data.tracks;

          if (!tracks || tracks.length === 0) {
            modalContent.innerHTML = `
              <div class="text-center py-8">
                <p class="text-gray-400">No tracks found for this artist.</p>
              </div>
            `;
            return;
          }

          // Build track list HTML
          let tracksHtml = '<div class="space-y-2 max-h-96 overflow-y-auto">';
          tracks.forEach(track => {
            const trackName = escapeHtml(track.name || 'Unknown Track');
            const albumName = escapeHtml(track.album || 'Unknown Album');
            const duration = track.duration_ms ? formatDuration(track.duration_ms) : '0:00';
            const trackUri = track.uri || '';

            tracksHtml += `
              <div class="flex items-center gap-3 p-2 rounded hover:bg-white/10 transition-colors group">
                <div class="flex-1 min-w-0">
                  <div class="font-semibold text-white truncate text-sm">${trackName}</div>
                  <div class="text-xs text-gray-400 truncate">${albumName}</div>
                </div>
                <div class="text-xs text-gray-500 flex-shrink-0">${duration}</div>
                <button
                  onclick="playTrackFromSearch('${escapeHtml(trackUri)}')"
                  class="hidden group-hover:flex items-center justify-center w-8 h-8 rounded-full bg-cyan-500 hover:bg-cyan-400 transition-colors flex-shrink-0"
                  title="Play"
                >
                  <span class="iconify text-white" data-icon="mdi:play"></span>
                </button>
              </div>
            `;
          });
          tracksHtml += '</div>';

          modalContent.innerHTML = `
            <div class="space-y-4">
              <div>
                <h3 class="text-lg font-semibold text-white mb-3">Top Songs</h3>
                <p class="text-gray-400 text-sm mb-4">${tracks.length} tracks available</p>
                ${tracksHtml}
              </div>
            </div>
          `;
        })
        .catch(error => {
          console.error('Error loading artist tracks:', error);
          modalContent.innerHTML = `
            <div class="text-center py-8">
              <p class="text-red-400">Failed to load tracks for this artist.</p>
              <p class="text-gray-400 text-sm mt-2">${escapeHtml(error.message)}</p>
            </div>
          `;
        });
    }
  }

  function closeArtistModal() {
    const modal = document.getElementById('artistModal');
    if (modal) {
      modal.style.display = 'none';
    }
  }

  // Album Modal Functions
  function openAlbumModal(albumTitle, albumCover, albumId) {
    const modal = document.getElementById('artistModal');
    if (!modal) return;

    const modalTitle = document.getElementById('artistModalTitle');
    const modalImage = document.getElementById('artistModalImage');
    const modalContent = document.getElementById('artistModalContent');

    modalTitle.textContent = albumTitle;
    if (albumCover && albumCover.trim()) {
      modalImage.src = albumCover;
      modalImage.style.display = 'block';
    } else {
      modalImage.style.display = 'none';
    }

    // Show loading state
    modalContent.innerHTML = `
      <div class="flex items-center justify-center py-8">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-cyan-500"></div>
      </div>
    `;

    modal.style.display = 'flex';

    // Fetch album tracks from the API
    if (albumId) {
      fetch(`/music/api/spotify/album/${encodeURIComponent(albumId)}/tracks/`)
        .then(response => {
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          return response.json();
        })
        .then(data => {
          if (!data || !data.data || !data.data.tracks) {
            throw new Error('No tracks data in response');
          }

          const tracks = data.data.tracks;

          if (!tracks || tracks.length === 0) {
            modalContent.innerHTML = `
              <div class="text-center py-8">
                <p class="text-gray-400">No tracks found for this album.</p>
              </div>
            `;
            return;
          }

          // Build track list HTML
          let tracksHtml = '<div class="space-y-2 max-h-96 overflow-y-auto">';
          tracks.forEach((track, index) => {
            const trackName = escapeHtml(track.name || 'Unknown Track');
            const artistName = escapeHtml(track.artist || 'Unknown Artist');
            const duration = track.duration_ms ? formatDuration(track.duration_ms) : '0:00';
            const trackUri = track.uri || '';

            tracksHtml += `
              <div class="flex items-center gap-3 p-2 rounded hover:bg-white/10 transition-colors group">
                <div class="text-xs text-gray-500 flex-shrink-0 w-6 text-right">${index + 1}</div>
                <div class="flex-1 min-w-0">
                  <div class="font-semibold text-white truncate text-sm">${trackName}</div>
                  <div class="text-xs text-gray-400 truncate">${artistName}</div>
                </div>
                <div class="text-xs text-gray-500 flex-shrink-0">${duration}</div>
                <button
                  onclick="playTrackFromSearch('${escapeHtml(trackUri)}')"
                  class="hidden group-hover:flex items-center justify-center w-8 h-8 rounded-full bg-cyan-500 hover:bg-cyan-400 transition-colors flex-shrink-0"
                  title="Play"
                >
                  <span class="iconify text-white" data-icon="mdi:play"></span>
                </button>
              </div>
            `;
          });
          tracksHtml += '</div>';

          // Add button to play entire album
          let playAllHtml = '';
          if (tracks.length > 0 && tracks[0].uri) {
            playAllHtml = `
              <button
                onclick="playTrackFromSearch('${escapeHtml(tracks[0].uri)}')"
                class="w-full mt-4 px-4 py-2 rounded-lg bg-cyan-500 hover:bg-cyan-400 text-white font-semibold transition-colors"
              >
                Play Album
              </button>
            `;
          }

          modalContent.innerHTML = `
            <div class="space-y-4">
              <div>
                <h3 class="text-lg font-semibold text-white mb-3">Tracks</h3>
                <p class="text-gray-400 text-sm mb-4">${tracks.length} tracks</p>
                ${tracksHtml}
              </div>
              ${playAllHtml}
            </div>
          `;
        })
        .catch(error => {
          console.error('Error loading album tracks:', error);
          modalContent.innerHTML = `
            <div class="text-center py-8">
              <p class="text-red-400">Failed to load tracks for this album.</p>
              <p class="text-gray-400 text-sm mt-2">${escapeHtml(error.message)}</p>
            </div>
          `;
        });
    }
  }

  // Close modal when clicking outside of it
  window.addEventListener('click', function(event) {
    const modal = document.getElementById('artistModal');
    if (event.target === modal) {
      modal.style.display = 'none';
    }
  });

  // ==================== Playlist Functions ====================

  function loadUserPlaylists() {
    /**
     * Fetch and display user's playlists from Spotify
     */
    fetch('/music/api/playlists/user/', {
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success' && data.data.playlists.length > 0) {
        displayUserPlaylists(data.data.playlists);
      } else {
        showNotification('No playlists found', 'info');
      }
    })
    .catch(error => {
      console.error('Error loading playlists:', error);
      showNotification('Failed to load playlists', 'error');
    });
  }

  function displayUserPlaylists(playlists) {
    /**
     * Display list of user playlists in a modal
     */
    const modal = document.getElementById('artistModal');
    const modalContent = document.getElementById('artistModalContent');
    const modalImage = document.getElementById('artistModalImage');
    const modalTitle = document.getElementById('artistModalTitle');

    if (!modal || !modalContent) {
      console.error('Modal elements not found');
      return;
    }

    // Hide the image and title elements for playlists view
    if (modalImage) modalImage.style.display = 'none';
    if (modalTitle) modalTitle.style.display = 'none';

    const playlistsHtml = playlists.map((playlist, index) => `
      <div class="flex items-center justify-between p-4 bg-black/40 backdrop-blur-md rounded-lg hover:bg-black/50 transition cursor-pointer group border border-white/10" onclick="openPlaylistModal('${escapeSingleQuotes(playlist.name)}', '${escapeSingleQuotes(playlist.image)}', '${escapeSingleQuotes(playlist.id)}')">
        <div class="flex items-center gap-4 flex-1 min-w-0">
          ${playlist.image ? `
            <img src="${escapeHtml(playlist.image)}" alt="${escapeHtml(playlist.name)}" class="w-12 h-12 rounded object-cover flex-shrink-0">
          ` : `
            <div class="w-12 h-12 bg-white/10 rounded flex items-center justify-center flex-shrink-0">
              <svg class="w-6 h-6 text-white/40" fill="currentColor" viewBox="0 0 20 20">
                <path d="M2 3a1 1 0 011-1h6a1 1 0 011 1v2a1 1 0 01-1 1H3a1 1 0 01-1-1V3zM2 9a1 1 0 011-1h6a1 1 0 011 1v2a1 1 0 01-1 1H3a1 1 0 01-1-1V9zm0 6a1 1 0 011-1h6a1 1 0 011 1v2a1 1 0 01-1 1H3a1 1 0 01-1-1v-2zM11 3a1 1 0 110 2h6a1 1 0 110 2h-6a1 1 0 110-2h6zM11 9a1 1 0 110 2h6a1 1 0 110 2h-6a1 1 0 110-2h6zm0 6a1 1 0 110 2h6a1 1 0 110 2h-6a1 1 0 110-2h6z" />
              </svg>
            </div>
          `}
          <div class="min-w-0 flex-1">
            <p class="font-semibold text-white truncate">${escapeHtml(playlist.name)}</p>
            <p class="text-sm text-white/60 truncate">${playlist.track_count} tracks • ${escapeHtml(playlist.owner)}</p>
          </div>
        </div>
      </div>
    `).join('');

    modalContent.innerHTML = `
      <div class="space-y-4 max-h-96 overflow-y-auto">
        <div class="text-center pb-2">
          <h3 class="text-3xl font-bold bg-gradient-to-r from-gray-300 via-white to-gray-300 bg-clip-text text-transparent">My Playlists</h3>
        </div>
        ${playlistsHtml}
      </div>
    `;

    modal.style.display = 'flex';
    modalContent.scrollTop = 0;
  }

  function openPlaylistModal(playlistName, playlistCover, playlistId) {
    /**
     * Open playlist and display its tracks
     */
    const modal = document.getElementById('artistModal');
    const modalContent = document.getElementById('artistModalContent');
    const modalImage = document.getElementById('artistModalImage');
    const modalTitle = document.getElementById('artistModalTitle');

    if (!modal || !modalContent) {
      console.error('Modal elements not found');
      return;
    }

    // Show image and title for playlist detail view
    if (modalImage) {
      modalImage.style.display = 'block';
      if (playlistCover && playlistCover.trim()) {
        modalImage.src = playlistCover;
      }
    }
    if (modalTitle) {
      modalTitle.style.display = 'block';
      modalTitle.textContent = playlistName;
    }

    // Show loading state
    modalContent.innerHTML = `
      <div class="flex items-center justify-center py-8">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-cyan-400"></div>
      </div>
    `;
    modal.style.display = 'flex';

    // Fetch playlist tracks
    fetch(`/music/api/playlists/${playlistId}/tracks/`, {
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        displayPlaylistTracks(data.data);
      } else {
        throw new Error(data.message || 'Failed to load playlist');
      }
    })
    .catch(error => {
      console.error('Error loading playlist tracks:', error);
      modalContent.innerHTML = `
        <div class="text-center py-8">
          <p class="text-red-400">Failed to load playlist tracks.</p>
          <p class="text-gray-400 text-sm mt-2">${escapeHtml(error.message)}</p>
          <button onclick="loadUserPlaylists()" class="mt-4 px-4 py-2 bg-cyan-500 text-gray-900 rounded font-semibold hover:bg-cyan-400 transition">
            Back to Playlists
          </button>
        </div>
      `;
    });
  }

  function displayPlaylistTracks(data) {
    /**
     * Display tracks from a playlist
     */
    const modal = document.getElementById('artistModal');
    const modalContent = document.getElementById('artistModalContent');
    const playlist = data.playlist;
    const tracks = data.tracks;

    if (!tracks || tracks.length === 0) {
      modalContent.innerHTML = `
        <div class="text-center py-8">
          <p class="text-gray-400">This playlist has no tracks.</p>
          <button onclick="loadUserPlaylists()" class="mt-4 px-4 py-2 bg-cyan-500 text-gray-900 rounded font-semibold hover:bg-cyan-400 transition">
            Back to Playlists
          </button>
        </div>
      `;
      return;
    }

    const tracksHtml = tracks.map((track, index) => {
      const duration = formatDuration(track.duration_ms);
      return `
        <div class="flex items-center justify-between p-3 bg-gray-800 rounded hover:bg-gray-700 transition group">
          <div class="flex items-center gap-3 flex-1 min-w-0">
            ${track.cover_url ? `
              <img src="${escapeHtml(track.cover_url)}" alt="${escapeHtml(track.name)}" class="w-10 h-10 rounded object-cover flex-shrink-0">
            ` : `
              <div class="w-10 h-10 bg-gray-700 rounded flex items-center justify-center flex-shrink-0">
                <svg class="w-5 h-5 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zm0 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V8zm0 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2zm0 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2z" />
                </svg>
              </div>
            `}
            <div class="min-w-0 flex-1">
              <p class="font-semibold text-white truncate">${escapeHtml(track.name)}</p>
              <p class="text-sm text-gray-400 truncate">${escapeHtml(track.artist)} • ${escapeHtml(track.album)}</p>
            </div>
          </div>
          <div class="flex items-center gap-2 ml-2">
            <span class="text-gray-400 text-sm whitespace-nowrap">${duration}</span>
            <button onclick="playTrack('${escapeSingleQuotes(track.uri)}')" class="opacity-0 group-hover:opacity-100 transition p-2 hover:bg-cyan-500 rounded" title="Play">
              <svg class="w-5 h-5 text-cyan-400 hover:text-gray-900" fill="currentColor" viewBox="0 0 20 20">
                <path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z" />
              </svg>
            </button>
            <button onclick="addToQueue('${escapeSingleQuotes(track.uri)}', {title: '${escapeHtml(track.name)}', artist: '${escapeHtml(track.artist)}', album: '${escapeHtml(track.album)}'})" class="opacity-0 group-hover:opacity-100 transition p-2 hover:bg-cyan-500 rounded" title="Add to Queue">
              <svg class="w-5 h-5 text-cyan-400 hover:text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
              </svg>
            </button>
          </div>
        </div>
      `;
    }).join('');

    const backButton = `
      <button onclick="loadUserPlaylists()" class="mb-4 px-3 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded transition flex items-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Back
      </button>
    `;

    const playAllButton = tracks && tracks.length > 0 ? `
      <button onclick="playPlaylist('${escapeSingleQuotes(playlist.uri)}', '${escapeSingleQuotes(playlist.name)}')" class="mb-4 w-full px-4 py-2 bg-cyan-500 hover:bg-cyan-400 text-gray-900 rounded font-semibold transition">
        Play Playlist
      </button>
    ` : '';

    modalContent.innerHTML = `
      <div>
        ${backButton}
        <div class="bg-gradient-to-br from-cyan-500 to-cyan-600 rounded-lg p-4 mb-4 flex gap-4">
          ${playlist.image ? `
            <img src="${escapeHtml(playlist.image)}" alt="${escapeHtml(playlist.name)}" class="w-24 h-24 rounded object-cover">
          ` : `
            <div class="w-24 h-24 bg-cyan-700 rounded flex items-center justify-center">
              <svg class="w-12 h-12 text-gray-200" fill="currentColor" viewBox="0 0 20 20">
                <path d="M2 3a1 1 0 011-1h6a1 1 0 011 1v2a1 1 0 01-1 1H3a1 1 0 01-1-1V3zM2 9a1 1 0 011-1h6a1 1 0 011 1v2a1 1 0 01-1 1H3a1 1 0 01-1-1V9zm0 6a1 1 0 011-1h6a1 1 0 011 1v2a1 1 0 01-1 1H3a1 1 0 01-1-1v-2zM11 3a1 1 0 110 2h6a1 1 0 110 2h-6a1 1 0 110-2h6zM11 9a1 1 0 110 2h6a1 1 0 110 2h-6a1 1 0 110-2h6zm0 6a1 1 0 110 2h6a1 1 0 110 2h-6a1 1 0 110-2h6z" />
              </svg>
            </div>
          `}
          <div class="flex flex-col justify-between">
            <div>
              <p class="text-gray-900 text-xs opacity-80">PLAYLIST</p>
              <p class="text-gray-900 font-bold text-lg line-clamp-2">${escapeHtml(playlist.name)}</p>
            </div>
            <p class="text-gray-900 text-sm">${playlist.track_count} songs • ${escapeHtml(playlist.owner)}</p>
          </div>
        </div>
        ${playAllButton}
        <div class="space-y-3 max-h-80 overflow-y-auto">
          ${tracksHtml}
        </div>
      </div>
    `;
  }

  function showAddToPlaylistModal(trackUri, trackName) {
    /**
     * Show a modal to select which playlist to add a track to
     */
    const modal = document.getElementById('artistModal');
    const modalContent = document.getElementById('artistModalContent');

    if (!modal || !modalContent) {
      console.error('Modal elements not found');
      return;
    }

    // Show loading state
    modalContent.innerHTML = `
      <div class="flex items-center justify-center py-8">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-cyan-400"></div>
      </div>
    `;
    modal.style.display = 'flex';

    // Fetch user's playlists
    fetch('/music/api/playlists/user/?limit=50', {
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success' && data.data.playlists.length > 0) {
        displayPlaylistSelectModal(data.data.playlists, trackUri, trackName);
      } else {
        throw new Error('No playlists found');
      }
    })
    .catch(error => {
      console.error('Error loading playlists:', error);
      modalContent.innerHTML = `
        <div class="text-center py-8">
          <p class="text-red-400">Failed to load playlists.</p>
          <p class="text-gray-400 text-sm mt-2">${escapeHtml(error.message)}</p>
          <button onclick="document.getElementById('artistModal').style.display='none'" class="mt-4 px-4 py-2 bg-cyan-500 text-gray-900 rounded font-semibold hover:bg-cyan-400 transition">
            Close
          </button>
        </div>
      `;
    });
  }

  function displayPlaylistSelectModal(playlists, trackUri, trackName) {
    /**
     * Display playlists for user to select
     */
    const modal = document.getElementById('artistModal');
    const modalContent = document.getElementById('artistModalContent');

    const playlistsHtml = playlists.map((playlist) => `
      <button onclick="addTrackToPlaylist('${escapeSingleQuotes(playlist.id)}', '${escapeSingleQuotes(trackUri)}', '${escapeSingleQuotes(playlist.name)}', '${escapeSingleQuotes(trackName)}')" class="w-full flex items-center justify-between p-3 bg-gray-800 rounded hover:bg-cyan-600 transition group">
        <div class="flex items-center gap-3 flex-1 min-w-0">
          ${playlist.image ? `
            <img src="${escapeHtml(playlist.image)}" alt="${escapeHtml(playlist.name)}" class="w-10 h-10 rounded object-cover flex-shrink-0">
          ` : `
            <div class="w-10 h-10 bg-cyan-500 rounded flex items-center justify-center flex-shrink-0">
              <svg class="w-5 h-5 text-gray-900" fill="currentColor" viewBox="0 0 20 20">
                <path d="M2 3a1 1 0 011-1h6a1 1 0 011 1v2a1 1 0 01-1 1H3a1 1 0 01-1-1V3zM2 9a1 1 0 011-1h6a1 1 0 011 1v2a1 1 0 01-1 1H3a1 1 0 01-1-1V9zm0 6a1 1 0 011-1h6a1 1 0 011 1v2a1 1 0 01-1 1H3a1 1 0 01-1-1v-2zM11 3a1 1 0 110 2h6a1 1 0 110 2h-6a1 1 0 110-2h6zM11 9a1 1 0 110 2h6a1 1 0 110 2h-6a1 1 0 110-2h6zm0 6a1 1 0 110 2h6a1 1 0 110 2h-6a1 1 0 110-2h6z" />
              </svg>
            </div>
          `}
          <div class="min-w-0 flex-1">
            <p class="font-semibold text-white truncate text-left">${escapeHtml(playlist.name)}</p>
            <p class="text-sm text-gray-400 truncate">${playlist.track_count} tracks</p>
          </div>
        </div>
        <svg class="w-5 h-5 text-gray-400 group-hover:text-cyan-400 flex-shrink-0 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
    `).join('');

    modalContent.innerHTML = `
      <div>
        <h3 class="text-lg font-bold text-cyan-400 mb-4">Add to Playlist</h3>
        <p class="text-gray-400 text-sm mb-4">Track: <span class="text-white font-semibold">${escapeHtml(trackName)}</span></p>
        <div class="space-y-2 max-h-96 overflow-y-auto">
          ${playlistsHtml}
        </div>
        <button onclick="document.getElementById('artistModal').style.display='none'" class="mt-4 w-full px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded font-semibold transition">
          Cancel
        </button>
      </div>
    `;
  }

  function addTrackToPlaylist(playlistId, trackUri, playlistName, trackName) {
    /**
     * Add a track to a playlist
     */
    fetch('/music/api/playlists/add-track/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({
        playlist_id: playlistId,
        track_uris: [trackUri]
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        showNotification(`Added to ${escapeHtml(playlistName)}`, 'success');
        document.getElementById('artistModal').style.display = 'none';
      } else {
        showNotification(data.message || 'Failed to add track', 'error');
      }
    })
    .catch(error => {
      console.error('Error adding track to playlist:', error);
      showNotification('Failed to add track to playlist', 'error');
    });
  }

  // ==================== Color Extraction ====================

  function extractDominantColor(img) {
    /**
     * Extracts the single most dominant color from an image.
     * This color represents the most prevalent hue/tone in the image.
     */
    try {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      canvas.width = 150;
      canvas.height = 150;
      ctx.drawImage(img, 0, 0, 150, 150);

      const imageData = ctx.getImageData(0, 0, 150, 150).data;
      const colorMap = {};

      // Quantize colors to reduce noise (group similar colors together)
      for (let i = 0; i < imageData.length; i += 4) {
        const r = Math.floor(imageData[i] / 25) * 25;      // 25 = step size (0-255 becomes 0-10 buckets)
        const g = Math.floor(imageData[i + 1] / 25) * 25;
        const b = Math.floor(imageData[i + 2] / 25) * 25;
        const key = `${r},${g},${b}`;
        colorMap[key] = (colorMap[key] || 0) + 1;
      }

      // Find the single most frequent color
      let dominantColor = 'rgb(26, 26, 46)';  // fallback
      let maxCount = 0;

      for (const [color, count] of Object.entries(colorMap)) {
        if (count > maxCount) {
          const [r, g, b] = color.split(',').map(Number);
          const brightness = (r * 299 + g * 587 + b * 114) / 1000;

          // Only accept colors that are not too dark (< 20) or too bright (> 240)
          if (brightness > 20 && brightness < 240) {
            maxCount = count;
            dominantColor = `rgb(${r}, ${g}, ${b})`;
          }
        }
      }

      return dominantColor;
    } catch (error) {
      console.error('Color extraction error:', error);
      return 'rgb(26, 26, 46)';
    }
  }

  function extractDominantColors(img, numColors = 3) {
    /**
     * Extracts multiple dominant colors for gradient variations.
     * Returns: [dominantColor, accentColor1, accentColor2]
     */
    try {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      canvas.width = 100;
      canvas.height = 100;
      ctx.drawImage(img, 0, 0, 100, 100);
      const imageData = ctx.getImageData(0, 0, 100, 100).data;

      const colorMap = {};
      for (let i = 0; i < imageData.length; i += 4) {
        const r = Math.floor(imageData[i] / 32) * 32;
        const g = Math.floor(imageData[i + 1] / 32) * 32;
        const b = Math.floor(imageData[i + 2] / 32) * 32;
        const key = `${r},${g},${b}`;
        colorMap[key] = (colorMap[key] || 0) + 1;
      }

      const sortedColors = Object.entries(colorMap)
        .sort((a, b) => b[1] - a[1])
        .slice(0, numColors * 4)
        .filter(([color]) => {
          const [r, g, b] = color.split(',').map(Number);
          const brightness = (r * 299 + g * 587 + b * 114) / 1000;
          const saturation = Math.max(r, g, b) - Math.min(r, g, b);
          return brightness > 15 && brightness < 220 && saturation > 10;
        })
        .slice(0, numColors)
        .map(([color]) => {
          const [r, g, b] = color.split(',').map(Number);
          return `rgb(${r}, ${g}, ${b})`;
        });

      return sortedColors.length > 0 ? sortedColors : ['rgb(26, 26, 46)', 'rgb(22, 33, 62)', 'rgb(15, 52, 96)'];
    } catch (error) {
      console.error('Color extraction error:', error);
      return ['rgb(26, 26, 46)', 'rgb(22, 33, 62)', 'rgb(15, 52, 96)'];
    }
  }

  function applyDynamicBackground() {
    const albumArt = document.getElementById('albumArt');
    const dynamicBg = document.getElementById('dynamicBg');

    if (!albumArt || !dynamicBg) return;

    const updateBackground = () => {
      // Get the single dominant color (most prevalent in the image)
      const dominantColor = extractDominantColor(albumArt);

      // Get accent colors for variation
      const accentColors = extractDominantColors(albumArt, 3);

      // Use dominant color as the primary background color
      // This makes the background match the cover's primary hue almost perfectly
      const gradient = `
        radial-gradient(circle at 20% 80%, ${dominantColor} 0%, ${accentColors[1] || dominantColor} 40%, transparent 70%),
        radial-gradient(circle at 80% 20%, ${accentColors[1] || dominantColor} 0%, transparent 50%),
        linear-gradient(135deg, ${dominantColor} 0%, ${accentColors[0] || dominantColor} 50%, ${accentColors[2] || dominantColor} 100%)
      `;

      dynamicBg.style.background = gradient;
      dynamicBg.style.backgroundColor = dominantColor;  // Fallback solid color

      console.log('Dynamic background:', {
        dominant: dominantColor,
        accents: accentColors
      });
    };

    if (albumArt.complete) {
      updateBackground();
    } else {
      albumArt.onload = updateBackground;
    }
  }

  // ==================== Playback State Management ====================

  function updatePlaybackState() {
    fetch('{% url "music:playback_state" %}')
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          // Update progress
          const duration = data.duration_ms || 0;
          const progress = data.progress_ms || 0;
          const percentage = duration > 0 ? (progress / duration * 100) : 0;

          document.getElementById('progressFill').style.width = percentage + '%';
          document.getElementById('currentTime').textContent = formatTime(progress);
          document.getElementById('duration').textContent = formatTime(duration);

          // Update play/pause button
          const playPauseBtn = document.getElementById('playPauseBtn');
          const vinylRecord = document.getElementById('vinylRecord');

          if (data.is_playing) {
            playPauseBtn.innerHTML = '<span class="iconify text-3xl" data-icon="mdi:pause"></span>';
            vinylRecord.classList.add('playing');
          } else {
            playPauseBtn.innerHTML = '<span class="iconify text-3xl" data-icon="mdi:play"></span>';
            vinylRecord.classList.remove('playing');
          }

          // Update track info if changed
          const trackName = document.getElementById('trackName');
          const artistName = document.getElementById('artistName');
          const albumNameDisplay = document.getElementById('albumNameDisplay');
          const albumArt = document.getElementById('albumArt');

          if (trackName && data.track_name) {
            trackName.textContent = data.track_name;
          }
          if (artistName && data.artist_name) {
            artistName.textContent = data.artist_name;
          }
          if (albumNameDisplay && data.album_name) {
            albumNameDisplay.textContent = data.album_name;
          }

          // Update album art if URL changed
          if (albumArt && data.album_image_url && albumArt.src !== data.album_image_url) {
            albumArt.src = data.album_image_url;
            setTimeout(() => applyDynamicBackground(), 100);
          }
        }
      })
      .catch(error => console.error('Playback state error:', error));
  }

  // ==================== Playback Controls ====================

  function getActiveDeviceId() {
    const activeDevice = document.querySelector('.device-item.active');
    return activeDevice ? activeDevice.getAttribute('data-device-id') : null;
  }

  function showDeviceSelector(devices) {
    /**
     * Show a modal to select a device for playback
     */
    const modal = document.getElementById('artistModal');
    const modalContent = document.getElementById('artistModalContent');

    if (!modal || !modalContent) {
      console.error('Modal elements not found');
      return;
    }

    const devicesHtml = devices.map((device) => `
      <div class="flex items-center gap-3 p-4 bg-gray-800 rounded hover:bg-gray-700 transition cursor-pointer" onclick="selectDeviceAndPlay('${escapeSingleQuotes(device.id)}')">
        <div class="w-10 h-10 rounded flex items-center justify-center flex-shrink-0 ${device.is_active ? 'bg-cyan-500' : 'bg-gray-700'}">
          ${device.type === 'Smartphone' ? `
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v12a1 1 0 01-1 1H4a1 1 0 01-1-1V4z" />
            </svg>
          ` : `
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path d="M2 5a2 2 0 012-2h12a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V5zm14 0H4v8h12V5z" />
            </svg>
          `}
        </div>
        <div class="flex-1 min-w-0">
          <p class="font-semibold text-white">${escapeHtml(device.name)}</p>
          <p class="text-sm text-gray-400">${escapeHtml(device.type)}${device.is_active ? ' • Active' : ''}</p>
        </div>
      </div>
    `).join('');

    modalContent.innerHTML = `
      <div class="space-y-3">
        <h3 class="text-lg font-bold text-cyan-400 mb-4">Select a Device</h3>
        ${devicesHtml}
      </div>
    `;

    modal.style.display = 'flex';
    modalContent.scrollTop = 0;
  }

  function selectDeviceAndPlay(deviceId) {
    /**
     * Select a device and play the pending track or playlist
     */
    const modal = document.getElementById('artistModal');
    if (modal) {
      modal.style.display = 'none';
    }

    // Transfer playback to device
    fetch('{% url "music:transfer_playback" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: `device_id=${deviceId}`
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        // Update active device indicator
        document.querySelectorAll('.device-item').forEach(item => {
          item.classList.remove('active');
          if (item.getAttribute('data-device-id') === deviceId) {
            item.classList.add('active');
          }
        });

        // Play pending track or playlist
        const syroPlayer = window.syroPlayer || {};
        if (syroPlayer.pendingTrackUri) {
          playTrackOnDevice(syroPlayer.pendingTrackUri, deviceId);
          delete syroPlayer.pendingTrackUri;
        } else if (syroPlayer.pendingPlaylistUri) {
          playPlaylistOnDevice(syroPlayer.pendingPlaylistUri, syroPlayer.pendingPlaylistName, deviceId);
          delete syroPlayer.pendingPlaylistUri;
          delete syroPlayer.pendingPlaylistName;
        }
      } else {
        showNotification('Failed to switch device', 'error');
      }
    })
    .catch(error => {
      console.error('Error selecting device:', error);
      showNotification('Failed to switch device', 'error');
    });
  }

  function togglePlayPause() {
    const deviceId = getActiveDeviceId();

    fetch('{% url "music:play_pause" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: `device_id=${deviceId || ''}`
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        updatePlaybackState();
      }
    });
  }

  function nextTrack() {
    const deviceId = getActiveDeviceId();

    fetch('{% url "music:next_track" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: `device_id=${deviceId || ''}`
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        setTimeout(() => {
          updatePlaybackState();
          applyDynamicBackground();
        }, 500);
      }
    });
  }

  function previousTrack() {
    const deviceId = getActiveDeviceId();

    fetch('{% url "music:previous_track" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: `device_id=${deviceId || ''}`
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        setTimeout(() => {
          updatePlaybackState();
          applyDynamicBackground();
        }, 500);
      }
    });
  }

  function setVolume(volume) {
    document.getElementById('volumeValue').textContent = volume + '%';
    const deviceId = getActiveDeviceId();

    fetch('{% url "music:set_volume" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: `volume=${volume}&device_id=${deviceId || ''}`
    });
  }

  function transferPlayback(deviceId) {
    fetch('{% url "music:transfer_playback" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: `device_id=${deviceId}`
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        document.querySelectorAll('.device-item').forEach(item => {
          item.classList.remove('active');
        });
        event.target.closest('.device-item').classList.add('active');
      }
    });
  }

  function toggleShuffle() {
    const btn = document.getElementById('shuffleBtn');
    const isActive = btn.classList.contains('active');
    const deviceId = getActiveDeviceId();

    fetch('{% url "music:set_shuffle" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: `state=${!isActive}&device_id=${deviceId || ''}`
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        btn.classList.toggle('active');
      }
    });
  }

  function toggleRepeat() {
    const btn = document.getElementById('repeatBtn');
    const currentMode = btn.getAttribute('data-repeat-mode') || 'off';
    const modes = ['off', 'context', 'track'];
    const nextMode = modes[(modes.indexOf(currentMode) + 1) % modes.length];
    const deviceId = getActiveDeviceId();

    fetch('{% url "music:set_repeat" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: `mode=${nextMode}&device_id=${deviceId || ''}`
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        btn.setAttribute('data-repeat-mode', nextMode);
        btn.classList.toggle('active', nextMode !== 'off');

        // Update icon based on mode
        if (nextMode === 'track') {
          btn.innerHTML = '<span class="iconify text-xl" data-icon="mdi:repeat-once"></span>';
        } else {
          btn.innerHTML = '<span class="iconify text-xl" data-icon="mdi:repeat"></span>';
        }
      }
    });
  }

  // Progress bar seek
  document.getElementById('progressBar')?.addEventListener('click', function(e) {
    const rect = this.getBoundingClientRect();
    const percent = (e.clientX - rect.left) / rect.width;
    const durationText = document.getElementById('duration').textContent.split(':');
    const duration = (parseInt(durationText[0]) * 60 + parseInt(durationText[1])) * 1000;
    const positionMs = percent * duration;
    const deviceId = getActiveDeviceId();

    fetch('{% url "music:seek" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: `position_ms=${Math.floor(positionMs)}&device_id=${deviceId || ''}`
    })
    .then(() => updatePlaybackState());
  });

  // ==================== Search Functionality ====================

  function setupPlayerSearch() {
    const searchInput = document.getElementById('playerSearchInput');
    const resultsDiv = document.getElementById('playerSearchResults');

    let searchTimeout;
    let abortController = null;

    function debounceSearch() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(performPlayerSearch, 300);
    }

    searchInput.addEventListener('input', (e) => {
      const query = e.target.value.trim();

      if (query.length === 0) {
        resultsDiv.innerHTML = '';
        if (abortController) {
          abortController.abort();
          abortController = null;
        }
        return;
      }

      debounceSearch();
    });

    searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        clearTimeout(searchTimeout);
        performPlayerSearch();
      }
    });

    function performPlayerSearch() {
      const query = searchInput.value.trim();

      if (query.length < 2) {
        resultsDiv.innerHTML = '';
        return;
      }

      if (abortController) {
        abortController.abort();
      }
      abortController = new AbortController();

      resultsDiv.innerHTML = `
        <div class="text-center py-8">
          <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-green-500 mb-2"></div>
          <div class="text-gray-400">Searching...</div>
        </div>
      `;

      console.log('Searching for:', query);
      console.log('CSRF Token:', getCsrfToken());
      console.log('Fetch URL:', `/music/api/search/?q=${encodeURIComponent(query)}`);

      fetch(`/music/api/search/?q=${encodeURIComponent(query)}`, {
        method: 'GET',
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        signal: abortController.signal
      })
        .then(response => {
          console.log('Search response status:', response.status);
          console.log('Search response headers:', [...response.headers.entries()]);
          console.log('Search response OK:', response.ok);
          console.log('Search response redirected:', response.redirected);
          
          if (response.redirected) {
            throw new Error('Request was redirected - you may not be logged in');
          }
          
          if (!response.ok) {
            return response.text().then(text => {
              console.error('Error response body:', text);
              throw new Error(`HTTP ${response.status}: ${text || 'Search failed'}`);
            });
          }
          return response.json();
        })
        .then(data => {
          console.log('Search results data:', data);
          console.log('Songs count:', data?.songs?.length);
          console.log('Artists count:', data?.artists?.length);
          console.log('Albums count:', data?.albums?.length);
          abortController = null;

          if (!data || typeof data !== 'object') {
            throw new Error('Invalid response format');
          }

          renderSearchResults(data);
        })
        .catch(error => {
          if (error.name === 'AbortError') {
            return;
          }

          console.error('Search error:', error);
          resultsDiv.innerHTML = `
            <div class="text-center py-8">
              <span class="iconify text-4xl text-red-400 mb-2" data-icon="mdi:alert-circle"></span>
              <div class="text-gray-400">Search failed. Please try again.</div>
              <div class="text-sm text-gray-500 mt-1">${escapeHtml(error.message || 'Unknown error')}</div>
            </div>
          `;
        });
    }

    function renderSearchResults(data) {
      console.log('Rendering search results:', data);
      console.log('Data type:', typeof data);
      console.log('Data keys:', Object.keys(data));
      
      const songs = Array.isArray(data?.songs) ? data.songs.filter(Boolean) : [];
      const artists = Array.isArray(data?.artists) ? data.artists.filter(Boolean) : [];
      const albums = Array.isArray(data?.albums) ? data.albums.filter(Boolean) : [];

      console.log('Songs array:', songs);
      console.log('Songs length:', songs.length);
      console.log('Artists length:', artists.length);
      console.log('Albums length:', albums.length);

      const totalResults = songs.length + artists.length + albums.length;
      console.log('Total results:', totalResults);

      if (totalResults === 0) {
        console.log('No results - showing empty state');
        resultsDiv.innerHTML = `
          <div class="text-center py-8">
            <span class="iconify text-4xl text-gray-500 mb-2" data-icon="mdi:music-note-off"></span>
            <div class="text-gray-400">No results found</div>
            <div class="text-sm text-gray-500 mt-1">Try a different search term</div>
          </div>
        `;
        return;
      }

      let html = '';

      if (songs.length > 0) {
        html += `
          <div class="search-section mb-4">
            <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider px-4 py-2 bg-white/5">
              Songs (${songs.length})
            </h3>
            <div class="search-section-items">
              ${songs.map((song, idx) => {
                try {
                  console.log(`Rendering song ${idx}:`, song);
                  return renderSongResult(song);
                } catch (e) {
                  console.error('Error rendering song:', song, e);
                  return '';
                }
              }).filter(Boolean).join('')}
            </div>
          </div>
        `;
      }

      if (artists.length > 0) {
        html += `
          <div class="search-section mb-4">
            <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider px-4 py-2 bg-white/5">
              Artists (${artists.length})
            </h3>
            <div class="search-section-items">
              ${artists.map(artist => {
                try {
                  return renderArtistResult(artist);
                } catch (e) {
                  console.error('Error rendering artist:', artist, e);
                  return '';
                }
              }).filter(Boolean).join('')}
            </div>
          </div>
        `;
      }

      if (albums.length > 0) {
        html += `
          <div class="search-section mb-4">
            <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider px-4 py-2 bg-white/5">
              Albums (${albums.length})
            </h3>
            <div class="search-section-items">
              ${albums.map(album => {
                try {
                  return renderAlbumResult(album);
                } catch (e) {
                  console.error('Error rendering album:', album, e);
                  return '';
                }
              }).filter(Boolean).join('')}
            </div>
          </div>
        `;
      }

      resultsDiv.innerHTML = html;
      console.log('Search results rendered successfully');
    }

    function renderSongResult(song) {
      if (!song || typeof song !== 'object') {
        return '';
      }

      const title = String(song.title || 'Unknown Song').trim();
      const spotifyId = String(song.spotify_id || '').trim();
      let trackUri = String(song.uri || '').trim();

      if (!trackUri && spotifyId) {
        trackUri = `spotify:track:${spotifyId}`;
      }

      if (!trackUri) {
        console.warn('Song missing valid URI:', song);
        return '';
      }

      // Handle artist and album from search API (flat structure)
      const artistName = String(song.artist || 'Unknown Artist').trim();
      const albumTitle = String(song.album || 'Unknown Album').trim();
      const albumCover = String(song.cover_url || '').trim();

      const safeUri = escapeHtml(trackUri);
      const safeTitle = escapeHtml(title);
      const safeArtist = escapeHtml(artistName);
      const safeAlbum = escapeHtml(albumTitle);
      const safeCover = escapeHtml(albumCover);

      return `
        <div class="search-result-item song-result">
          <div class="flex items-center gap-3">
            ${albumCover ? `
              <img
                src="${safeCover}"
                alt="${safeAlbum}"
                class="w-12 h-12 rounded flex-shrink-0 object-cover"
                onerror="this.style.display='none'"
                loading="lazy"
              />
            ` : `
              <div class="w-12 h-12 rounded flex-shrink-0 bg-white/10 flex items-center justify-center flex-shrink-0">
                <span class="iconify text-xl text-gray-500" data-icon="mdi:music"></span>
              </div>
            `}
            <div class="flex-1 min-w-0">
              <div class="font-semibold text-white truncate">${safeTitle}</div>
              <div class="text-sm text-gray-400 truncate">${safeArtist} • ${safeAlbum}</div>
            </div>
            <div class="flex gap-2 flex-shrink-0">
              <button
                class="control-btn !w-10 !h-10"
                onclick="playTrackFromSearch('${safeUri}');"
                title="Play"
                type="button"
              >
                <span class="iconify text-lg" data-icon="mdi:play"></span>
              </button>
              <button
                class="control-btn !w-10 !h-10"
                onclick="addToQueueFromSearch('${safeUri}', {title: '${escapeHtml(title)}', artist: '${safeArtist}', album: '${safeAlbum}'});"
                title="Add to Queue"
                type="button"
              >
                <span class="iconify text-lg" data-icon="mdi:playlist-plus"></span>
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderArtistResult(artist) {
      if (!artist || typeof artist !== 'object') {
        return '';
      }

      const name = String(artist.name || 'Unknown Artist').trim();
      const imageUrl = String(artist.image_url || '').trim();
      const artistId = String(artist.id || '').trim();

      if (!name) {
        return '';
      }

      const safeName = escapeHtml(name);
      const safeImage = escapeHtml(imageUrl);

      return `
        <div class="search-result-item artist-result" onclick="openArtistModal('${escapeSingleQuotes(safeName)}', '${escapeSingleQuotes(safeImage)}', '${escapeSingleQuotes(artistId)}')">
          <div class="flex items-center gap-3 cursor-pointer hover:bg-white/10 transition-colors">
            ${imageUrl ? `
              <img
                src="${safeImage}"
                alt="${safeName}"
                class="w-12 h-12 rounded-full flex-shrink-0 object-cover"
                onerror="this.style.display='none'"
                loading="lazy"
              />
            ` : `
              <div class="w-12 h-12 rounded-full flex-shrink-0 bg-white/10 flex items-center justify-center">
                <span class="iconify text-xl text-gray-500" data-icon="mdi:account-music"></span>
              </div>
            `}
            <div class="flex-1 min-w-0">
              <div class="font-semibold text-white truncate">${safeName}</div>
              <div class="text-sm text-gray-400">Artist</div>
            </div>
            <span class="iconify text-xl text-gray-500 flex-shrink-0" data-icon="mdi:chevron-right"></span>
          </div>
        </div>
      `;
    }

    function renderAlbumResult(album) {
      if (!album || typeof album !== 'object') {
        return '';
      }

      const title = String(album.title || 'Unknown Album').trim();
      const artistName = String(
        (album.artist && album.artist.name) ||
        album.artist ||
        'Unknown Artist'
      ).trim();
      const coverUrl = String(album.cover_url || album.image_url || '').trim();
      const albumId = String(album.id || '').trim();

      let releaseYear = '';
      if (album.release_date) {
        try {
          releaseYear = new Date(album.release_date).getFullYear();
        } catch (e) {
          console.warn('Invalid release date:', album.release_date);
        }
      }

      if (!title) {
        return '';
      }

      const safeTitle = escapeHtml(title);
      const safeArtist = escapeHtml(artistName);
      const safeCover = escapeHtml(coverUrl);

      return `
        <div class="search-result-item album-result" onclick="openAlbumModal('${escapeSingleQuotes(safeTitle)}', '${escapeSingleQuotes(safeCover)}', '${escapeSingleQuotes(albumId)}')">
          <div class="flex items-center gap-3 cursor-pointer hover:bg-white/10 transition-colors">
            ${coverUrl ? `
              <img
                src="${safeCover}"
                alt="${safeTitle}"
                class="w-12 h-12 rounded flex-shrink-0 object-cover"
                onerror="this.style.display='none'"
                loading="lazy"
              />
            ` : `
              <div class="w-12 h-12 rounded flex-shrink-0 bg-white/10 flex items-center justify-center">
                <span class="iconify text-xl text-gray-500" data-icon="mdi:album"></span>
              </div>
            `}
            <div class="flex-1 min-w-0">
              <div class="font-semibold text-white truncate">${safeTitle}</div>
              <div class="text-sm text-gray-400 truncate">
                ${safeArtist}${releaseYear ? ` • ${releaseYear}` : ''}
              </div>
            </div>
            <span class="iconify text-xl text-gray-500 flex-shrink-0" data-icon="mdi:chevron-right"></span>
          </div>
        </div>
      `;
    }

    window.playTrackFromSearch = function(trackUri) {
      if (!trackUri || typeof trackUri !== 'string' || trackUri.trim() === '') {
        console.error('Invalid track URI provided:', trackUri);
        showNotification('Invalid track selected', 'error');
        return;
      }
      playTrack(trackUri);
    };

    window.addToQueueFromSearch = function(trackUri, trackInfo) {
      if (!trackUri || typeof trackUri !== 'string' || trackUri.trim() === '') {
        console.error('Invalid track URI provided:', trackUri);
        showNotification('Invalid track selected', 'error');
        return;
      }
      addToQueue(trackUri, trackInfo || {});
    };
  }

  function playTrack(trackUri) {
    console.log('Playing track:', trackUri);
    const deviceId = getActiveDeviceId();

    // If no active device, try web player or fetch devices
    if (!deviceId) {
      console.log('No active device, checking for web player...');

      // Try to use the web playback SDK if available (global deviceId variable)
      if (typeof player !== 'undefined' && player && typeof window.deviceId !== 'undefined' && window.deviceId) {
        console.log('Using web player');
        playTrackOnWebPlayer(trackUri);
        return;
      }

      // Fallback: fetch available devices
      fetch('{% url "music:get_devices" %}')
        .then(response => response.json())
        .then(data => {
          if (!data.devices || data.devices.length === 0) {
            // No devices available, try web player
            if (typeof player !== 'undefined' && player) {
              console.log('No devices found, using web player');
              playTrackOnWebPlayer(trackUri);
            } else {
              showNotification('No Spotify devices or web player available. Make sure Spotify is running or enable browser playback.', 'error');
            }
            return;
          }

          // Find active device
          const activeDevice = data.devices.find(d => d.is_active);
          if (activeDevice) {
            // Play directly on active device
            playTrackOnDevice(trackUri, activeDevice.id);
          } else {
            // Show device selector
            window.syroPlayer = window.syroPlayer || {};
            window.syroPlayer.pendingTrackUri = trackUri;
            showDeviceSelector(data.devices);
          }
        })
        .catch(error => {
          console.error('Error fetching devices:', error);
          // Fallback to web player
          if (typeof player !== 'undefined' && player) {
            console.log('Device fetch failed, using web player');
            playTrackOnWebPlayer(trackUri);
          } else {
            showNotification('Failed to fetch devices and no web player available', 'error');
          }
        });
      return;
    }

    playTrackOnDevice(trackUri, deviceId);
  }

  // Play track using Spotify Web Playback SDK
  function playTrackOnWebPlayer(trackUri) {
    if (typeof player === 'undefined' || !player) {
      showNotification('Web player not available. Please refresh the page.', 'error');
      return;
    }

    if (typeof window.deviceId === 'undefined' || !window.deviceId) {
      showNotification('Web player device not ready. Please wait a moment and try again.', 'error');
      return;
    }

    // Use Spotify API to play on the web player device
    fetch('{% url "music:play_track" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        track_uri: trackUri,
        device_id: window.deviceId  // Use the web player device ID
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        showNotification('Now playing on browser', 'success');
        updatePlaybackState();
      } else {
        showNotification(data.message || 'Failed to play track', 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showNotification('Error playing track on web player', 'error');
    });
  }

  function playTrackOnDevice(trackUri, deviceId) {
    fetch('{% url "music:play_track" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        track_uri: trackUri,
        device_id: deviceId
      })
    })
    .then(response => response.json())
    .then(data => {
      console.log('Play track response:', data);
      if (data.status === 'success') {
        showNotification('Now playing', 'success');
        setTimeout(() => {
          updatePlaybackState();
          applyDynamicBackground();
        }, 500);
      } else {
        showNotification(data.message || 'Failed to play track', 'error');
      }
    })
    .catch(error => {
      console.error('Play track error:', error);
      showNotification('Failed to play track', 'error');
    });
  }

  function addToQueue(trackUri, trackInfo = {}) {
    fetch('{% url "music:add_to_queue" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        track_uri: trackUri,
        track_info: trackInfo
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        // Show success message
        showNotification(data.message, 'success');
        // Update queue display
        updateQueueDisplay();
      } else {
        showNotification(data.message || 'Failed to add to queue', 'error');
      }
    })
    .catch(error => {
      console.error('Add to queue error:', error);
      showNotification('Failed to add to queue', 'error');
    });
  }

  function updateQueueDisplay() {
    fetch('{% url "music:get_queue" %}')
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          const queueContainer = document.getElementById('queueContainer');
          const queueLength = data.queue_length || 0;
          
          if (queueLength > 0) {
            queueContainer.innerHTML = `
              <div class="space-y-2">
                <div class="flex justify-between items-center mb-2">
                  <p class="text-gray-400 text-sm">${queueLength} track${queueLength !== 1 ? 's' : ''} in queue</p>
                  <button 
                    onclick="clearQueue()"
                    class="text-xs text-red-400 hover:text-red-300 transition-colors"
                  >
                    Clear Queue
                  </button>
                </div>
                <div class="max-h-60 overflow-y-auto space-y-2">
                  ${data.queue.slice(0, 10).map((track, index) => `
                    <div class="flex items-center gap-2 p-2 rounded bg-white/5 hover:bg-white/10 transition-colors">
                      ${track.album_image ? `
                        <img src="${escapeHtml(track.album_image)}" alt="" class="w-10 h-10 rounded flex-shrink-0" />
                      ` : `
                        <div class="w-10 h-10 rounded flex-shrink-0 bg-white/10 flex items-center justify-center">
                          <span class="iconify text-gray-500" data-icon="mdi:music"></span>
                        </div>
                      `}
                      <div class="flex-1 min-w-0">
                        <div class="text-sm font-medium text-white truncate">${escapeHtml(track.name)}</div>
                        <div class="text-xs text-gray-400 truncate">${escapeHtml(track.artists)}</div>
                      </div>
                      <span class="text-xs text-gray-500">${formatTime(track.duration_ms)}</span>
                    </div>
                  `).join('')}
                  ${queueLength > 10 ? `
                    <div class="text-center text-xs text-gray-500 py-2">
                      +${queueLength - 10} more track${queueLength - 10 !== 1 ? 's' : ''}
                    </div>
                  ` : ''}
                </div>
              </div>
            `;
          } else {
            queueContainer.innerHTML = '<p class="text-center text-gray-500 py-4">Queue is empty</p>';
          }
        }
      })
      .catch(error => {
        console.error('Get queue error:', error);
      });
  }

  function clearQueue() {
    if (!confirm('Are you sure you want to clear the queue?')) {
      return;
    }

    fetch('{% url "music:clear_queue" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        showNotification('Queue cleared', 'success');
        updateQueueDisplay();
      }
    })
    .catch(error => {
      console.error('Clear queue error:', error);
      showNotification('Failed to clear queue', 'error');
    });
  }

  // Search result playback functions
  function playTrackFromSearch(trackUri) {
    console.log('Playing track from search:', trackUri);
    if (!trackUri) {
      showNotification('Invalid track', 'error');
      return;
    }
    
    // Close search results
    const resultsDiv = document.getElementById('playerSearchResults');
    if (resultsDiv) {
      resultsDiv.innerHTML = '';
    }
    const searchInput = document.getElementById('playerSearchInput');
    if (searchInput) {
      searchInput.value = '';
    }
    
    // Play the track using existing playTrack function
    playTrack(trackUri);
  }

  function addToQueueFromSearch(trackUri, trackInfo) {
    console.log('Adding track to queue from search:', trackUri, trackInfo);
    if (!trackUri) {
      showNotification('Invalid track', 'error');
      return;
    }
    
    // Add to queue using existing addToQueue function
    addToQueue(trackUri, trackInfo);
  }

  // ==================== Device Selection ====================

  async function selectDevice(deviceId, deviceName) {
    console.log('Selecting device:', deviceId, deviceName);
    
    try {
        const response = await fetch('/music/api/playback/transfer/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ 
                device_id: deviceId 
            })
        });

        const data = await response.json();
        
        if (response.ok) {
            console.log('Successfully transferred to device:', deviceName);
            showNotification(`Switched to ${deviceName}`, 'success');
            
            // Close the device modal
            document.getElementById('deviceModal').classList.add('hidden');
            
            // Refresh devices to show active device
            setTimeout(() => {
                loadDevices();
            }, 1000);
            
            // Refresh playback state
            setTimeout(() => {
                updatePlayer();
            }, 1500);
        } else {
            console.error('Device transfer failed:', data.error);
            showNotification(`Failed to switch device: ${data.error}`, 'error');
        }
    } catch (error) {
        console.error('Error selecting device:', error);
        showNotification('Error switching device', 'error');
    }
  }

  // Add function to show notifications
  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    const bgClass = type === 'success' ? 'border-green-500/30 text-green-200' :
                    type === 'error' ? 'border-red-500/30 text-red-200' :
                    'border-blue-500/30 text-blue-200';

    notification.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg z-50 font-satoshi border backdrop-blur-md bg-black/40 shadow-lg ${bgClass}`;
    notification.textContent = message;

    // Add fade-in animation
    notification.style.animation = 'fadeIn 0.3s ease-in';

    document.body.appendChild(notification);

    setTimeout(() => {
        notification.style.animation = 'fadeOut 0.3s ease-out forwards';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
  }

  // ==================== Spotify Web Playback SDK ====================

  // Initialize player and deviceId as window properties for global access
  window.player = null;
  window.deviceId = null;

  function initializeSpotifyPlayer() {
    window.onSpotifyWebPlaybackSDKReady = () => {
      const token = '{{ spotify_user.access_token }}';

      console.log('Spotify SDK Ready - Token present:', !!token);
      console.log('Spotify SDK Ready - Token length:', token ? token.length : 0);

      if (!token || token.trim() === '') {
        console.error('No valid access token available for Spotify Player');
        showNotification('Spotify player unavailable - authentication issue', 'error');
        return;
      }

      console.log('Initializing Spotify Web Playback SDK...');

      window.player = new Spotify.Player({
        name: 'Syro Web Player',
        getOAuthToken: cb => {
          console.log('Token requested by SDK, providing token');
          cb(token);
        },
        volume: 0.5
      });

      console.log('Spotify Player created successfully');

      // Error handling
      window.player.addListener('initialization_error', ({ message }) => {
        console.error('Initialization Error:', message);
      });

      window.player.addListener('authentication_error', ({ message }) => {
        console.error('Authentication Error:', message);
      });

      window.player.addListener('account_error', ({ message }) => {
        console.error('Account Error:', message);
      });

      window.player.addListener('playback_error', ({ message }) => {
        console.error('Playback Error:', message);
      });

      // Playback status updates
      window.player.addListener('player_state_changed', state => {
        if (!state) return;
        console.log('Player state changed:', state);
        updatePlaybackState();
      });

      // Ready - capture device ID for browser playback
      window.player.addListener('ready', ({ device_id }) => {
        console.log('Ready with Device ID', device_id);
        window.deviceId = device_id;
        console.log('Web player device ready for playback:', device_id);
      });

      // Connect to the player
      console.log('Attempting to connect Spotify Player...');
      window.player.connect().then(success => {
        if (success) {
          console.log('✓ The Web Playback SDK successfully connected to Spotify!');
          showNotification('Spotify web player connected', 'success');
        } else {
          console.error('✗ Failed to connect Spotify Web Playback SDK');
          showNotification('Failed to connect Spotify player', 'error');
        }
      }).catch(error => {
        console.error('Error connecting to Spotify:', error);
        showNotification('Spotify connection error: ' + error.message, 'error');
      });
    };
  }

  // ==================== Initialization ====================

  document.addEventListener('DOMContentLoaded', function() {
    // Apply dynamic background on load
    applyDynamicBackground();

    // Update playback state
    updatePlaybackState();

    // Update queue display
    updateQueueDisplay();

    // Update playback state every 2 seconds
    setInterval(updatePlaybackState, 2000);

    // Update queue display every 10 seconds
    setInterval(updateQueueDisplay, 10000);

    // Setup search functionality
    setupPlayerSearch();

    // Check if Spotify SDK is available
    if (typeof Spotify === 'undefined') {
      console.error('Spotify Web Playback SDK not loaded - script may not have loaded');
      showNotification('Spotify SDK failed to load', 'error');
    } else {
      console.log('✓ Spotify Web Playback SDK is available');
      // Initialize Spotify Web Playback SDK for browser-based playback
      // This allows playback without needing a Spotify device
      initializeSpotifyPlayer();
    }

    // Hide Spotify modal UI after SDK is loaded (wait 1s for SDK to inject elements)
    setTimeout(() => {
      // Only remove the "Now Playing" modal, not the actual player
      document.querySelectorAll(
        'div[class*="now-playing"], div[id*="now-playing"], ' +
        'div[class*="now_playing"], div[id*="now_playing"]'
      ).forEach(el => {
        console.log('Hiding Spotify Now Playing modal:', el);
        el.style.display = 'none';
        el.style.visibility = 'hidden';
      });
    }, 2000);

    // Initialize new features
    initializeAdvancedFeatures();
  });

  // ==================== Remove Spotify SDK Elements ====================
  // DISABLED: This was too aggressive and broke the player
  // Using CSS-based hiding instead (see player.html styles)
  function removeSpotifySDKElements() {
    // Function kept for backwards compatibility but disabled
    console.log('removeSpotifySDKElements: Using CSS hiding instead');
  }

  /* ==================== Advanced Features Initialization ==================== */
  function initializeAdvancedFeatures() {
    // Search history on search
    const searchForm = document.querySelector('form[action*="search"]');
    if (searchForm) {
      searchForm.addEventListener('submit', function() {
        const query = this.querySelector('input[name="q"]').value;
        SearchHistory.save(query);
      });
    }

    // Track lyrics button
    const lyricsButton = document.querySelector('#lyrics-button');
    if (lyricsButton) {
      lyricsButton.addEventListener('click', async function() {
        const trackId = document.querySelector('[data-spotify-track-id]')?.dataset.spotifyTrackId;
        const trackName = document.querySelector('#current-track-name')?.textContent;
        if (trackId && trackName) {
          await TrackLyrics.showModal(trackName, trackId);
        }
      });
    }

    // Visualizer style selector
    const visualizerSelect = document.querySelector('#visualizer-style');
    if (visualizerSelect) {
      visualizerSelect.addEventListener('change', function() {
        AudioVisualizer.setStyle(this.value);
      });
    }

    // Analytics dashboard
    const analyticsContainer = document.querySelector('#analytics-dashboard');
    if (analyticsContainer) {
      PlaybackAnalytics.displayDashboard('analytics-dashboard');
    }

    // Queue reordering
    const queueContainer = document.querySelector('#queue-container');
    if (queueContainer) {
      SmartQueue.renderQueue('queue-container');
    }

    console.log('Advanced features initialized');
  }

  /* ==================== Lyrics Functions ==================== */
  let currentTrackId = null;
  let currentTrackName = null;
  let currentArtistName = null;

  // Update track info when playback state changes
  function updateCurrentTrackInfo() {
    const trackNameEl = document.getElementById('trackName');
    const artistNameEl = document.getElementById('artistName');
    
    if (trackNameEl) {
      currentTrackName = trackNameEl.textContent;
    }
    if (artistNameEl) {
      currentArtistName = artistNameEl.textContent;
    }
    
    // Try to extract track ID from Spotify data if available
    // This will be set when we fetch current playback state
  }

  async function toggleLyrics() {
    updateCurrentTrackInfo();
    
    if (!currentTrackName || !currentArtistName) {
      alert('No track is currently playing');
      return;
    }
    
    await fetchAndShowLyrics(currentTrackName, currentArtistName, currentTrackId);
  }

  async function fetchAndShowLyrics(trackName, artistName, spotifyTrackId = null) {
    const modal = document.getElementById('lyricsModal');
    const content = document.getElementById('lyricsContent');
    const trackNameEl = document.getElementById('lyricsTrackName');
    const artistNameEl = document.getElementById('lyricsArtistName');
    const sourceEl = document.getElementById('lyricsSource');
    
    // Show modal with loading state
    modal.style.display = 'flex';
    trackNameEl.textContent = trackName;
    artistNameEl.textContent = artistName;
    content.innerHTML = `
      <div style="text-align: center; padding: 3rem 1rem;">
        <div style="display: inline-block; width: 40px; height: 40px; border: 3px solid rgba(16, 185, 129, 0.4); border-top-color: rgba(16, 185, 129, 1); border-radius: 50%; animation: spin 1s linear infinite; box-shadow: 0 0 20px rgba(16, 185, 129, 0.6);"></div>
        <p style="margin-top: 1rem; color: rgba(16, 185, 129, 0.8);">Loading lyrics...</p>
      </div>
    `;
    sourceEl.innerHTML = '';
    
    try {
      // Build query parameters
      let url = `/api/v1/lyrics/?track_name=${encodeURIComponent(trackName)}&artist_name=${encodeURIComponent(artistName)}`;
      if (spotifyTrackId) {
        url += `&spotify_track_id=${encodeURIComponent(spotifyTrackId)}`;
      }
      
      const response = await fetch(url, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        credentials: 'same-origin'
      });
      
      const data = await response.json();
      
      if (data.status === 'success' && data.data && data.data.lyrics) {
        // Format lyrics with better styling
        const formattedLyrics = data.data.lyrics
          .replace(/\n\n/g, '</p><p style="margin: 1.5rem 0;"></p>')
          .replace(/\n/g, '<br>');
        content.innerHTML = `<p style="margin: 0;">${formattedLyrics}</p>`;
        sourceEl.innerHTML = `<span style="color: rgba(16, 185, 129, 0.8);">✦ Lyrics provided by <strong>${data.data.source || 'Genius'}</strong> ✦</span>`;
      } else {
        content.innerHTML = `
          <div style="text-align: center; padding: 3rem 1rem;">
            <p style="color: rgba(16, 185, 129, 0.6); font-size: 1.2rem; margin-bottom: 1rem;">✗</p>
            <p style="color: rgba(255, 255, 255, 0.8);">Lyrics not available for this track</p>
            <p style="color: rgba(16, 185, 129, 0.6); font-size: 0.9rem; margin-top: 1rem;">Try searching on <a href="https://genius.com" target="_blank" style="color: rgba(16, 185, 129, 0.9); text-decoration: none; font-weight: 600; border-bottom: 1px solid rgba(16, 185, 129, 0.5);">Genius.com</a></p>
          </div>
        `;
        sourceEl.innerHTML = '';
      }
    } catch (error) {
      console.error('Error fetching lyrics:', error);
      content.innerHTML = `
        <div style="text-align: center; padding: 3rem 1rem;">
          <p style="color: rgba(255, 107, 157, 0.8); font-size: 1.2rem; margin-bottom: 1rem;">⚠️</p>
          <p style="color: rgba(255, 255, 255, 0.7);">Error loading lyrics</p>
          <p style="color: rgba(255, 255, 255, 0.5); font-size: 0.9rem; margin-top: 0.5rem;">${error.message}</p>
        </div>
      `;
      sourceEl.innerHTML = '';
    }
  }

  function closeLyricsModal() {
    const modal = document.getElementById('lyricsModal');
    modal.style.display = 'none';
  }

  // Close modal when clicking outside
  document.addEventListener('click', function(event) {
    const lyricsModal = document.getElementById('lyricsModal');
    if (event.target === lyricsModal) {
      closeLyricsModal();
    }
  });

  // Update track info periodically
  setInterval(updateCurrentTrackInfo, 5000);
</script>
<script src="{% static 'js/features.js' %}"></script>

<!-- Device Selection Modal -->
{% include 'syromusic/player_modal.html' %}
{% endblock content %}
