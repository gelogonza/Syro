{% extends 'base.html' %}

{% block title %}Sonic Aura - Your Music Vibe {% endblock title %}

{% block extra_css %}
<style>
  /* Premium Sonic Aura Styling */
  .sonic-aura-container {
    max-width: 900px;
    margin: 0 auto;
  }

  .sonic-aura-title {
    font-size: 3.5rem;
    font-weight: 900;
    margin-bottom: 12px;
    background: linear-gradient(135deg, #10b981 0%, #34d399 50%, #6ee7b7 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -0.02em;
  }

  .sonic-aura-subtitle {
    font-size: 1.1rem;
    color: rgba(255, 255, 255, 0.6);
    margin-bottom: 40px;
  }

  /* Vibe Receipt Card Premium Styling */
  #vibeReceipt {
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .vibe-score-circle {
    animation: pulse-glow 2s ease-in-out infinite;
  }

  @keyframes pulse-glow {
    0%, 100% {
      filter: drop-shadow(0 0 20px rgba(16, 185, 129, 0.3));
    }
    50% {
      filter: drop-shadow(0 0 40px rgba(16, 185, 129, 0.6));
    }
  }

  /* Action Buttons Premium Style */
  .vibe-action-btn {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-weight: 600;
    border-radius: 12px;
  }

  .vibe-action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
  }

  .vibe-action-btn.primary {
    background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
    color: #0a0a0a;
  }

  .vibe-action-btn.secondary {
    background: transparent;
    border: 2px solid #10b981;
    color: #10b981;
  }

  .vibe-action-btn.secondary:hover {
    background: rgba(16, 185, 129, 0.1);
  }

  /* Share Modal Premium */
  #shareModal {
    animation: fade-in 0.3s ease-in-out;
  }

  @keyframes fade-in {
    from {
      opacity: 0;
      backdrop-filter: blur(0px);
    }
    to {
      opacity: 1;
      backdrop-filter: blur(4px);
    }
  }

  .share-option-btn {
    transition: all 0.2s ease;
  }

  .share-option-btn:hover {
    transform: translateX(4px);
  }

  /* Stats Bars Premium */
  .stat-bar {
    height: 8px;
    border-radius: 4px;
    background: rgba(255, 255, 255, 0.1);
    overflow: hidden;
  }

  .stat-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #10b981 0%, #34d399 100%);
    border-radius: 4px;
    transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Loading State Enhancement */
  .loading-spinner {
    animation: spin 2s linear infinite;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  /* Error State Enhancement */
  .error-icon {
    animation: shake 0.5s ease-in-out;
  }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
  }
</style>
{% endblock extra_css %}

{% block content %}
<div class="sonic-aura-container">
  <div class="mb-12">
    <h1 class="sonic-aura-title">Sonic Aura</h1>
    <p class="sonic-aura-subtitle">Discover your music vibe and share your sonic personality</p>
  </div>

  <!-- Loading State -->
  <div id="loadingState" class="glass rounded-2xl p-12 border border-primary/20 text-center">
    <div class="inline-block mb-6">
      <div class="loading-spinner w-16 h-16 rounded-full border-4 border-primary border-t-accent"></div>
    </div>
    <h2 class="text-2xl font-bold mb-2">Analyzing your music...</h2>
    <p class="text-muted-foreground">Processing your last 50 tracks</p>
  </div>

<!-- Vibe Receipt Card -->
<div id="vibeCard" class="hidden">
  <div id="vibeReceipt" class="max-w-md mx-auto mb-8 rounded-2xl overflow-hidden shadow-2xl" style="background: linear-gradient(135deg, #1a1a2e 0%, var(--mood-color) 100%);">
    <!-- Card Header -->
    <div class="p-8 text-white text-center">
      <div class="text-sm font-semibold text-white/60 mb-4 tracking-widest">SONIC AURA</div>
      <h2 class="text-3xl font-bold mb-4">Your Music Vibe</h2>

      <!-- Vibe Score Display -->
      <div class="flex items-center justify-center mb-8">
        <div class="relative w-32 h-32 vibe-score-circle">
          <svg class="absolute inset-0 w-full h-full transform -rotate-90" viewBox="0 0 100 100">
            <!-- Background circle -->
            <circle cx="50" cy="50" r="45" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="3"/>
            <!-- Progress circle -->
            <circle cx="50" cy="50" r="45" fill="none" stroke="rgba(255,255,255,0.8)" stroke-width="3"
                    stroke-dasharray="141.3" stroke-dashoffset="0" id="scoreCircle" style="transition: stroke-dashoffset 1s ease-out;"/>
          </svg>
          <div class="absolute inset-0 flex items-center justify-center">
            <div class="text-center">
              <div class="text-4xl font-bold text-white" id="vibeScoreDisplay">0</div>
              <div class="text-xs text-white/70">vibe</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Top Genre -->
      <div class="mb-6">
        <div class="text-xs text-white/60 mb-2 tracking-widest">TOP GENRE</div>
        <div class="text-2xl font-bold text-white capitalize" id="topGenreDisplay">â€”</div>
      </div>

      <!-- Audio Features Grid -->
      <div class="grid grid-cols-3 gap-3 mb-6">
        <div class="backdrop-blur-sm bg-white/10 rounded-lg p-3">
          <div class="text-white/60 text-xs mb-1">ENERGY</div>
          <div class="text-xl font-bold text-white" id="energyDisplay">0.00</div>
        </div>
        <div class="backdrop-blur-sm bg-white/10 rounded-lg p-3">
          <div class="text-white/60 text-xs mb-1">DANCE</div>
          <div class="text-xl font-bold text-white" id="danceDisplay">0.00</div>
        </div>
        <div class="backdrop-blur-sm bg-white/10 rounded-lg p-3">
          <div class="text-white/60 text-xs mb-1">MOOD</div>
          <div class="text-xl font-bold text-white" id="valenceDisplay">0.00</div>
        </div>
      </div>

      <!-- Footer -->
      <div class="text-xs text-white/50">
        <div>Generated with Syro Music</div>
        <div id="trackCountDisplay">Last 50 tracks analyzed</div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="max-w-md mx-auto mb-8 flex gap-4">
    <button onclick="downloadVibeReceipt()" class="vibe-action-btn primary flex-1 px-6 py-3">
      <span class="iconify h-5 w-5 mr-2 inline" data-icon="mdi:download"></span>
      Download
    </button>
    <button onclick="shareVibeReceipt()" class="vibe-action-btn secondary flex-1 px-6 py-3">
      <span class="iconify h-5 w-5 mr-2 inline" data-icon="mdi:share-variant"></span>
      Share
    </button>
  </div>

  <!-- Share Options Modal -->
  <div id="shareModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-secondary rounded-2xl p-8 max-w-sm w-full mx-4 border border-border">
      <h3 class="text-2xl font-bold mb-4">Share Your Sonic Aura</h3>

      <div class="space-y-3 mb-6">
        <button onclick="shareToTwitter()" class="share-option-btn w-full px-4 py-3 rounded-lg bg-blue-500/20 text-blue-400 font-medium hover:bg-blue-500/30 transition-all flex items-center justify-center gap-2">
          <span class="iconify h-5 w-5" data-icon="mdi:twitter"></span>
          Share on Twitter
        </button>
        <button onclick="shareToInstagram()" class="share-option-btn w-full px-4 py-3 rounded-lg bg-pink-500/20 text-pink-400 font-medium hover:bg-pink-500/30 transition-all flex items-center justify-center gap-2">
          <span class="iconify h-5 w-5" data-icon="mdi:instagram"></span>
          Share on Instagram
        </button>
        <button onclick="copyToClipboard()" class="share-option-btn w-full px-4 py-3 rounded-lg bg-green-500/20 text-green-400 font-medium hover:bg-green-500/30 transition-all flex items-center justify-center gap-2">
          <span class="iconify h-5 w-5" data-icon="mdi:content-copy"></span>
          Copy Link
        </button>
      </div>

      <button onclick="closeShareModal()" class="w-full px-4 py-3 rounded-lg bg-border text-muted-foreground font-medium hover:bg-border/80 transition-all">
        Cancel
      </button>
    </div>
  </div>

  <!-- Stats Details -->
  <div class="mt-12 grid md:grid-cols-2 gap-6">
    <div class="glass rounded-2xl p-6 border border-primary/20">
      <h3 class="text-lg font-semibold mb-4">Your Sonic Profile</h3>
      <div class="space-y-4">
        <div>
          <div class="flex justify-between mb-2">
            <span class="text-muted-foreground text-sm">Energy Level</span>
            <span class="text-white font-semibold" id="energyFullDisplay">0.00</span>
          </div>
          <div class="stat-bar">
            <div class="stat-bar-fill" id="energyBar" style="width: 0%;"></div>
          </div>
        </div>
        <div>
          <div class="flex justify-between mb-2">
            <span class="text-muted-foreground text-sm">Danceability</span>
            <span class="text-white font-semibold" id="danceFullDisplay">0.00</span>
          </div>
          <div class="stat-bar">
            <div class="stat-bar-fill" id="danceBar" style="width: 0%;"></div>
          </div>
        </div>
        <div>
          <div class="flex justify-between mb-2">
            <span class="text-muted-foreground text-sm">Valence (Positivity)</span>
            <span class="text-white font-semibold" id="valenceFullDisplay">0.00</span>
          </div>
          <div class="stat-bar">
            <div class="stat-bar-fill" id="valenceBar" style="width: 0%;"></div>
          </div>
        </div>
        <div>
          <div class="flex justify-between mb-2">
            <span class="text-muted-foreground text-sm">Acousticness</span>
            <span class="text-white font-semibold" id="acousticFullDisplay">0.00</span>
          </div>
          <div class="stat-bar">
            <div class="stat-bar-fill" id="acousticBar" style="width: 0%;"></div>
          </div>
        </div>
        <div>
          <div class="flex justify-between mb-2">
            <span class="text-muted-foreground text-sm">Instrumentalness</span>
            <span class="text-white font-semibold" id="instrumentalFullDisplay">0.00</span>
          </div>
          <div class="stat-bar">
            <div class="stat-bar-fill" id="instrumentalBar" style="width: 0%;"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="glass rounded-2xl p-6 border border-primary/20">
      <h3 class="text-lg font-semibold mb-4">What Your Vibe Means</h3>
      <div id="vibeInterpretation" class="text-muted-foreground space-y-3 text-sm">
        <p>Analyzing your sonic personality...</p>
      </div>
    </div>
  </div>
</div>

<!-- Error State -->
<div id="errorState" class="hidden glass rounded-2xl p-12 border border-red-500/20 text-center">
  <div class="inline-flex items-center justify-center h-20 w-20 rounded-full bg-red-500/10 mb-6">
    <i data-lucide="alert-circle" class="h-10 w-10 text-red-500"></i>
  </div>
  <h2 class="text-2xl font-bold mb-3">Unable to Load Your Sonic Aura</h2>
  <p class="text-muted-foreground mb-6" id="errorMessage">Please try again later</p>
  <button onclick="loadSonicAura()" class="px-6 py-3 rounded-lg bg-gradient-to-r from-primary to-accent text-black font-semibold hover-glow">
    Try Again
  </button>
</div>

<script>
  // Set CSS variable for mood color
  document.documentElement.style.setProperty('--mood-color', '#1a1a2e');

  // Notification system
  function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg transition-all transform translate-x-0 ${
      type === 'success' ? 'bg-gradient-to-r from-primary to-accent text-black' : 'bg-red-500 text-white'
    }`;
    notification.innerHTML = `
      <div class="flex items-center gap-2">
        <span class="iconify h-5 w-5" data-icon="${type === 'success' ? 'mdi:check-circle' : 'mdi:alert-circle'}"></span>
        <span class="font-medium">${message}</span>
      </div>
    `;
    document.body.appendChild(notification);

    setTimeout(() => {
      notification.style.transform = 'translateX(400px)';
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }

  // Load Sonic Aura data
  async function loadSonicAura() {
    const loadingState = document.getElementById('loadingState');
    const vibeCard = document.getElementById('vibeCard');
    const errorState = document.getElementById('errorState');

    // Show loading state
    loadingState.classList.remove('hidden');
    vibeCard.classList.add('hidden');
    errorState.classList.add('hidden');

    try {
      const response = await fetch('/music/api/sonic-aura/', {
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest',
        }
      });

      if (!response.ok) {
        const data = await response.json();
        throw new Error(data.message || 'Failed to load Sonic Aura');
      }

      const data = await response.json();
      displaySonicAura(data.data);

    } catch (error) {
      console.error('Error loading Sonic Aura:', error);
      document.getElementById('errorMessage').textContent = error.message;
      loadingState.classList.add('hidden');
      errorState.classList.remove('hidden');
    }
  }

  // Display Sonic Aura data
  function displaySonicAura(data) {
    const moodColor = data.mood_color;
    const vibeScore = data.vibe_score;

    // Update CSS variable
    document.documentElement.style.setProperty('--mood-color', moodColor);

    // Update all display values
    document.getElementById('vibeScoreDisplay').textContent = vibeScore;
    document.getElementById('topGenreDisplay').textContent = data.top_genre;
    document.getElementById('trackCountDisplay').textContent = `${data.track_count} tracks analyzed`;

    // Energy
    document.getElementById('energyDisplay').textContent = data.energy.toFixed(2);
    document.getElementById('energyFullDisplay').textContent = data.energy.toFixed(2);
    document.getElementById('energyBar').style.width = `${data.energy * 100}%`;

    // Danceability
    document.getElementById('danceDisplay').textContent = data.danceability.toFixed(2);
    document.getElementById('danceFullDisplay').textContent = data.danceability.toFixed(2);
    document.getElementById('danceBar').style.width = `${data.danceability * 100}%`;

    // Valence
    document.getElementById('valenceDisplay').textContent = data.valence.toFixed(2);
    document.getElementById('valenceFullDisplay').textContent = data.valence.toFixed(2);
    document.getElementById('valenceBar').style.width = `${data.valence * 100}%`;

    // Acousticness
    document.getElementById('acousticFullDisplay').textContent = data.acousticness.toFixed(2);
    document.getElementById('acousticBar').style.width = `${data.acousticness * 100}%`;

    // Instrumentalness
    document.getElementById('instrumentalFullDisplay').textContent = data.instrumentalness.toFixed(2);
    document.getElementById('instrumentalBar').style.width = `${data.instrumentalness * 100}%`;

    // Animate score circle
    const scoreCircle = document.getElementById('scoreCircle');
    const circumference = 2 * Math.PI * 45; // radius = 45
    const offset = circumference - (vibeScore / 100) * circumference;
    scoreCircle.style.strokeDashoffset = offset;

    // Generate interpretation
    generateVibeInterpretation(data);

    // Show card
    document.getElementById('loadingState').classList.add('hidden');
    document.getElementById('vibeCard').classList.remove('hidden');
  }

  // Generate detailed vibe interpretation
  function generateVibeInterpretation(data) {
    const score = data.vibe_score;
    const energy = data.energy;
    const dance = data.danceability;
    const valence = data.valence;
    const acoustic = data.acousticness;
    const instrumental = data.instrumentalness;
    const genre = data.top_genre;

    let vibeType = '';
    if (score >= 80) {
      vibeType = 'ðŸ”¥ High-Vibe Listener';
    } else if (score >= 60) {
      vibeType = 'âš¡ Balanced Energy';
    } else if (score >= 40) {
      vibeType = 'ðŸŒ™ Laid-Back Listener';
    } else {
      vibeType = 'ðŸŽ§ Deep Listener';
    }

    let description = `<strong>${vibeType}</strong><br>`;

    // Energy analysis
    if (energy > 0.7) {
      description += `You're drawn to powerful, driving tracks that command attention. `;
    } else if (energy > 0.5) {
      description += `You enjoy a balanced mix of energetic and mellow sounds. `;
    } else {
      description += `You prefer subtle, laid-back production with intricate details. `;
    }

    // Danceability analysis
    if (dance > 0.7) {
      description += `Your music is perfect for movement and rhythm. `;
    } else if (dance > 0.5) {
      description += `You mix groovy, rhythmic tracks with more complex arrangements. `;
    } else {
      description += `You appreciate music with unconventional rhythms and structures. `;
    }

    // Mood analysis
    if (valence > 0.7) {
      description += `Your overall mood is optimistic and uplifting! ðŸ˜Š `;
    } else if (valence > 0.4) {
      description += `You balance happy, feel-good tracks with deeper, emotional ones. `;
    } else {
      description += `You're drawn to introspective, moody, and atmospheric music. `;
    }

    // Acoustic analysis
    if (acoustic > 0.6) {
      description += `Acoustic instruments are central to your soundâ€”organic and intimate. `;
    } else if (acoustic > 0.3) {
      description += `You enjoy a mix of organic and electronic production. `;
    } else {
      description += `You gravitate toward produced, electronic, and synthesized sounds. `;
    }

    // Genre insight
    const genreInsights = {
      'pop': 'accessible, mainstream melodies with broad appeal',
      'rock': 'powerful instrumentation with attitude and energy',
      'hip-hop': 'rhythmic, lyric-driven tracks with cultural weight',
      'electronic': 'synthesized soundscapes and digital production',
      'indie': 'experimental, boundary-pushing, and authentic sounds',
      'rnb': 'smooth grooves and soulful vocals',
      'classical': 'complex arrangements and timeless compositions',
      'jazz': 'improvisational freedom and sophisticated harmonies',
      'country': 'storytelling and acoustic authenticity',
      'reggae': 'relaxed vibes and infectious rhythms'
    };

    const genreLower = genre.toLowerCase();
    const insight = Object.keys(genreInsights).find(key => genreLower.includes(key));
    const genreDesc = insight ? genreInsights[insight] : 'eclectic and diverse sounds';

    description += `<br><br><strong>Your Genre:</strong> <em>${genre}</em> brings you ${genreDesc}. This is your sonic signature.`;

    document.getElementById('vibeInterpretation').innerHTML = description;
  }

  // Download Vibe Receipt
  async function downloadVibeReceipt() {
    try {
      showNotification('Preparing download...', 'success');

      // Need to install html2canvas via CDN
      const script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
      document.head.appendChild(script);

      script.onload = async () => {
        const element = document.getElementById('vibeReceipt');
        const canvas = await html2canvas(element, {
          backgroundColor: null,
          scale: 2,
        });

        const link = document.createElement('a');
        link.href = canvas.toDataURL('image/png');
        link.download = `sonic-aura-${Date.now()}.png`;
        link.click();

        showNotification('Sonic Aura downloaded! ðŸŽµ', 'success');
      };
    } catch (error) {
      console.error('Download error:', error);
      showNotification('Failed to download. Please try again.', 'error');
    }
  }

  // Share Vibe Receipt
  function shareVibeReceipt() {
    document.getElementById('shareModal').classList.remove('hidden');
  }

  function closeShareModal() {
    document.getElementById('shareModal').classList.add('hidden');
  }

  // Social share handlers
  function shareToTwitter() {
    const text = `I just discovered my Sonic Aura! ðŸŽµ My vibe score is ${document.getElementById('vibeScoreDisplay').textContent}/100. Top genre: ${document.getElementById('topGenreDisplay').textContent}. What's your music personality? Check yours on Syro!`;
    const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(window.location.origin)}`;
    window.open(url, '_blank');
    closeShareModal();
    showNotification('Opening Twitter...', 'success');
  }

  function shareToInstagram() {
    showNotification('Download your Sonic Aura card first, then share it on Instagram Stories! ðŸ“¸', 'success');
    closeShareModal();
  }

  function copyToClipboard() {
    const text = `Check out my Sonic Aura on Syro! My vibe score is ${document.getElementById('vibeScoreDisplay').textContent}/100. ${window.location.href}`;
    navigator.clipboard.writeText(text);
    showNotification('Link copied to clipboard! ðŸ“‹', 'success');
    closeShareModal();
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', function() {
    loadSonicAura();
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
  });

  // Close modal on outside click
  document.getElementById('shareModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeShareModal();
    }
  });
</script>
{% endblock content %}
