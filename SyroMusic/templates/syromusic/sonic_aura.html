{% extends 'base.html' %}

{% block title %}Sonic Aura - Your Music Vibe {% endblock title %}

{% block content %}
<div class="mb-8">
  <h1 class="text-4xl font-bold mb-2 gradient-text">Sonic Aura</h1>
  <p class="text-muted-foreground text-lg">Discover your music vibe and share your sonic personality</p>
</div>

<!-- Loading State -->
<div id="loadingState" class="glass rounded-2xl p-12 border border-primary/20 text-center">
  <div class="inline-block mb-6">
    <div class="w-16 h-16 rounded-full border-4 border-primary border-t-accent animate-spin"></div>
  </div>
  <h2 class="text-2xl font-bold mb-2">Analyzing your music...</h2>
  <p class="text-muted-foreground">Processing your last 50 tracks</p>
</div>

<!-- Vibe Receipt Card -->
<div id="vibeCard" class="hidden">
  <div id="vibeReceipt" class="max-w-md mx-auto mb-8 rounded-2xl overflow-hidden shadow-2xl" style="background: linear-gradient(135deg, #1a1a2e 0%, var(--mood-color) 100%);">
    <!-- Card Header -->
    <div class="p-8 text-white text-center">
      <div class="text-sm font-semibold text-white/60 mb-4 tracking-widest">SONIC AURA</div>
      <h2 class="text-3xl font-bold mb-4">Your Music Vibe</h2>

      <!-- Vibe Score Display -->
      <div class="flex items-center justify-center mb-8">
        <div class="relative w-32 h-32">
          <svg class="absolute inset-0 w-full h-full transform -rotate-90" viewBox="0 0 100 100">
            <!-- Background circle -->
            <circle cx="50" cy="50" r="45" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="3"/>
            <!-- Progress circle -->
            <circle cx="50" cy="50" r="45" fill="none" stroke="rgba(255,255,255,0.8)" stroke-width="3"
                    stroke-dasharray="141.3" stroke-dashoffset="0" id="scoreCircle" style="transition: stroke-dashoffset 1s ease-out;"/>
          </svg>
          <div class="absolute inset-0 flex items-center justify-center">
            <div class="text-center">
              <div class="text-4xl font-bold text-white" id="vibeScoreDisplay">0</div>
              <div class="text-xs text-white/70">vibe</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Top Genre -->
      <div class="mb-6">
        <div class="text-xs text-white/60 mb-2 tracking-widest">TOP GENRE</div>
        <div class="text-2xl font-bold text-white capitalize" id="topGenreDisplay">â€”</div>
      </div>

      <!-- Audio Features Grid -->
      <div class="grid grid-cols-3 gap-3 mb-6">
        <div class="backdrop-blur-sm bg-white/10 rounded-lg p-3">
          <div class="text-white/60 text-xs mb-1">ENERGY</div>
          <div class="text-xl font-bold text-white" id="energyDisplay">0.00</div>
        </div>
        <div class="backdrop-blur-sm bg-white/10 rounded-lg p-3">
          <div class="text-white/60 text-xs mb-1">DANCE</div>
          <div class="text-xl font-bold text-white" id="danceDisplay">0.00</div>
        </div>
        <div class="backdrop-blur-sm bg-white/10 rounded-lg p-3">
          <div class="text-white/60 text-xs mb-1">MOOD</div>
          <div class="text-xl font-bold text-white" id="valenceDisplay">0.00</div>
        </div>
      </div>

      <!-- Footer -->
      <div class="text-xs text-white/50">
        <div>Generated with Syro Music</div>
        <div id="trackCountDisplay">Last 50 tracks analyzed</div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="max-w-md mx-auto mb-8 flex gap-4">
    <button onclick="downloadVibeReceipt()" class="flex-1 px-6 py-3 rounded-lg bg-gradient-to-r from-primary to-accent text-black font-semibold hover-glow transition-all">
      <span class="iconify h-5 w-5 mr-2 inline" data-icon="mdi:download"></span>
      Download
    </button>
    <button onclick="shareVibeReceipt()" class="flex-1 px-6 py-3 rounded-lg border-2 border-primary text-primary font-semibold hover:bg-primary/10 transition-all">
      <span class="iconify h-5 w-5 mr-2 inline" data-icon="mdi:share-variant"></span>
      Share
    </button>
  </div>

  <!-- Share Options Modal -->
  <div id="shareModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-secondary rounded-2xl p-8 max-w-sm w-full mx-4 border border-border">
      <h3 class="text-2xl font-bold mb-4">Share Your Sonic Aura</h3>

      <div class="space-y-3 mb-6">
        <button onclick="shareToTwitter()" class="w-full px-4 py-3 rounded-lg bg-blue-500/20 text-blue-400 font-medium hover:bg-blue-500/30 transition-all flex items-center justify-center gap-2">
          <span class="iconify h-5 w-5" data-icon="mdi:twitter"></span>
          Share on Twitter
        </button>
        <button onclick="shareToInstagram()" class="w-full px-4 py-3 rounded-lg bg-pink-500/20 text-pink-400 font-medium hover:bg-pink-500/30 transition-all flex items-center justify-center gap-2">
          <span class="iconify h-5 w-5" data-icon="mdi:instagram"></span>
          Share on Instagram
        </button>
        <button onclick="copyToClipboard()" class="w-full px-4 py-3 rounded-lg bg-green-500/20 text-green-400 font-medium hover:bg-green-500/30 transition-all flex items-center justify-center gap-2">
          <span class="iconify h-5 w-5" data-icon="mdi:content-copy"></span>
          Copy Link
        </button>
      </div>

      <button onclick="closeShareModal()" class="w-full px-4 py-3 rounded-lg bg-border text-muted-foreground font-medium hover:bg-border/80 transition-all">
        Cancel
      </button>
    </div>
  </div>

  <!-- Stats Details -->
  <div class="mt-12 grid md:grid-cols-2 gap-6">
    <div class="glass rounded-2xl p-6 border border-primary/20">
      <h3 class="text-lg font-semibold mb-4">Your Sonic Profile</h3>
      <div class="space-y-4">
        <div>
          <div class="flex justify-between mb-2">
            <span class="text-muted-foreground text-sm">Energy Level</span>
            <span class="text-white font-semibold" id="energyFullDisplay">0.00</span>
          </div>
          <div class="w-full h-2 bg-border rounded-full overflow-hidden">
            <div class="h-full bg-gradient-to-r from-primary to-accent rounded-full" id="energyBar" style="width: 0%;"></div>
          </div>
        </div>
        <div>
          <div class="flex justify-between mb-2">
            <span class="text-muted-foreground text-sm">Danceability</span>
            <span class="text-white font-semibold" id="danceFullDisplay">0.00</span>
          </div>
          <div class="w-full h-2 bg-border rounded-full overflow-hidden">
            <div class="h-full bg-gradient-to-r from-primary to-accent rounded-full" id="danceBar" style="width: 0%;"></div>
          </div>
        </div>
        <div>
          <div class="flex justify-between mb-2">
            <span class="text-muted-foreground text-sm">Valence (Positivity)</span>
            <span class="text-white font-semibold" id="valenceFullDisplay">0.00</span>
          </div>
          <div class="w-full h-2 bg-border rounded-full overflow-hidden">
            <div class="h-full bg-gradient-to-r from-primary to-accent rounded-full" id="valenceBar" style="width: 0%;"></div>
          </div>
        </div>
        <div>
          <div class="flex justify-between mb-2">
            <span class="text-muted-foreground text-sm">Acousticness</span>
            <span class="text-white font-semibold" id="acousticFullDisplay">0.00</span>
          </div>
          <div class="w-full h-2 bg-border rounded-full overflow-hidden">
            <div class="h-full bg-gradient-to-r from-primary to-accent rounded-full" id="acousticBar" style="width: 0%;"></div>
          </div>
        </div>
        <div>
          <div class="flex justify-between mb-2">
            <span class="text-muted-foreground text-sm">Instrumentalness</span>
            <span class="text-white font-semibold" id="instrumentalFullDisplay">0.00</span>
          </div>
          <div class="w-full h-2 bg-border rounded-full overflow-hidden">
            <div class="h-full bg-gradient-to-r from-primary to-accent rounded-full" id="instrumentalBar" style="width: 0%;"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="glass rounded-2xl p-6 border border-primary/20">
      <h3 class="text-lg font-semibold mb-4">What Your Vibe Means</h3>
      <div id="vibeInterpretation" class="text-muted-foreground space-y-3 text-sm">
        <p>Analyzing your sonic personality...</p>
      </div>
    </div>
  </div>
</div>

<!-- Error State -->
<div id="errorState" class="hidden glass rounded-2xl p-12 border border-red-500/20 text-center">
  <div class="inline-flex items-center justify-center h-20 w-20 rounded-full bg-red-500/10 mb-6">
    <i data-lucide="alert-circle" class="h-10 w-10 text-red-500"></i>
  </div>
  <h2 class="text-2xl font-bold mb-3">Unable to Load Your Sonic Aura</h2>
  <p class="text-muted-foreground mb-6" id="errorMessage">Please try again later</p>
  <button onclick="loadSonicAura()" class="px-6 py-3 rounded-lg bg-gradient-to-r from-primary to-accent text-black font-semibold hover-glow">
    Try Again
  </button>
</div>

<script>
  // Set CSS variable for mood color
  document.documentElement.style.setProperty('--mood-color', '#1a1a2e');

  // Notification system
  function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg transition-all transform translate-x-0 ${
      type === 'success' ? 'bg-gradient-to-r from-primary to-accent text-black' : 'bg-red-500 text-white'
    }`;
    notification.innerHTML = `
      <div class="flex items-center gap-2">
        <span class="iconify h-5 w-5" data-icon="${type === 'success' ? 'mdi:check-circle' : 'mdi:alert-circle'}"></span>
        <span class="font-medium">${message}</span>
      </div>
    `;
    document.body.appendChild(notification);

    setTimeout(() => {
      notification.style.transform = 'translateX(400px)';
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }

  // Load Sonic Aura data
  async function loadSonicAura() {
    const loadingState = document.getElementById('loadingState');
    const vibeCard = document.getElementById('vibeCard');
    const errorState = document.getElementById('errorState');

    // Show loading state
    loadingState.classList.remove('hidden');
    vibeCard.classList.add('hidden');
    errorState.classList.add('hidden');

    try {
      const response = await fetch('/music/api/sonic-aura/', {
        headers: {
          'Content-Type': 'application/json',
        }
      });

      if (!response.ok) {
        const data = await response.json();
        throw new Error(data.message || 'Failed to load Sonic Aura');
      }

      const data = await response.json();
      displaySonicAura(data.data);

    } catch (error) {
      console.error('Error loading Sonic Aura:', error);
      document.getElementById('errorMessage').textContent = error.message;
      loadingState.classList.add('hidden');
      errorState.classList.remove('hidden');
    }
  }

  // Display Sonic Aura data
  function displaySonicAura(data) {
    const moodColor = data.mood_color;
    const vibeScore = data.vibe_score;

    // Update CSS variable
    document.documentElement.style.setProperty('--mood-color', moodColor);

    // Update all display values
    document.getElementById('vibeScoreDisplay').textContent = vibeScore;
    document.getElementById('topGenreDisplay').textContent = data.top_genre;
    document.getElementById('trackCountDisplay').textContent = `${data.track_count} tracks analyzed`;

    // Energy
    document.getElementById('energyDisplay').textContent = data.energy.toFixed(2);
    document.getElementById('energyFullDisplay').textContent = data.energy.toFixed(2);
    document.getElementById('energyBar').style.width = `${data.energy * 100}%`;

    // Danceability
    document.getElementById('danceDisplay').textContent = data.danceability.toFixed(2);
    document.getElementById('danceFullDisplay').textContent = data.danceability.toFixed(2);
    document.getElementById('danceBar').style.width = `${data.danceability * 100}%`;

    // Valence
    document.getElementById('valenceDisplay').textContent = data.valence.toFixed(2);
    document.getElementById('valenceFullDisplay').textContent = data.valence.toFixed(2);
    document.getElementById('valenceBar').style.width = `${data.valence * 100}%`;

    // Acousticness
    document.getElementById('acousticFullDisplay').textContent = data.acousticness.toFixed(2);
    document.getElementById('acousticBar').style.width = `${data.acousticness * 100}%`;

    // Instrumentalness
    document.getElementById('instrumentalFullDisplay').textContent = data.instrumentalness.toFixed(2);
    document.getElementById('instrumentalBar').style.width = `${data.instrumentalness * 100}%`;

    // Animate score circle
    const scoreCircle = document.getElementById('scoreCircle');
    const circumference = 2 * Math.PI * 45; // radius = 45
    const offset = circumference - (vibeScore / 100) * circumference;
    scoreCircle.style.strokeDashoffset = offset;

    // Generate interpretation
    generateVibeInterpretation(data);

    // Show card
    document.getElementById('loadingState').classList.add('hidden');
    document.getElementById('vibeCard').classList.remove('hidden');
  }

  // Generate vibe interpretation
  function generateVibeInterpretation(data) {
    let interpretation = '';
    const score = data.vibe_score;
    const energy = data.energy;
    const dance = data.danceability;
    const valence = data.valence;

    if (score >= 80) {
      interpretation = `<strong>ðŸ”¥ You're a High-Vibe Listener!</strong> Your music choice is energetic and uplifting. `;
    } else if (score >= 60) {
      interpretation = `<strong>âš¡ You've Got Good Energy!</strong> Your taste is balanced with both upbeat and chill vibes. `;
    } else if (score >= 40) {
      interpretation = `<strong>ðŸŒ™ You're a Laid-Back Listener.</strong> You prefer thoughtful, mellower music. `;
    } else {
      interpretation = `<strong>ðŸŽ§ You're Into Deep Listening.</strong> Your taste is introspective and atmospheric. `;
    }

    if (dance > 0.7) {
      interpretation += `You love music you can move to.`;
    } else if (dance > 0.5) {
      interpretation += `You enjoy both rhythmic and introspective tracks.`;
    } else {
      interpretation += `You gravitate toward music with complex arrangements.`;
    }

    if (valence > 0.7) {
      interpretation += ` Your mood is consistently upbeat! ðŸ˜Š`;
    } else if (valence > 0.4) {
      interpretation += ` You enjoy a mix of happy and emotional tracks.`;
    } else {
      interpretation += ` You're drawn to moody, introspective music.`;
    }

    interpretation += `<br><br><strong>Genre Preference:</strong> Your top genre is <em>${data.top_genre}</em>, which makes up your sonic identity. This reflects your current listening patterns over the last 50 tracks.`;

    document.getElementById('vibeInterpretation').innerHTML = interpretation;
  }

  // Download Vibe Receipt
  async function downloadVibeReceipt() {
    try {
      showNotification('Preparing download...', 'success');

      // Need to install html2canvas via CDN
      const script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
      document.head.appendChild(script);

      script.onload = async () => {
        const element = document.getElementById('vibeReceipt');
        const canvas = await html2canvas(element, {
          backgroundColor: null,
          scale: 2,
        });

        const link = document.createElement('a');
        link.href = canvas.toDataURL('image/png');
        link.download = `sonic-aura-${Date.now()}.png`;
        link.click();

        showNotification('Sonic Aura downloaded! ðŸŽµ', 'success');
      };
    } catch (error) {
      console.error('Download error:', error);
      showNotification('Failed to download. Please try again.', 'error');
    }
  }

  // Share Vibe Receipt
  function shareVibeReceipt() {
    document.getElementById('shareModal').classList.remove('hidden');
  }

  function closeShareModal() {
    document.getElementById('shareModal').classList.add('hidden');
  }

  // Social share handlers
  function shareToTwitter() {
    const text = `I just discovered my Sonic Aura! ðŸŽµ My vibe score is ${document.getElementById('vibeScoreDisplay').textContent}/100. Top genre: ${document.getElementById('topGenreDisplay').textContent}. What's your music personality? Check yours on Syro!`;
    const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(window.location.origin)}`;
    window.open(url, '_blank');
    closeShareModal();
    showNotification('Opening Twitter...', 'success');
  }

  function shareToInstagram() {
    showNotification('Download your Sonic Aura card first, then share it on Instagram Stories! ðŸ“¸', 'success');
    closeShareModal();
  }

  function copyToClipboard() {
    const text = `Check out my Sonic Aura on Syro! My vibe score is ${document.getElementById('vibeScoreDisplay').textContent}/100. ${window.location.href}`;
    navigator.clipboard.writeText(text);
    showNotification('Link copied to clipboard! ðŸ“‹', 'success');
    closeShareModal();
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', function() {
    loadSonicAura();
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
  });

  // Close modal on outside click
  document.getElementById('shareModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeShareModal();
    }
  });
</script>
{% endblock content %}
