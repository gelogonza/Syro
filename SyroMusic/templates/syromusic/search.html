{% extends 'base.html' %}

{% block title %}Search Results - Syro{% endblock title %}

{% block content %}
<!-- Search Bar -->
<div class="glass rounded-2xl p-6 md:p-8 border border-primary/20 bg-gradient-to-br from-primary/10 to-accent/10 mb-8">
  <form method="get" class="flex gap-2 mb-4">
    <div class="relative flex-1">
      <span class="iconify absolute left-4 top-1/2 transform -translate-y-1/2 h-5 w-5 text-muted-foreground" data-icon="mdi:magnify"></span>
      <input type="text" 
             name="q" 
             value="{{ query }}" 
             placeholder="Search artists, albums, songs, playlists..."
             class="w-full pl-12 pr-4 py-3 bg-background/50 border border-border rounded-lg text-white placeholder-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary">
    </div>
    <button type="submit" 
            class="px-6 py-3 rounded-lg bg-gradient-to-r from-primary to-accent text-black font-semibold hover-glow flex items-center">
      <span class="iconify h-5 w-5 mr-2" data-icon="mdi:magnify"></span>
      Search
    </button>
  </form>

  <div class="flex gap-2 flex-wrap">
    <a href="{% url 'music:search' %}?q={{ query }}&type=all" 
       class="px-4 py-2 rounded-full text-sm font-medium transition-all {% if search_type == 'all' %}bg-gradient-to-r from-primary to-accent text-black{% else %}bg-muted hover:bg-muted/80{% endif %}">
      All
    </a>
    <a href="{% url 'music:search' %}?q={{ query }}&type=artist" 
       class="px-4 py-2 rounded-full text-sm font-medium transition-all {% if search_type == 'artist' %}bg-gradient-to-r from-primary to-accent text-black{% else %}bg-muted hover:bg-muted/80{% endif %}">
      Artists
    </a>
    <a href="{% url 'music:search' %}?q={{ query }}&type=album" 
       class="px-4 py-2 rounded-full text-sm font-medium transition-all {% if search_type == 'album' %}bg-gradient-to-r from-primary to-accent text-black{% else %}bg-muted hover:bg-muted/80{% endif %}">
      Albums
    </a>
    <a href="{% url 'music:search' %}?q={{ query }}&type=track" 
       class="px-4 py-2 rounded-full text-sm font-medium transition-all {% if search_type == 'track' %}bg-gradient-to-r from-primary to-accent text-black{% else %}bg-muted hover:bg-muted/80{% endif %}">
      Tracks
    </a>
    <a href="{% url 'music:search' %}?q={{ query }}&type=playlist" 
       class="px-4 py-2 rounded-full text-sm font-medium transition-all {% if search_type == 'playlist' %}bg-gradient-to-r from-primary to-accent text-black{% else %}bg-muted hover:bg-muted/80{% endif %}">
      Playlists
    </a>
  </div>
</div>

{% if query %}
  <!-- Results - Spotify Only -->
  <div class="space-y-8">



    <!-- Spotify Results -->
    {% if results.spotify_artists %}
      <div>
        <h2 class="text-2xl font-bold mb-4 flex items-center">
          <span class="iconify h-6 w-6 mr-2 text-primary" data-icon="mdi:spotify"></span>
          Artists from Spotify
        </h2>
        <div class="grid md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
          {% for artist in results.spotify_artists %}
            <button onclick="loadArtistTracks('{{ artist.id }}', '{{ artist.name|escapejs }}')"
               class="glass rounded-xl p-4 border border-border hover-glow hover:scale-105 transition-all text-center group cursor-pointer w-full">
              {% if artist.images|length > 0 %}
                {% with artist_img=artist.images|first %}
                  {% if artist_img.url %}
                    <img src="{{ artist_img.url }}" alt="{{ artist.name }}" class="h-24 w-24 mx-auto rounded-full object-cover mb-3 group-hover:scale-110 transition-transform" loading="lazy">
                  {% else %}
                    <div class="h-24 w-24 mx-auto rounded-full bg-gradient-to-br from-primary/20 to-accent/20 flex items-center justify-center mb-3 group-hover:scale-110 transition-transform">
                      <span class="iconify h-10 w-10 text-primary" data-icon="mdi:account"></span>
                    </div>
                  {% endif %}
                {% endwith %}
              {% else %}
                <div class="h-24 w-24 mx-auto rounded-full bg-gradient-to-br from-primary/20 to-accent/20 flex items-center justify-center mb-3 group-hover:scale-110 transition-transform">
                  <span class="iconify h-10 w-10 text-primary" data-icon="mdi:account"></span>
                </div>
              {% endif %}
              <div class="font-semibold line-clamp-1 group-hover:text-primary transition-colors">{{ artist.name }}</div>
              {% if artist.followers %}
                <div class="text-xs text-muted-foreground">{{ artist.followers.total|floatformat:0 }} followers</div>
              {% endif %}
            </button>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    {% if results.spotify_albums %}
      <div>
        <h2 class="text-2xl font-bold mb-4 flex items-center">
          <span class="iconify h-6 w-6 mr-2 text-primary" data-icon="mdi:spotify"></span>
          Albums from Spotify
        </h2>
        <div class="grid md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
          {% for album in results.spotify_albums %}
            <div class="glass rounded-xl p-4 border border-border hover-glow hover:scale-105 transition-all group cursor-pointer"
               onclick="loadAlbumTracks('{{ album.id }}', '{{ album.name|escapejs }}')">
              {% if album.images|length > 0 %}
                {% with album_img=album.images|first %}
                  {% if album_img.url %}
                    <img src="{{ album_img.url }}" alt="{{ album.name }}" class="aspect-square rounded-lg object-cover mb-3 group-hover:scale-105 transition-transform" loading="lazy">
                  {% else %}
                    <div class="aspect-square rounded-lg bg-gradient-to-br from-primary/20 to-accent/20 flex items-center justify-center mb-3 group-hover:scale-105 transition-transform">
                      <span class="iconify h-12 w-12 text-primary" data-icon="mdi:disc"></span>
                    </div>
                  {% endif %}
                {% endwith %}
              {% else %}
                <div class="aspect-square rounded-lg bg-gradient-to-br from-primary/20 to-accent/20 flex items-center justify-center mb-3 group-hover:scale-105 transition-transform">
                  <span class="iconify h-12 w-12 text-primary" data-icon="mdi:disc"></span>
                </div>
              {% endif %}
              <div class="font-semibold line-clamp-1 group-hover:text-primary transition-colors">{{ album.name }}</div>
              <div class="text-sm text-muted-foreground line-clamp-1">
                {% for artist in album.artists %}{{ artist.name }}{% if not forloop.last %}, {% endif %}{% endfor %}
              </div>
              <div class="mt-2 flex items-center text-sm text-primary opacity-0 group-hover:opacity-100 transition-opacity">
                <span class="iconify h-4 w-4 mr-1" data-icon="mdi:music"></span>
                View Tracks
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    {% if results.spotify_tracks %}
      <div>
        <h2 class="text-2xl font-bold mb-4 flex items-center">
          <span class="iconify h-6 w-6 mr-2 text-primary" data-icon="mdi:spotify"></span>
          Tracks from Spotify
        </h2>
        <div class="glass rounded-xl border border-border overflow-hidden">
          {% for track in results.spotify_tracks %}
            <div class="p-4 border-b border-border last:border-b-0 hover:bg-muted/50 transition-colors flex items-center justify-between group">
              <div class="flex items-center gap-3 flex-1 min-w-0">
                {% if track.album.images|length > 0 %}
                  {% with img_url=track.album.images|first %}
                    {% if img_url.url %}
                      <img src="{{ img_url.url }}" alt="{{ track.name }}" class="h-10 w-10 rounded-lg object-cover flex-shrink-0" loading="lazy">
                    {% else %}
                      <div class="h-10 w-10 rounded-lg bg-gradient-to-br from-primary/20 to-accent/20 flex items-center justify-center flex-shrink-0">
                        <span class="iconify h-5 w-5 text-primary" data-icon="mdi:music-note"></span>
                      </div>
                    {% endif %}
                  {% endwith %}
                {% else %}
                  <div class="h-10 w-10 rounded-lg bg-gradient-to-br from-primary/20 to-accent/20 flex items-center justify-center flex-shrink-0">
                    <span class="iconify h-5 w-5 text-primary" data-icon="mdi:music-note"></span>
                  </div>
                {% endif %}
                <div class="flex-1 min-w-0">
                  <div class="font-semibold line-clamp-1 group-hover:text-primary transition-colors">{{ track.name }}</div>
                  <div class="text-sm text-muted-foreground line-clamp-1">
                    {% for artist in track.artists %}{{ artist.name }}{% if not forloop.last %}, {% endif %}{% endfor %} • {{ track.album.name }}
                  </div>
                </div>
              </div>
              <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                <button onclick="playTrack('{{ track.uri }}', {
                  name: '{{ track.name|escapejs }}',
                  artist: '{% for artist in track.artists %}{{ artist.name }}{% if not forloop.last %}, {% endif %}{% endfor %}',
                  album: '{{ track.album.name|escapejs }}'
                })"
                   class="px-4 py-2 rounded-lg bg-gradient-to-r from-primary to-accent text-white font-medium text-sm hover-glow flex-shrink-0">
                  <span class="iconify h-4 w-4 mr-1 inline" data-icon="mdi:play"></span>
                  Play
                </button>
                <button onclick="addToQueue('{{ track.uri }}', '{{ track.name|escapejs }}')"
                   class="px-4 py-2 rounded-lg border border-primary text-primary font-medium text-sm hover:bg-primary/10 flex-shrink-0">
                  <span class="iconify h-4 w-4 mr-1 inline" data-icon="mdi:playlist-plus"></span>
                  Queue
                </button>
                <button onclick="openAddToPlaylistModal(null, '{{ track.id }}', '{{ track.name|escapejs }}', 'spotify')"
                   class="px-4 py-2 rounded-lg border border-accent text-accent font-medium text-sm hover:bg-accent/10 flex-shrink-0">
                  <span class="iconify h-4 w-4 mr-1 inline" data-icon="mdi:playlist-music"></span>
                  Playlist
                </button>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    {% if results.spotify_playlists %}
      <div>
        <h2 class="text-2xl font-bold mb-4 flex items-center">
          <span class="iconify h-6 w-6 mr-2 text-primary" data-icon="mdi:spotify"></span>
          Playlists from Spotify
        </h2>
        <div class="grid md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
          {% for playlist in results.spotify_playlists %}
            <a href="{{ playlist.external_urls.spotify }}" target="_blank" rel="noopener noreferrer"
               class="glass rounded-xl p-4 border border-border hover-glow hover:scale-105 transition-all group">
              {% if playlist.images|length > 0 %}
                {% with playlist_img=playlist.images|first %}
                  {% if playlist_img.url %}
                    <img src="{{ playlist_img.url }}" alt="{{ playlist.name }}" class="aspect-square rounded-lg object-cover mb-3 group-hover:scale-105 transition-transform" loading="lazy">
                  {% else %}
                    <div class="aspect-square rounded-lg bg-gradient-to-br from-primary/20 to-accent/20 flex items-center justify-center mb-3 group-hover:scale-105 transition-transform">
                      <span class="iconify h-12 w-12 text-primary" data-icon="mdi:playlist-play"></span>
                    </div>
                  {% endif %}
                {% endwith %}
              {% else %}
                <div class="aspect-square rounded-lg bg-gradient-to-br from-primary/20 to-accent/20 flex items-center justify-center mb-3 group-hover:scale-105 transition-transform">
                  <span class="iconify h-12 w-12 text-primary" data-icon="mdi:playlist-play"></span>
                </div>
              {% endif %}
              <div class="font-semibold line-clamp-1 group-hover:text-primary transition-colors">{{ playlist.name }}</div>
              <div class="text-sm text-muted-foreground line-clamp-1">{{ playlist.tracks.total }} tracks</div>
            </a>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    {% if not results.artists and not results.albums and not results.songs and not results.playlists and not results.spotify_artists and not results.spotify_albums and not results.spotify_tracks and not results.spotify_playlists %}
      <div class="glass rounded-2xl p-12 border border-border text-center">
        <div class="inline-flex items-center justify-center h-20 w-20 rounded-full bg-gradient-to-br from-primary/20 to-accent/20 mb-6">
          <span class="iconify h-10 w-10 text-primary" data-icon="mdi:magnify-close"></span>
        </div>
        <h2 class="text-2xl font-bold mb-3">No results found for "{{ query }}"</h2>
        <p class="text-muted-foreground">Try searching with different keywords or filters</p>
      </div>
    {% endif %}
  </div>

{% else %}
  <div class="glass rounded-2xl p-12 border border-border text-center">
    <div class="inline-flex items-center justify-center h-20 w-20 rounded-full bg-gradient-to-br from-primary/20 to-accent/20 mb-6">
      <span class="iconify h-10 w-10 text-primary" data-icon="mdi:magnify"></span>
    </div>
    <h2 class="text-2xl font-bold mb-3">Start Searching</h2>
    <p class="text-muted-foreground mb-8">Use the search bar above to find artists, albums, songs, and playlists</p>
    
    <p class="text-center text-sm text-muted-foreground">Start typing above to discover music on Spotify</p>
  </div>
{% endif %}

<!-- Add to Playlist Modal -->
<div id="addToPlaylistModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
  <div class="glass rounded-xl p-6 max-w-md w-full mx-4 border border-border">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-xl font-bold">Add to Playlist</h3>
      <button onclick="closeAddToPlaylistModal()" class="p-2 rounded-lg hover:bg-secondary transition">
        <span class="iconify h-5 w-5" data-icon="mdi:close"></span>
      </button>
    </div>
    
    <div class="mb-4">
      <p class="text-sm text-muted-foreground mb-2">Track: <span id="modalTrackName" class="font-semibold"></span></p>
    </div>
    
    <!-- Create New Playlist Section -->
    <div class="mb-6">
      <h4 class="font-semibold mb-2">Create New Playlist</h4>
      <input type="text" id="newPlaylistName" placeholder="Playlist name" 
             class="w-full px-4 py-2 rounded-lg border border-border bg-background mb-2">
      <textarea id="newPlaylistDescription" placeholder="Description (optional)" 
                class="w-full px-4 py-2 rounded-lg border border-border bg-background mb-2 resize-none" rows="2"></textarea>
      <button onclick="createAndAddToPlaylist()" 
              class="w-full px-4 py-2 rounded-lg bg-gradient-to-r from-primary to-accent text-white font-medium hover-glow">
        <span class="iconify h-4 w-4 mr-1 inline" data-icon="mdi:plus"></span>
        Create & Add Track
      </button>
    </div>
    
    <!-- Add to Existing Playlist Section -->
    <div>
      <h4 class="font-semibold mb-2">Add to Existing Playlist</h4>
      <div id="playlistsList" class="space-y-2 max-h-48 overflow-y-auto">
        <p class="text-sm text-muted-foreground">Loading playlists...</p>
      </div>
    </div>
  </div>
</div>

{% endblock content %}

{% block extra_js %}
<script>
  let currentSongId = null;
  let currentSpotifyId = null;
  let currentTrackName = null;
  let currentSource = null;
  let userPlaylists = [];

  // Notification system
  function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg transition-all transform translate-x-0 ${
      type === 'success' ? 'bg-gradient-to-r from-primary to-accent text-black' : 'bg-red-500 text-white'
    }`;
    notification.innerHTML = `
      <div class="flex items-center gap-2">
        <span class="iconify h-5 w-5" data-icon="${type === 'success' ? 'mdi:check-circle' : 'mdi:alert-circle'}"></span>
        <span class="font-medium">${message}</span>
      </div>
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.style.transform = 'translateX(400px)';
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }

  // Add to queue function
  async function addToQueue(trackUri, trackName) {
    try {
      const response = await fetch('/music/api/playback/queue/add/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
          track_uri: trackUri
        })
      });
      
      if (response.ok) {
        showNotification(`"${trackName}" added to queue!`, 'success');
      } else {
        const data = await response.json();
        showNotification(data.error || 'Failed to add to queue', 'error');
      }
    } catch (error) {
      console.error('Error adding to queue:', error);
      showNotification('Failed to add to queue. Please try again.', 'error');
    }
  }

  async function playTrack(trackUri) {
    try {
      const response = await fetch('/music/api/playback/play/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
          uris: [trackUri]
        })
      });
      
      if (response.ok) {
        // Redirect to player page
        window.location.href = '{% url "music:player" %}';
      } else {
        const data = await response.json();
        alert('Error playing track: ' + (data.error || 'Unknown error'));
      }
    } catch (error) {
      console.error('Error playing track:', error);
      alert('Failed to play track. Please make sure you have an active Spotify session.');
    }
  }

  async function playAlbum(albumUri) {
    try {
      const response = await fetch('/music/api/playback/play/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
          context_uri: albumUri
        })
      });
      
      if (response.ok) {
        // Redirect to player page
        window.location.href = '{% url "music:player" %}';
      } else {
        const data = await response.json();
        alert('Error playing album: ' + (data.error || 'Unknown error'));
      }
    } catch (error) {
      console.error('Error playing album:', error);
      alert('Failed to play album. Please make sure you have an active Spotify session.');
    }
  }

  async function fetchUserPlaylists() {
    try {
      const response = await fetch('/music/api/playlists/');
      
      if (response.ok) {
        const data = await response.json();
        userPlaylists = data.playlists || [];
        displayPlaylists();
      } else {
        document.getElementById('playlistsList').innerHTML = 
          '<p class="text-sm text-muted-foreground">Error loading playlists</p>';
      }
    } catch (error) {
      console.error('Error fetching playlists:', error);
      document.getElementById('playlistsList').innerHTML = 
        '<p class="text-sm text-muted-foreground">Error loading playlists</p>';
    }
  }

  function displayPlaylists() {
    const container = document.getElementById('playlistsList');
    
    if (userPlaylists.length === 0) {
      container.innerHTML = '<p class="text-sm text-muted-foreground">No playlists yet. Create one above!</p>';
      return;
    }
    
    container.innerHTML = userPlaylists.map(playlist => `
      <button onclick="addToExistingPlaylist(${playlist.id})" 
              class="w-full px-4 py-2 rounded-lg border border-border hover:bg-muted/50 text-left transition">
        <div class="font-semibold">${playlist.title}</div>
        <div class="text-xs text-muted-foreground">${playlist.song_count || 0} songs</div>
      </button>
    `).join('');
  }

  function openAddToPlaylistModal(songId, spotifyId, trackName, source) {
    currentSongId = songId;
    currentSpotifyId = spotifyId;
    currentTrackName = trackName;
    currentSource = source;
    document.getElementById('modalTrackName').textContent = trackName;
    document.getElementById('addToPlaylistModal').classList.remove('hidden');
    document.getElementById('newPlaylistName').value = '';
    document.getElementById('newPlaylistDescription').value = '';
    fetchUserPlaylists();
  }

  function closeAddToPlaylistModal() {
    document.getElementById('addToPlaylistModal').classList.add('hidden');
    currentSongId = null;
    currentSpotifyId = null;
    currentTrackName = null;
    currentSource = null;
  }

  async function createAndAddToPlaylist() {
    const name = document.getElementById('newPlaylistName').value.trim();
    const description = document.getElementById('newPlaylistDescription').value.trim();
    
    if (!name) {
      showNotification('Please enter a playlist name', 'error');
      return;
    }
    
    try {
      // Create playlist locally
      const formData = new FormData();
      formData.append('title', name);
      formData.append('description', description);
      
      const createResponse = await fetch('/music/playlists/create/', {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
      });
      
      if (createResponse.ok) {
        // Playlist created, now add the song
        // We need to get the playlist ID from the redirect or response
        // For now, let's refresh playlists and add to the newest one
        await fetchUserPlaylists();
        if (userPlaylists.length > 0) {
          const newestPlaylist = userPlaylists[0];
          await addToExistingPlaylist(newestPlaylist.id);
        }
      } else {
        showNotification('Failed to create playlist', 'error');
      }
    } catch (error) {
      console.error('Error:', error);
      showNotification('Failed to create playlist', 'error');
    }
  }

  async function addToExistingPlaylist(playlistId) {
    try {
      const formData = new FormData();
      formData.append('playlist_id', playlistId);
      formData.append('source', currentSource);
      
      if (currentSource === 'local' && currentSongId) {
        formData.append('song_id', currentSongId);
      } else if (currentSource === 'spotify' && currentSpotifyId) {
        formData.append('spotify_id', currentSpotifyId);
      } else {
        showNotification('Invalid song data', 'error');
        return;
      }
      
      const response = await fetch('/music/api/playlists/add-song/', {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
      });
      
      const data = await response.json();
      
      if (response.ok && data.status === 'success') {
        showNotification(`"${currentTrackName}" added to playlist!`, 'success');
        closeAddToPlaylistModal();
      } else {
        showNotification(data.message || 'Failed to add song', data.status === 'info' ? 'error' : 'error');
      }
    } catch (error) {
      console.error('Error:', error);
      showNotification('Failed to add track', 'error');
    }
  }

  // Close modal when clicking outside
  document.getElementById('addToPlaylistModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
      closeAddToPlaylistModal();
    }
  });

  // Load artist's top tracks
  async function loadArtistTracks(artistId, artistName) {
    try {
      showNotification(`Loading ${artistName}'s tracks...`, 'success');

      const response = await fetch(`/music/api/artists/${artistId}/tracks/`, {
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': '{{ csrf_token }}'
        }
      });

      if (!response.ok) {
        throw new Error(`Failed to load artist tracks: ${response.statusText}`);
      }

      const data = await response.json();

      if (data.status === 'success') {
        displayArtistTracks(data.data);
        showNotification(`Found ${data.data.tracks.length} tracks from ${artistName}`, 'success');
      } else {
        showNotification(data.message || 'Failed to load artist tracks', 'error');
      }
    } catch (error) {
      console.error('Error loading artist tracks:', error);
      showNotification('Failed to load artist tracks. Please try again.', 'error');
    }
  }

  // Load album's tracks from Spotify
  async function loadAlbumTracks(albumId, albumName) {
    try {
      showNotification(`Loading ${albumName}'s tracks...`, 'success');

      const response = await fetch(`/music/api/spotify/album/${albumId}/tracks/`, {
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': '{{ csrf_token }}'
        }
      });

      if (!response.ok) {
        throw new Error(`Failed to load album tracks: ${response.statusText}`);
      }

      const data = await response.json();

      if (data.status === 'success' && data.data) {
        displayAlbumTracks(data.data.album, data.data.tracks);
        showNotification(`Found ${data.data.tracks.length} tracks from ${albumName}`, 'success');
      } else {
        throw new Error(data.message || 'Failed to load album tracks');
      }
    } catch (error) {
      console.error('Error loading album tracks:', error);
      showNotification('Failed to load album tracks. Please try again.', 'error');
    }
  }

  // Display artist tracks in the results section
  function displayArtistTracks(data) {
    const artist = data.artist;
    const tracks = data.tracks;

    // Create artist header section
    let html = `
      <div class="mb-8">
        <div class="flex items-center gap-4 mb-6">
          <div class="w-24 h-24 rounded-full overflow-hidden flex-shrink-0">
            ${artist.image ? `<img src="${artist.image}" alt="${artist.name}" class="w-full h-full object-cover">` :
              `<div class="w-full h-full bg-gradient-to-br from-primary/20 to-accent/20 flex items-center justify-center">
                <span class="iconify h-12 w-12 text-primary" data-icon="mdi:account"></span>
              </div>`}
          </div>
          <div>
            <h2 class="text-3xl font-bold">${artist.name}</h2>
            <p class="text-muted-foreground">${artist.followers.toLocaleString()} followers</p>
          </div>
        </div>

        <h3 class="text-2xl font-bold mb-4">Top Tracks</h3>
        <div class="glass rounded-xl border border-border overflow-hidden">
    `;

    // Add each track
    tracks.forEach((track, index) => {
      html += `
        <div class="p-4 border-b border-border last:border-b-0 hover:bg-muted/50 transition-colors flex items-center justify-between group">
          <div class="flex items-center gap-3 flex-1 min-w-0">
            ${track.cover_url ?
              `<img src="${track.cover_url}" alt="${track.name}" class="h-12 w-12 rounded-lg object-cover flex-shrink-0">` :
              `<div class="h-12 w-12 rounded-lg bg-gradient-to-br from-primary/20 to-accent/20 flex items-center justify-center flex-shrink-0">
                <span class="iconify h-6 w-6 text-primary" data-icon="mdi:music-note"></span>
              </div>`}
            <div class="flex-1 min-w-0">
              <div class="font-semibold line-clamp-1 group-hover:text-primary transition-colors">${track.name}</div>
              <div class="text-sm text-muted-foreground line-clamp-1">${track.artist} • ${track.album}</div>
            </div>
          </div>
          <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
            <button onclick="playTrack('${track.uri}')"
                    class="px-4 py-2 rounded-lg bg-gradient-to-r from-primary to-accent text-black font-medium text-sm hover-glow flex-shrink-0">
              <span class="iconify h-4 w-4 mr-1 inline" data-icon="mdi:play"></span>
              Play
            </button>
            <button onclick="addToQueue('${track.uri}', '${track.name.replace(/'/g, "\\'")}' )"
                    class="px-4 py-2 rounded-lg border border-primary text-primary font-medium text-sm hover:bg-primary/10 flex-shrink-0">
              <span class="iconify h-4 w-4 mr-1 inline" data-icon="mdi:playlist-plus"></span>
              Queue
            </button>
            <button onclick="openAddToPlaylistModal(null, '${track.id}', '${track.name.replace(/'/g, "\\'")}', 'spotify')"
                    class="px-4 py-2 rounded-lg border border-accent text-accent font-medium text-sm hover:bg-accent/10 flex-shrink-0">
              <span class="iconify h-4 w-4 mr-1 inline" data-icon="mdi:playlist-music"></span>
              Playlist
            </button>
          </div>
        </div>
      `;
    });

    html += `
        </div>
      </div>
    `;

    // Insert at the beginning of results
    const resultsContainer = document.querySelector('.space-y-8');
    if (resultsContainer) {
      resultsContainer.insertAdjacentHTML('afterbegin', html);
      // Scroll to the artist section
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  }

  // Display album tracks in the results section
  function displayAlbumTracks(album, tracks) {
    // Create album header section
    let html = `
      <div class="mb-8">
        <div class="flex items-center gap-4 mb-6">
          <div class="w-32 h-32 rounded-lg overflow-hidden flex-shrink-0">
            ${album.images && album.images.length > 0 ?
              `<img src="${album.images[0].url}" alt="${album.name}" class="w-full h-full object-cover">` :
              `<div class="w-full h-full bg-gradient-to-br from-primary/20 to-accent/20 flex items-center justify-center">
                <span class="iconify h-16 w-16 text-primary" data-icon="mdi:disc"></span>
              </div>`}
          </div>
          <div>
            <h2 class="text-3xl font-bold">${album.name}</h2>
            <p class="text-muted-foreground">${album.artists.map(a => a.name).join(', ')}</p>
            <p class="text-sm text-muted-foreground mt-2">Released: ${album.release_date || 'Unknown'}</p>
            <p class="text-sm text-muted-foreground">${tracks.length} tracks</p>
          </div>
        </div>

        <h3 class="text-2xl font-bold mb-4">Tracks</h3>
        <div class="glass rounded-xl border border-border overflow-hidden">
    `;

    // Add each track
    tracks.forEach((track, index) => {
      html += `
        <div class="p-4 border-b border-border last:border-b-0 hover:bg-muted/50 transition-colors flex items-center justify-between group">
          <div class="flex items-center gap-3 flex-1 min-w-0">
            <div class="text-muted-foreground font-semibold text-sm min-w-fit">${index + 1}</div>
            ${track.album && track.album.images && track.album.images.length > 0 ?
              `<img src="${track.album.images[0].url}" alt="${track.name}" class="h-10 w-10 rounded-lg object-cover flex-shrink-0">` :
              `<div class="h-10 w-10 rounded-lg bg-gradient-to-br from-primary/20 to-accent/20 flex items-center justify-center flex-shrink-0">
                <span class="iconify h-5 w-5 text-primary" data-icon="mdi:music-note"></span>
              </div>`}
            <div class="flex-1 min-w-0">
              <div class="font-semibold line-clamp-1 group-hover:text-primary transition-colors">${track.name}</div>
              <div class="text-sm text-muted-foreground line-clamp-1">${track.artist || 'Unknown Artist'} • ${Math.floor(track.duration_ms / 60000)}:${(Math.floor((track.duration_ms % 60000) / 1000)).toString().padStart(2, '0')}</div>
            </div>
          </div>
          <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
            <button onclick="playTrack('${track.uri}')"
                    class="px-4 py-2 rounded-lg bg-gradient-to-r from-primary to-accent text-black font-medium text-sm hover-glow flex-shrink-0">
              <span class="iconify h-4 w-4 mr-1 inline" data-icon="mdi:play"></span>
              Play
            </button>
            <button onclick="addToQueue('${track.uri}', '${track.name.replace(/'/g, "\\'")}' )"
                    class="px-4 py-2 rounded-lg border border-primary text-primary font-medium text-sm hover:bg-primary/10 flex-shrink-0">
              <span class="iconify h-4 w-4 mr-1 inline" data-icon="mdi:playlist-plus"></span>
              Queue
            </button>
          </div>
        </div>
      `;
    });

    html += `
        </div>
      </div>
    `;

    // Insert at the beginning of results
    const resultsContainer = document.querySelector('.space-y-8');
    if (resultsContainer) {
      resultsContainer.insertAdjacentHTML('afterbegin', html);
      // Scroll to the album section
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  }
</script>
{% endblock extra_js %}
